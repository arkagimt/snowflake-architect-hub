<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snowflake Architect Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react,typescript">
    const { useState, useEffect, useRef, useMemo } = React;


    // ============================================================================
    // MAIN APP - Router Structure
    // ============================================================================
    function App() {
      const [currentView, setCurrentView] = useState < string > ('menu');

      // Tailwind CDN
      useEffect(() => {
        if (!document.getElementById('tailwind-cdn')) {
          const script = document.createElement('script');
          script.src = "https://cdn.tailwindcss.com";
          script.id = "tailwind-cdn";
          document.head.appendChild(script);
        }
      }, []);

      // Keyboard navigation
      useEffect(() => {
        const handleKey = (e: KeyboardEvent) => {
          if (e.key === 'Escape') setCurrentView('menu');
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, []);

      const goBack = () => setCurrentView('menu');

      return (
        <>
          <style>{`
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap');
        * { box-sizing: border-box; }
        html, body, #root { 
          margin: 0; 
          padding: 0; 
          width: 100%; 
          min-height: 100vh;
          background: #020617;
        }
        body { font-family: 'Space Grotesk', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide { animation: slideIn 0.3s ease-out; }
        @keyframes pulse-glow { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
        .pulse-glow { animation: pulse-glow 2s infinite; }
      `}</style>

          {currentView === 'menu' && <MainMenu onNavigate={setCurrentView} />}
          {currentView === 'cte' && <CTESimulator onBack={goBack} />}
          {currentView === 'modeling' && <ModelingSimulator onBack={goBack} />}
          {currentView === 'indexing' && <IndexingSimulator onBack={goBack} />}
          {currentView === 'pruning' && <PruningSimulator onBack={goBack} />}
          {currentView === 'joins' && <JoinsSimulator onBack={goBack} />}
          {currentView === 'window' && <WindowSimulator onBack={goBack} />}
          {currentView === 'case' && <CaseSimulator onBack={goBack} />}
          {currentView === 'recon' && <ReconSimulator onBack={goBack} />}
          {currentView === 'cost' && <CostSimulator onBack={goBack} />}
        </>
      );
    }

    // ============================================================================
    // SHARED: Header Component
    // ============================================================================
    const Header = ({ title, subtitle, icon, color, onBack }: {
      title: string;
      subtitle: string;
      icon: string;
      color: string;
      onBack: () => void;
    }) => {
      const colorMap: Record<string, string> = {
        orange: 'bg-orange-500/20',
        purple: 'bg-purple-500/20',
        green: 'bg-green-500/20',
        blue: 'bg-blue-500/20',
        cyan: 'bg-cyan-500/20',
        yellow: 'bg-yellow-500/20',
        pink: 'bg-pink-500/20',
        teal: 'bg-teal-500/20',
      };

      return (
        <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
          <div className="flex items-center gap-4">
            <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
              ΓåÉ Back
            </button>
            <div className={`w-10 h-10 rounded-xl ${colorMap[color]} flex items-center justify-center text-xl`}>
              {icon}
            </div>
            <div>
              <h1 className="text-xl font-bold text-white">{title}</h1>
              <p className="text-xs text-slate-500">{subtitle}</p>
            </div>
          </div>
          <div className="text-xs text-slate-600">Press ESC to return</div>
        </header>
      );
    };

    // ============================================================================
    // SHARED: Placeholder Component (for modules not yet built)
    // ============================================================================
    const Placeholder = ({ title, onBack, color, icon }: { title: string; onBack: () => void; color: string; icon: string }) => (
      <div className="flex flex-col h-screen bg-slate-950 text-slate-200">
        <Header title={title} subtitle="Coming Soon" icon={icon} color={color} onBack={onBack} />
        <div className="flex-1 flex items-center justify-center">
          <div className="text-center">
            <div className="text-6xl mb-4">{icon}</div>
            <h2 className="text-2xl font-bold text-white mb-2">{title}</h2>
            <p className="text-slate-500">This module will be implemented next</p>
          </div>
        </div>
      </div>
    );

    // ============================================================================
    // MAIN MENU
    // ============================================================================
    const MainMenu = ({ onNavigate }: { onNavigate: (view: string) => void }) => {
      const modules = [
        { id: 'cte', title: 'Recursive CTEs', desc: 'BOM Hierarchy Explosion', icon: '≡ƒöä', color: 'orange', status: 'ready' },
        { id: 'modeling', title: 'Data Modeling', desc: 'OBT, Bridge Tables, Star', icon: '≡ƒùâ∩╕Å', color: 'purple', status: 'ready' },
        { id: 'indexing', title: 'Indexing Strategy', desc: 'B-Tree & Clustered', icon: '≡ƒôè', color: 'green', status: 'ready' },
        { id: 'pruning', title: 'Pruning & Partitions', desc: 'Zone Maps & Pruning', icon: 'Γ¥ä∩╕Å', color: 'blue', status: 'ready' },
        { id: 'joins', title: 'SQL Joins', desc: 'Trick Questions & NULLs', icon: '≡ƒöù', color: 'cyan', status: 'ready' },
        { id: 'window', title: 'Window Functions', desc: 'RANK, ROW_NUMBER, LEAD', icon: '≡ƒÅÅ', color: 'yellow', status: 'ready' },
        { id: 'case', title: 'NULL Handling', desc: 'NVL, COALESCE, Traps', icon: '≡ƒæ╗', color: 'pink', status: 'ready' },
        { id: 'recon', title: 'Streams & Tasks', desc: 'CDC & Incremental Loading', icon: '≡ƒîè', color: 'teal', status: 'ready' },
        { id: 'cost', title: 'Cloud Cost & FinOps', desc: 'Credits, Storage & Compute', icon: '≡ƒÆ░', color: 'emerald', status: 'ready' },
      ];

      const colorClasses: Record<string, { border: string; shadow: string; text: string; bg: string }> = {
        orange: { border: 'hover:border-orange-500/50', shadow: 'hover:shadow-orange-500/10', text: 'text-orange-400', bg: 'bg-orange-500/20' },
        purple: { border: 'hover:border-purple-500/50', shadow: 'hover:shadow-purple-500/10', text: 'text-purple-400', bg: 'bg-purple-500/20' },
        green: { border: 'hover:border-green-500/50', shadow: 'hover:shadow-green-500/10', text: 'text-green-400', bg: 'bg-green-500/20' },
        blue: { border: 'hover:border-blue-500/50', shadow: 'hover:shadow-blue-500/10', text: 'text-blue-400', bg: 'bg-blue-500/20' },
        cyan: { border: 'hover:border-cyan-500/50', shadow: 'hover:shadow-cyan-500/10', text: 'text-cyan-400', bg: 'bg-cyan-500/20' },
        yellow: { border: 'hover:border-yellow-500/50', shadow: 'hover:shadow-yellow-500/10', text: 'text-yellow-400', bg: 'bg-yellow-500/20' },
        pink: { border: 'hover:border-pink-500/50', shadow: 'hover:shadow-pink-500/10', text: 'text-pink-400', bg: 'bg-pink-500/20' },
        teal: { border: 'hover:border-teal-500/50', shadow: 'hover:shadow-teal-500/10', text: 'text-teal-400', bg: 'bg-teal-500/20' },
        emerald: { border: 'hover:border-emerald-500/50', shadow: 'hover:shadow-emerald-500/10', text: 'text-emerald-400', bg: 'bg-emerald-500/20' },
      };

      return (
        <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-8">
          {/* Header */}
          <div className="text-center mb-12 animate-slide">
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-600 mb-6 shadow-lg shadow-cyan-500/30">
              <span className="text-4xl">Γ¥ä∩╕Å</span>
            </div>
            <h1 className="text-4xl font-bold text-white mb-3">Snowflake Data Architect Hub</h1>
            <p className="text-slate-400 text-lg">Interactive SQL & Data Engineering Simulators</p>
            <div className="mt-4 flex items-center justify-center gap-2 text-sm text-slate-500">
              <span className="px-3 py-1 bg-slate-800 rounded-full">8 Modules</span>
              <span className="px-3 py-1 bg-slate-800 rounded-full">Interview Prep</span>
              <span className="px-3 py-1 bg-slate-800 rounded-full">Step-by-Step</span>
            </div>
          </div>

          {/* Module Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-w-6xl w-full">
            {modules.map((mod, idx) => {
              const colors = colorClasses[mod.color];
              return (
                <button
                  key={mod.id}
                  onClick={() => onNavigate(mod.id)}
                  className={`relative group bg-slate-900 hover:bg-slate-800 border border-slate-800 ${colors.border} rounded-xl p-5 text-left transition-all duration-300 hover:shadow-lg ${colors.shadow} animate-slide`}
                  style={{ animationDelay: `${idx * 50}ms` }}
                >
                  {mod.status === 'ready' && (
                    <span className="absolute top-3 right-3 text-[10px] font-bold px-2 py-0.5 rounded bg-green-500/20 text-green-400">
                      READY
                    </span>
                  )}
                  <div className={`w-12 h-12 rounded-xl ${colors.bg} flex items-center justify-center text-2xl mb-4`}>
                    {mod.icon}
                  </div>
                  <h3 className="text-white font-bold mb-1">{mod.title}</h3>
                  <p className="text-slate-500 text-sm">{mod.desc}</p>
                </button>
              );
            })}
          </div>

          {/* Footer */}
          <div className="mt-12 text-center text-slate-600 text-sm">
            <p>Press <kbd className="px-2 py-1 bg-slate-800 rounded text-slate-400 mono text-xs">ESC</kbd> to return to menu from any simulator</p>
          </div>
        </div>
      );
    };

    // ============================================================================
    // 1. RECURSIVE CTE SIMULATOR (Enhanced Version)
    // ============================================================================

    // --- Types ---
    interface BomItem {
      parent: string;
      child: string;
      qty: number;
    }

    interface ResultRow extends BomItem {
      level: number;
    }

    // --- Data ---
    const sourceData: BomItem[] = [
      { parent: 'ENGINE-VPI-001', child: 'BLOCK-ASM', qty: 1 },
      { parent: 'ENGINE-VPI-001', child: 'PISTON-SET', qty: 6 },
      { parent: 'ENGINE-VPI-001', child: 'CRANKSHAFT', qty: 1 },
      { parent: 'BLOCK-ASM', child: 'CYLINDER-LINER', qty: 6 },
      { parent: 'BLOCK-ASM', child: 'CAM-BEARING', qty: 12 },
      { parent: 'PISTON-SET', child: 'PISTON-RING', qty: 3 },
      { parent: 'PISTON-SET', child: 'WRIST-PIN', qty: 1 },
      { parent: 'PISTON-RING', child: 'STEEL-COAT', qty: 1 },
      { parent: 'TURBO-ASSY', child: 'IMPELLER', qty: 1 }
    ];

    const sqlLines = [
      { id: 1, text: "WITH RECURSIVE BOM_Hierarchy AS (" },
      { id: 2, text: "  -- ANCHOR: Find root components", type: 'comment' },
      { id: 3, text: "  SELECT Parent_ID, Child_ID, Qty," },
      { id: 4, text: "         1 AS Level" },
      { id: 5, text: "  FROM BOM_COMPONENTS" },
      { id: 6, text: "  WHERE Parent_ID = 'ENGINE-VPI-001'" },
      { id: 7, text: "" },
      { id: 8, text: "  UNION ALL", type: 'keyword' },
      { id: 9, text: "" },
      { id: 10, text: "  -- RECURSIVE: Find children", type: 'comment' },
      { id: 11, text: "  SELECT c.Parent_ID, c.Child_ID, c.Qty," },
      { id: 12, text: "         p.Level + 1" },
      { id: 13, text: "  FROM BOM_COMPONENTS c" },
      { id: 14, text: "  JOIN BOM_Hierarchy p" },
      { id: 15, text: "    ON c.Parent_ID = p.Child_ID" },
      { id: 16, text: ")" },
      { id: 17, text: "SELECT * FROM BOM_Hierarchy;" }
    ];

    const CTESimulator = ({ onBack }: { onBack: () => void }) => {
      // State
      const [currentStep, setCurrentStep] = useState(0);
      const [results, setResults] = useState < ResultRow[] > ([]);
      const [inputBuffer, setInputBuffer] = useState < ResultRow[] > ([]);
      const [outputBuffer, setOutputBuffer] = useState < ResultRow[] > ([]);
      const [currentLevel, setCurrentLevel] = useState(0);
      const [highlightedLines, setHighlightedLines] = useState < number[] > ([]);
      const [highlightType, setHighlightType] = useState < 'anchor' | 'union' | 'recursive' | 'terminate' > ('anchor');
      const [isProcessing, setIsProcessing] = useState(false);
      const [activeConcept, setActiveConcept] = useState < string > ('');
      const [matchedItems, setMatchedItems] = useState < string[] > ([]);
      const [iteration, setIteration] = useState(0);

      // UI State
      const [stepLabel, setStepLabel] = useState("Ready");
      const [stepTitle, setStepTitle] = useState("Welcome to the Simulator");
      const [stepDesc, setStepDesc] = useState("This interactive tool visualizes how a Recursive CTE explodes a BOM hierarchy level by level. Click Next Step to begin.");
      const [isFinished, setIsFinished] = useState(false);

      const resultEndRef = useRef < HTMLDivElement > (null);

      // Auto-scroll
      useEffect(() => {
        resultEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [results]);

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
          if (e.key === 'ArrowRight' && !isFinished) handleNextStep();
          if (e.key === 'r' || e.key === 'R') resetSimulation();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [currentStep, isFinished, inputBuffer, outputBuffer]);

      // Reset
      const resetSimulation = () => {
        setCurrentStep(0);
        setResults([]);
        setInputBuffer([]);
        setOutputBuffer([]);
        setCurrentLevel(0);
        setHighlightedLines([]);
        setHighlightType('anchor');
        setIsProcessing(false);
        setActiveConcept('');
        setMatchedItems([]);
        setIteration(0);
        setIsFinished(false);
        setStepLabel("Ready");
        setStepTitle("Welcome to the Simulator");
        setStepDesc("This interactive tool visualizes how a Recursive CTE explodes a BOM hierarchy level by level. Click Next Step to begin.");
      };

      // Next Step
      const handleNextStep = () => {
        const nextStep = currentStep + 1;
        setCurrentStep(nextStep);

        switch (nextStep) {
          case 1: // Anchor
            setStepLabel("Step 1 of 7");
            setStepTitle("Anchor Query Executes");
            setStepDesc("The Anchor Member runs first ΓÇö and only once. It finds all components where parent is 'ENGINE-VPI-001' and assigns them Level 1.");
            setHighlightedLines([2, 3, 4, 5, 6]);
            setHighlightType('anchor');
            setActiveConcept('anchor');

            const anchors = sourceData.filter(d => d.parent === 'ENGINE-VPI-001');
            const anchorRows = anchors.map(a => ({ ...a, level: 1 }));

            setResults(anchorRows);
            setOutputBuffer(anchorRows);
            setCurrentLevel(1);
            setMatchedItems(anchors.map(a => `${a.parent}-${a.child}`));
            break;

          case 2: // UNION ALL
            setStepLabel("Step 2 of 7");
            setStepTitle("UNION ALL Connects");
            setStepDesc("The UNION ALL stacks results together. Output moves to input buffer ΓÇö these items become 'parents' for the next search.");
            setHighlightedLines([8]);
            setHighlightType('union');
            setActiveConcept('union');

            setInputBuffer(outputBuffer);
            setOutputBuffer([]);
            setIsProcessing(true);
            setIteration(1);
            setMatchedItems([]);
            break;

          case 3: // Recursion 1
            setStepLabel("Step 3 of 7");
            setStepTitle("Recursive Query ΓÇö Iteration 1");
            setStepDesc("The Recursive Member JOINs input buffer against source table. Found children for BLOCK-ASM and PISTON-SET!");
            setHighlightedLines([10, 11, 12, 13, 14, 15]);
            setHighlightType('recursive');
            setActiveConcept('recursive');

            const lvl2Found: ResultRow[] = [];
            const matched: string[] = [];
            inputBuffer.forEach(parent => {
              const children = sourceData.filter(d => d.parent === parent.child);
              children.forEach(c => {
                lvl2Found.push({ ...c, level: 2 });
                matched.push(`${c.parent}-${c.child}`);
              });
            });

            setResults(prev => [...prev, ...lvl2Found]);
            setOutputBuffer(lvl2Found);
            setCurrentLevel(2);
            setMatchedItems(matched);
            break;

          case 4: // Prep Loop 2
            setStepLabel("Step 4 of 7");
            setStepTitle("Loop Repeats ΓÇö Setup");
            setStepDesc("Level 2 results move to input buffer. The database automatically loops again.");
            setHighlightedLines([14, 15]);
            setHighlightType('recursive');
            setActiveConcept('recursive');

            setInputBuffer(outputBuffer);
            setOutputBuffer([]);
            setIteration(2);
            setMatchedItems([]);
            break;

          case 5: // Recursion 2
            setStepLabel("Step 5 of 7");
            setStepTitle("Recursive Query ΓÇö Iteration 2");
            setStepDesc("Checking Level 2 items for children... Found PISTON-RING has a child: STEEL-COAT!");
            setHighlightedLines([10, 11, 12, 13, 14, 15]);
            setHighlightType('recursive');
            setActiveConcept('recursive');

            const lvl3Found: ResultRow[] = [];
            const matched3: string[] = [];
            inputBuffer.forEach(parent => {
              const children = sourceData.filter(d => d.parent === parent.child);
              children.forEach(c => {
                lvl3Found.push({ ...c, level: 3 });
                matched3.push(`${c.parent}-${c.child}`);
              });
            });

            setResults(prev => [...prev, ...lvl3Found]);
            setOutputBuffer(lvl3Found);
            setCurrentLevel(3);
            setMatchedItems(matched3);
            break;

          case 6: // Termination check
            setStepLabel("Step 6 of 7");
            setStepTitle("Termination Check");
            setStepDesc("Level 3 moves to input. Searching for children of STEEL-COAT... Result: 0 rows. The CTE terminates!");
            setHighlightedLines([16]);
            setHighlightType('terminate');
            setActiveConcept('terminate');

            setInputBuffer(outputBuffer);
            setOutputBuffer([]);
            setIsProcessing(false);
            setIteration(3);
            setMatchedItems([]);
            break;

          case 7: // Complete
            setStepLabel("Complete");
            setStepTitle("Hierarchy Exploded! Γ£ô");
            setStepDesc(`The recursive CTE has finished. You now have a flat table representing the entire BOM tree. Total: ${results.length} components across 3 levels.`);
            setHighlightedLines([17]);
            setHighlightType('terminate');
            setActiveConcept('terminate');
            setIsFinished(true);
            break;
        }
      };

      // Color helpers
      const getConceptColor = (concept: string) => {
        switch (concept) {
          case 'anchor': return { bg: 'bg-cyan-500/20', border: 'border-cyan-500', text: 'text-cyan-400' };
          case 'union': return { bg: 'bg-purple-500/20', border: 'border-purple-500', text: 'text-purple-400' };
          case 'recursive': return { bg: 'bg-orange-500/20', border: 'border-orange-500', text: 'text-orange-400' };
          case 'terminate': return { bg: 'bg-green-500/20', border: 'border-green-500', text: 'text-green-400' };
          default: return { bg: 'bg-slate-700', border: 'border-slate-600', text: 'text-slate-400' };
        }
      };

      const getLevelColor = (level: number) => {
        switch (level) {
          case 1: return 'text-cyan-400';
          case 2: return 'text-purple-400';
          case 3: return 'text-orange-400';
          default: return 'text-slate-400';
        }
      };

      return (
        <div className="flex flex-col h-screen bg-slate-950 text-slate-200 overflow-hidden">
          {/* Additional Styles for CTE */}
          <style>{`
        .conveyor-belt {
          background: repeating-linear-gradient(90deg, #1e293b 0px, #1e293b 15px, #0f172a 15px, #0f172a 30px);
          background-size: 30px 100%;
        }
        .conveyor-active { animation: moveBelt 1s linear infinite; }
        @keyframes moveBelt { from { background-position: 0 0; } to { background-position: 30px 0; } }
        @keyframes pulse-glow {
          0%, 100% { box-shadow: 0 0 20px rgba(251, 146, 60, 0.4); }
          50% { box-shadow: 0 0 30px rgba(251, 146, 60, 0.6); }
        }
        .pulse-glow { animation: pulse-glow 1s infinite; }
      `}</style>

          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-2xl">
                ≡ƒöä
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                  Recursive CTE Simulator
                </h1>
                <p className="text-xs text-slate-500">Interactive BOM Hierarchy Explosion</p>
              </div>
            </div>
            <div className="flex gap-3 items-center">
              <span className="text-xs text-slate-600 hidden sm:block">Press ΓåÆ for next, R to reset</span>
              <button onClick={resetSimulation} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-sm font-medium transition">
                Reset
              </button>
              <button
                onClick={handleNextStep}
                disabled={isFinished}
                className={`px-5 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2
              ${isFinished ? 'bg-green-600 text-white cursor-default' : 'bg-gradient-to-r from-cyan-500 to-blue-500 text-slate-900 hover:opacity-90 shadow-lg shadow-cyan-500/25'}`}
              >
                {isFinished ? 'Γ£ô Complete' : 'Next Step ΓåÆ'}
              </button>
            </div>
          </header>

          {/* Concept Cards */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-4">
            <div className="flex gap-3 justify-center flex-wrap">
              {[
                { id: 'anchor', num: 1, title: 'Anchor Query', desc: 'Find root nodes' },
                { id: 'union', num: 2, title: 'UNION ALL', desc: 'Stack results' },
                { id: 'recursive', num: 3, title: 'Recursive Query', desc: 'Find children' },
                { id: 'terminate', num: 4, title: 'Termination', desc: 'Stop when empty' }
              ].map(card => {
                const colors = getConceptColor(card.id);
                const isActive = activeConcept === card.id;
                return (
                  <div
                    key={card.id}
                    className={`px-4 py-3 rounded-xl border-2 transition-all duration-300 min-w-[140px]
                  ${isActive ? `${colors.bg} ${colors.border} shadow-lg` : 'bg-slate-800/50 border-slate-700/50 opacity-60'}`}
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <span className={`w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold ${colors.bg} ${colors.text}`}>
                        {card.num}
                      </span>
                      <span className={`text-sm font-semibold ${isActive ? colors.text : 'text-slate-400'}`}>
                        {card.title}
                      </span>
                    </div>
                    <p className="text-xs text-slate-500">{card.desc}</p>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex flex-1 overflow-hidden">

            {/* Left: SQL */}
            <div className="w-80 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
              <div className="px-4 py-3 bg-slate-800/50 border-b border-slate-800 text-xs font-semibold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                <span>{'</>'}</span> SQL Query
              </div>
              <div className="flex-1 p-4 overflow-y-auto mono text-sm leading-relaxed">
                {sqlLines.map(line => {
                  const isHighlighted = highlightedLines.includes(line.id);
                  const colors = getConceptColor(highlightType);
                  return (
                    <div
                      key={line.id}
                      className={`py-1 px-3 rounded-md transition-all duration-300 border-l-2
                    ${isHighlighted ? `${colors.bg} ${colors.border}` : 'border-transparent hover:bg-slate-800/50'}`}
                    >
                      <span className={
                        line.type === 'comment' ? 'text-slate-600 italic' :
                          line.type === 'keyword' ? 'text-purple-400 font-semibold' : 'text-slate-400'
                      }>
                        {line.text || '\u00A0'}
                      </span>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Center: Visualization */}
            <div className="flex-1 flex flex-col min-w-0">

              {/* Source Data */}
              <div className="p-4 border-b border-slate-800 bg-slate-900/30">
                <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                  <span>Γ¼í</span> BOM_COMPONENTS (Source)
                </div>
                <div className="grid grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 max-h-32 overflow-y-auto">
                  {sourceData.map((item, idx) => {
                    const isMatched = matchedItems.includes(`${item.parent}-${item.child}`);
                    return (
                      <div
                        key={idx}
                        className={`p-2 rounded-lg text-xs transition-all duration-300
                      ${isMatched ? 'bg-orange-500/20 border border-orange-500 shadow-lg shadow-orange-500/20' : 'bg-slate-800/50 border border-slate-700/50'}`}
                      >
                        <div className="text-slate-500 truncate text-[10px]">{item.parent}</div>
                        <div className="text-center text-slate-600 text-[10px]">Γåô</div>
                        <div className={`font-semibold mono truncate ${isMatched ? 'text-orange-400' : 'text-slate-300'}`}>
                          {item.child}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Process Zone */}
              <div className="flex-1 flex items-center justify-center p-8 relative">
                <div className="flex items-center gap-8 w-full max-w-3xl">

                  {/* Input Buffer */}
                  <div className="flex-1">
                    <div className="text-xs text-slate-500 mb-2 flex items-center gap-1">
                      <span>ΓåÉ</span> Input Buffer
                    </div>
                    <div className={`min-h-[140px] rounded-xl border-2 border-dashed p-3 transition-all duration-300
                  ${inputBuffer.length > 0 ? 'border-cyan-500/50 bg-cyan-500/5' : 'border-slate-700 bg-slate-800/30'}`}>
                      {inputBuffer.length === 0 ? (
                        <div className="h-full flex items-center justify-center text-slate-600 text-sm">Waiting...</div>
                      ) : (
                        <div className="space-y-2">
                          {inputBuffer.map((item, idx) => (
                            <div key={idx} className="bg-slate-800 rounded-lg p-2 border-l-2 border-cyan-500 flex justify-between items-center animate-slide">
                              <span className="mono text-sm font-semibold text-slate-200">{item.child}</span>
                              <span className="text-xs bg-slate-900 px-2 py-0.5 rounded text-slate-400">Lvl {item.level}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Process Icon */}
                  <div className="flex flex-col items-center gap-3">
                    <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl transition-all duration-500
                  ${isFinished ? 'bg-green-500 text-white shadow-lg shadow-green-500/40' : isProcessing ? 'bg-orange-500 text-white pulse-glow' : 'bg-slate-800 text-slate-500 border-2 border-slate-700'}`}>
                      {isFinished ? 'Γ£ô' : isProcessing ? 'ΓÜí' : '≡ƒöì'}
                    </div>
                    <span className={`text-xs font-semibold transition-opacity ${isProcessing ? 'text-orange-400 opacity-100' : 'opacity-0'}`}>
                      JOINING...
                    </span>
                  </div>

                  {/* Output Buffer */}
                  <div className="flex-1">
                    <div className="text-xs text-slate-500 mb-2 flex items-center gap-1">
                      Output <span>ΓåÆ</span>
                    </div>
                    <div className={`min-h-[140px] rounded-xl border-2 border-dashed p-3 transition-all duration-300
                  ${outputBuffer.length > 0 ? 'border-green-500/50 bg-green-500/5' : 'border-slate-700 bg-slate-800/30'}`}>
                      {outputBuffer.length === 0 ? (
                        <div className="h-full flex items-center justify-center text-slate-600 text-sm">
                          {currentStep === 6 ? 'Γêà No rows found' : 'No results yet'}
                        </div>
                      ) : (
                        <div className="space-y-2">
                          {outputBuffer.map((item, idx) => (
                            <div key={idx} className="bg-slate-800 rounded-lg p-2 border-l-2 border-green-500 flex justify-between items-center animate-slide">
                              <span className="mono text-sm font-semibold text-slate-200">{item.child}</span>
                              <span className="text-xs bg-slate-900 px-2 py-0.5 rounded text-slate-400">Lvl {item.level}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Conveyor Belt */}
                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2">
                  <div className={`w-64 h-2 conveyor-belt rounded-full ${isProcessing ? 'conveyor-active' : ''}`}></div>
                  <span className="text-xs text-slate-600 uppercase tracking-wider">Recursive Loop</span>
                </div>
              </div>

              {/* Result Table */}
              <div className="h-48 border-t border-slate-800 bg-slate-900/50 p-4 overflow-hidden flex flex-col">
                <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                  <span>Γÿ░</span> Final Result Set
                </div>
                <div className="flex-1 overflow-y-auto">
                  <table className="w-full text-sm">
                    <thead className="text-xs uppercase text-slate-500 bg-slate-800/50 sticky top-0">
                      <tr>
                        <th className="text-left p-2 rounded-l-lg">Level</th>
                        <th className="text-left p-2">Parent</th>
                        <th className="text-left p-2">Child</th>
                        <th className="text-left p-2 rounded-r-lg">Qty</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-800/50">
                      {results.map((row, idx) => (
                        <tr key={idx} className="animate-slide">
                          <td className={`p-2 mono font-semibold ${getLevelColor(row.level)}`}>{row.level}</td>
                          <td className="p-2 text-slate-400">{row.parent}</td>
                          <td className="p-2 text-orange-300 font-semibold mono">{row.child}</td>
                          <td className="p-2 text-slate-500">{row.qty}</td>
                        </tr>
                      ))}
                      <tr ref={resultEndRef}></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            {/* Right: Explanation */}
            <div className="w-72 bg-slate-900 border-l border-slate-800 flex flex-col shrink-0">
              <div className="px-4 py-3 bg-slate-800/50 border-b border-slate-800 text-xs font-semibold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                <span>Γä╣</span> Explanation
              </div>
              <div className="flex-1 p-5 overflow-y-auto">
                <div className={`text-xs font-semibold uppercase tracking-wider mb-2 ${getConceptColor(activeConcept || 'anchor').text}`}>
                  {stepLabel}
                </div>
                <h3 className="text-lg font-bold text-slate-100 mb-4 leading-snug">{stepTitle}</h3>
                <p className="text-sm text-slate-400 leading-relaxed">{stepDesc}</p>

                {currentLevel > 0 && (
                  <div className="mt-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                    <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Variables</div>
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span className="text-slate-400">Current Level</span>
                        <span className="mono font-semibold text-green-400">{currentLevel}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-slate-400">Rows Added</span>
                        <span className="mono font-semibold text-green-400">{outputBuffer.length || (currentStep === 6 ? 0 : '-')}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-slate-400">Total Results</span>
                        <span className="mono font-semibold text-green-400">{results.length}</span>
                      </div>
                    </div>
                  </div>
                )}

                {iteration > 0 && !isFinished && (
                  <div className="mt-4 flex items-center gap-2 bg-slate-800/30 rounded-lg px-3 py-2">
                    <span className="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                    <span className="text-xs text-slate-400">Iteration:</span>
                    <span className="mono font-semibold text-orange-400">{iteration}</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================================
    // 2. DATA MODELING SIMULATOR (Enhanced - OBT, Bridge Tables, Star Schema)
    // ============================================================================

    const ModelingSimulator = ({ onBack }: { onBack: () => void }) => {
      const [activeTab, setActiveTab] = useState < 'obt' | 'bridge' | 'dbt' | 'snowflake' > ('obt');

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-2xl">
                ≡ƒùâ∩╕Å
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                  Data Modeling Simulator
                </h1>
                <p className="text-xs text-slate-500">OBT ΓÇó Bridge Tables ΓÇó DBT Layers ΓÇó Snowflake Patterns</p>
              </div>
            </div>
          </header>

          {/* Tab Navigation */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-3">
            <div className="flex gap-2 justify-center">
              {[
                { id: 'obt', label: 'OBT vs Star Schema', icon: 'Γ¡É' },
                { id: 'bridge', label: 'Bridge Tables (M:M)', icon: '≡ƒîë' },
                { id: 'dbt', label: 'DBT Layers', icon: '≡ƒö╢' },
                { id: 'snowflake', label: 'Snowflake Patterns', icon: 'Γ¥ä∩╕Å' },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2 ${activeTab === tab.id
                      ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/30'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                >
                  <span>{tab.icon}</span>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 overflow-hidden">
            {activeTab === 'obt' && <OBTVisualizer />}
            {activeTab === 'bridge' && <BridgeTableVisualizer />}
            {activeTab === 'dbt' && <DBTLayersViz />}
            {activeTab === 'snowflake' && <SnowflakePatternsViz />}
          </div>
        </div>
      );
    };

    // ============================================================================
    // OBT (One Big Table) vs Star Schema Visualizer
    // ============================================================================

    const OBTVisualizer = () => {
      const [isOBT, setIsOBT] = useState(false);
      const [isAnimating, setIsAnimating] = useState(false);
      const [showMetrics, setShowMetrics] = useState(false);

      const factColumns = [
        { name: 'order_id', type: 'PK' },
        { name: 'date_key', type: 'FK' },
        { name: 'product_key', type: 'FK' },
        { name: 'customer_key', type: 'FK' },
        { name: 'quantity', type: 'MEASURE' },
        { name: 'amount', type: 'MEASURE' },
      ];

      const obtColumns = [
        { name: 'order_id', source: 'fact', color: 'purple' },
        { name: 'quantity', source: 'fact', color: 'purple' },
        { name: 'amount', source: 'fact', color: 'purple' },
        { name: 'full_date', source: 'date', color: 'blue' },
        { name: 'month', source: 'date', color: 'blue' },
        { name: 'year', source: 'date', color: 'blue' },
        { name: 'product_name', source: 'product', color: 'green' },
        { name: 'category', source: 'product', color: 'green' },
        { name: 'brand', source: 'product', color: 'green' },
        { name: 'customer_name', source: 'customer', color: 'orange' },
        { name: 'region', source: 'customer', color: 'orange' },
        { name: 'segment', source: 'customer', color: 'orange' },
      ];

      const denormalize = () => {
        if (isAnimating || isOBT) return;
        setIsAnimating(true);
        setTimeout(() => {
          setIsOBT(true);
          setIsAnimating(false);
          setShowMetrics(true);
        }, 1500);
      };

      const reset = () => {
        setIsOBT(false);
        setShowMetrics(false);
      };

      const getColorClass = (color: string) => {
        const colors: Record<string, { bg: string; border: string; text: string }> = {
          blue: { bg: 'bg-blue-500/20', border: 'border-blue-500', text: 'text-blue-400' },
          green: { bg: 'bg-green-500/20', border: 'border-green-500', text: 'text-green-400' },
          orange: { bg: 'bg-orange-500/20', border: 'border-orange-500', text: 'text-orange-400' },
          purple: { bg: 'bg-purple-500/20', border: 'border-purple-500', text: 'text-purple-400' },
        };
        return colors[color] || colors.purple;
      };

      return (
        <div className="h-full p-6 overflow-y-auto">
          <div className="max-w-6xl mx-auto">

            {/* Header */}
            <div className="flex justify-between items-center mb-6">
              <div>
                <h3 className="text-xl font-bold text-white">
                  {isOBT ? '≡ƒôè One Big Table (OBT)' : 'Γ¡É Star Schema'}
                </h3>
                <p className="text-sm text-slate-400">
                  {isOBT
                    ? 'All dimensions denormalized into a single wide table'
                    : 'Normalized design with fact table and dimension tables'}
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={denormalize}
                  disabled={isAnimating || isOBT}
                  className={`px-5 py-2 rounded-lg font-semibold transition flex items-center gap-2 ${isAnimating ? 'bg-yellow-600 text-white animate-pulse' :
                      isOBT ? 'bg-green-600 text-white cursor-default' :
                        'bg-purple-600 hover:bg-purple-500 text-white'
                    }`}
                >
                  {isAnimating ? (
                    <>
                      <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                      Denormalizing...
                    </>
                  ) : isOBT ? (
                    <>Γ£ô OBT Created</>
                  ) : (
                    <>≡ƒöä Denormalize to OBT</>
                  )}
                </button>
                {isOBT && (
                  <button onClick={reset} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    Reset
                  </button>
                )}
              </div>
            </div>

            {/* Main Visualization */}
            <div className="bg-slate-900 rounded-xl border border-slate-700 p-8 mb-6 min-h-[500px] relative overflow-hidden">

              {!isOBT ? (
                /* Star Schema View */
                <div className="relative h-[420px]">

                  {/* DIM_DATE - Top */}
                  <div
                    className={`absolute left-1/2 -translate-x-1/2 transition-all duration-1000 ${isAnimating ? 'opacity-0 scale-0' : 'opacity-100 scale-100'
                      }`}
                    style={{ top: '0px' }}
                  >
                    <div className="bg-blue-500/20 border-2 border-blue-500 rounded-xl p-3 w-44">
                      <div className="text-xs font-bold text-blue-400 uppercase mb-2 flex items-center gap-1">
                        <span>Γùï</span> Dimension
                      </div>
                      <div className="text-sm font-bold text-white mb-2">DIM_DATE</div>
                      <div className="space-y-1">
                        {['date_key', 'full_date', 'month', 'year'].map((col, cidx) => (
                          <div key={cidx} className="text-[10px] mono bg-slate-800/30 px-2 py-0.5 rounded text-slate-400">
                            {col}
                          </div>
                        ))}
                        <div className="text-[10px] text-slate-500">+2 more...</div>
                      </div>
                    </div>
                    {/* Connection line to fact */}
                    <div className="absolute left-1/2 -translate-x-1/2 top-full w-0.5 h-8 bg-blue-500/50" style={{ background: 'linear-gradient(to bottom, #3b82f6, transparent)' }}></div>
                  </div>

                  {/* Center Fact Table */}
                  <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 transition-all duration-500 ${isAnimating ? 'scale-110' : ''}`}>
                    <div className="bg-purple-900/40 border-2 border-purple-500 rounded-xl p-4 w-56 shadow-lg shadow-purple-500/20">
                      <div className="text-xs font-bold text-purple-400 uppercase mb-2 flex items-center gap-2">
                        <span>Γùå</span> Fact Table
                      </div>
                      <div className="text-sm font-bold text-white mb-3">FCT_SALES_ORDER</div>
                      <div className="space-y-1">
                        {factColumns.map((col, idx) => (
                          <div key={idx} className="text-[10px] mono bg-slate-800/50 px-2 py-1 rounded flex justify-between">
                            <span className="text-slate-300">{col.name}</span>
                            <span className={`${col.type === 'PK' ? 'text-yellow-400' : col.type === 'FK' ? 'text-cyan-400' : 'text-green-400'}`}>
                              {col.type}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* DIM_PRODUCT - Left */}
                  <div
                    className={`absolute top-1/2 -translate-y-1/2 transition-all duration-1000 ${isAnimating ? 'opacity-0 scale-0' : 'opacity-100 scale-100'
                      }`}
                    style={{ left: '40px' }}
                  >
                    <div className="bg-green-500/20 border-2 border-green-500 rounded-xl p-3 w-44">
                      <div className="text-xs font-bold text-green-400 uppercase mb-2 flex items-center gap-1">
                        <span>Γùï</span> Dimension
                      </div>
                      <div className="text-sm font-bold text-white mb-2">DIM_PRODUCT</div>
                      <div className="space-y-1">
                        {['product_key', 'product_name', 'category', 'brand'].map((col, cidx) => (
                          <div key={cidx} className="text-[10px] mono bg-slate-800/30 px-2 py-0.5 rounded text-slate-400">
                            {col}
                          </div>
                        ))}
                        <div className="text-[10px] text-slate-500">+1 more...</div>
                      </div>
                    </div>
                    {/* Connection line to fact */}
                    <div className="absolute right-0 top-1/2 -translate-y-1/2 translate-x-full w-12 h-0.5" style={{ background: 'linear-gradient(to right, #22c55e, transparent)' }}></div>
                  </div>

                  {/* DIM_CUSTOMER - Right */}
                  <div
                    className={`absolute top-1/2 -translate-y-1/2 transition-all duration-1000 ${isAnimating ? 'opacity-0 scale-0' : 'opacity-100 scale-100'
                      }`}
                    style={{ right: '40px' }}
                  >
                    <div className="bg-orange-500/20 border-2 border-orange-500 rounded-xl p-3 w-44">
                      <div className="text-xs font-bold text-orange-400 uppercase mb-2 flex items-center gap-1">
                        <span>Γùï</span> Dimension
                      </div>
                      <div className="text-sm font-bold text-white mb-2">DIM_CUSTOMER</div>
                      <div className="space-y-1">
                        {['customer_key', 'customer_name', 'region', 'segment'].map((col, cidx) => (
                          <div key={cidx} className="text-[10px] mono bg-slate-800/30 px-2 py-0.5 rounded text-slate-400">
                            {col}
                          </div>
                        ))}
                        <div className="text-[10px] text-slate-500">+1 more...</div>
                      </div>
                    </div>
                    {/* Connection line to fact */}
                    <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full w-12 h-0.5" style={{ background: 'linear-gradient(to left, #f97316, transparent)' }}></div>
                  </div>
                </div>
              ) : (
                /* OBT View */
                <div className="animate-slide">
                  <div className="bg-gradient-to-r from-purple-900/30 via-blue-900/20 to-orange-900/30 border-2 border-purple-500 rounded-xl p-6 max-w-2xl mx-auto">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <div className="text-xs font-bold text-purple-400 uppercase flex items-center gap-2">
                          <span>Γûú</span> One Big Table
                        </div>
                        <div className="text-lg font-bold text-white">OBT_SALES_DENORMALIZED</div>
                      </div>
                      <div className="text-right">
                        <div className="text-xs text-slate-500">Columns</div>
                        <div className="text-2xl font-bold text-cyan-400">{obtColumns.length}</div>
                      </div>
                    </div>

                    <div className="grid grid-cols-4 gap-2">
                      {obtColumns.map((col, idx) => {
                        const colors = getColorClass(col.color);
                        return (
                          <div
                            key={idx}
                            className={`${colors.bg} border ${colors.border} rounded-lg px-2 py-1.5 text-[10px] mono animate-slide`}
                            style={{ animationDelay: `${idx * 50}ms` }}
                          >
                            <span className={colors.text}>{col.name}</span>
                          </div>
                        );
                      })}
                    </div>

                    <div className="mt-4 flex items-center gap-4 text-xs">
                      <div className="flex items-center gap-1">
                        <span className="w-3 h-3 rounded bg-purple-500"></span>
                        <span className="text-slate-400">Fact</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="w-3 h-3 rounded bg-blue-500"></span>
                        <span className="text-slate-400">Date</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="w-3 h-3 rounded bg-green-500"></span>
                        <span className="text-slate-400">Product</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="w-3 h-3 rounded bg-orange-500"></span>
                        <span className="text-slate-400">Customer</span>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Metrics Comparison */}
            <div className="grid grid-cols-2 gap-6">
              <div className={`bg-slate-900 rounded-xl border p-5 transition-all ${!isOBT ? 'border-purple-500 ring-2 ring-purple-500/20' : 'border-slate-700'}`}>
                <div className="flex items-center gap-3 mb-4">
                  <span className="text-2xl">Γ¡É</span>
                  <h4 className="font-bold text-white">Star Schema</h4>
                  {!isOBT && <span className="text-xs bg-purple-500 text-white px-2 py-0.5 rounded">CURRENT</span>}
                </div>
                <div className="space-y-3 text-sm">
                  <div className="flex justify-between">
                    <span className="text-slate-400">Storage</span>
                    <span className="text-green-400 font-semibold">Γ£ô Low (Normalized)</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Query CPU</span>
                    <span className="text-yellow-400 font-semibold">ΓÜá High (JOINs)</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Flexibility</span>
                    <span className="text-green-400 font-semibold">Γ£ô High</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Maintenance</span>
                    <span className="text-yellow-400 font-semibold">ΓÜá Multiple tables</span>
                  </div>
                </div>
                <div className="mt-4 p-3 bg-slate-800 rounded-lg">
                  <div className="text-xs text-slate-500 mb-1">Best For</div>
                  <div className="text-xs text-slate-300">Traditional DW, Power BI DirectQuery, Complex ad-hoc analysis</div>
                </div>
              </div>

              <div className={`bg-slate-900 rounded-xl border p-5 transition-all ${isOBT ? 'border-cyan-500 ring-2 ring-cyan-500/20' : 'border-slate-700'}`}>
                <div className="flex items-center gap-3 mb-4">
                  <span className="text-2xl">≡ƒôè</span>
                  <h4 className="font-bold text-white">One Big Table (OBT)</h4>
                  {isOBT && <span className="text-xs bg-cyan-500 text-white px-2 py-0.5 rounded">CURRENT</span>}
                </div>
                <div className="space-y-3 text-sm">
                  <div className="flex justify-between">
                    <span className="text-slate-400">Storage</span>
                    <span className="text-yellow-400 font-semibold">ΓÜá High (Redundant)</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Query CPU</span>
                    <span className="text-green-400 font-semibold">Γ£ô Zero (No JOINs)</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Flexibility</span>
                    <span className="text-yellow-400 font-semibold">ΓÜá Limited</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Maintenance</span>
                    <span className="text-green-400 font-semibold">Γ£ô Single table</span>
                  </div>
                </div>
                <div className="mt-4 p-3 bg-slate-800 rounded-lg">
                  <div className="text-xs text-slate-500 mb-1">Best For</div>
                  <div className="text-xs text-slate-300">Snowflake (storage cheap!), ML features, Simple dashboards, Fast aggregations</div>
                </div>
              </div>
            </div>

            {/* Interview Tips */}
            {showMetrics && (
              <div className="mt-6 bg-purple-900/20 border border-purple-500/30 rounded-xl p-5 animate-slide">
                <h4 className="text-purple-400 font-bold mb-3">≡ƒÄ» Interview Talking Points</h4>
                <ul className="text-sm text-slate-300 space-y-2">
                  <li>ΓÇó <strong>Why OBT in Snowflake?</strong> Storage is cheap, compute is expensive. OBT eliminates JOINs = faster queries.</li>
                  <li>ΓÇó <strong>Trade-off:</strong> OBT works great for read-heavy analytics. Star Schema better for complex, evolving requirements.</li>
                  <li>ΓÇó <strong>Your VPI context:</strong> For your 29 Power BI reports, OBT could reduce query time significantly!</li>
                  <li>ΓÇó <strong>Hybrid approach:</strong> Use DBT to create both - Star Schema as source of truth, OBT as materialized view for BI.</li>
                </ul>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================================================
    // Bridge Table (Many-to-Many) Visualizer
    // ============================================================================

    const BridgeTableVisualizer = () => {
      const [hasBridge, setHasBridge] = useState(false);
      const [isAnimating, setIsAnimating] = useState(false);
      const [selectedEmployee, setSelectedEmployee] = useState < number | null > (null);
      const [showProblem, setShowProblem] = useState(false);

      const employees = [
        { id: 1, name: 'Alice Chen', role: 'Data Engineer' },
        { id: 2, name: 'Bob Kumar', role: 'Tech Lead' },
        { id: 3, name: 'Carol Smith', role: 'Analyst' },
      ];

      const projects = [
        { id: 101, name: 'VPI Analytics', status: 'Active' },
        { id: 102, name: 'ERP Migration', status: 'Active' },
        { id: 103, name: 'Data Lake', status: 'Planning' },
      ];

      // Many-to-many mappings
      const mappings = [
        { empId: 1, projId: 101, role: 'Developer', hours: 20 },
        { empId: 1, projId: 102, role: 'Lead', hours: 15 },
        { empId: 2, projId: 101, role: 'Reviewer', hours: 10 },
        { empId: 2, projId: 102, role: 'Lead', hours: 25 },
        { empId: 2, projId: 103, role: 'Architect', hours: 5 },
        { empId: 3, projId: 101, role: 'Analyst', hours: 30 },
      ];

      const addBridge = () => {
        if (isAnimating || hasBridge) return;
        setIsAnimating(true);
        setTimeout(() => {
          setHasBridge(true);
          setIsAnimating(false);
        }, 1000);
      };

      const reset = () => {
        setHasBridge(false);
        setSelectedEmployee(null);
        setShowProblem(false);
      };

      const showCartesianProblem = () => {
        setShowProblem(true);
      };

      const getEmployeeProjects = (empId: number) => {
        return mappings.filter(m => m.empId === empId);
      };

      return (
        <div className="h-full p-6 overflow-y-auto">
          <div className="max-w-6xl mx-auto">

            {/* Header */}
            <div className="flex justify-between items-center mb-6">
              <div>
                <h3 className="text-xl font-bold text-white">≡ƒîë Many-to-Many Relationships</h3>
                <p className="text-sm text-slate-400">
                  Employees Γåö Projects: One employee can work on many projects, one project can have many employees
                </p>
              </div>
              <div className="flex gap-3">
                {!hasBridge && (
                  <button
                    onClick={showCartesianProblem}
                    className="px-4 py-2 bg-red-600/20 border border-red-500 text-red-400 rounded-lg text-sm hover:bg-red-600/30"
                  >
                    ΓÜá∩╕Å Show Cartesian Problem
                  </button>
                )}
                <button
                  onClick={addBridge}
                  disabled={isAnimating || hasBridge}
                  className={`px-5 py-2 rounded-lg font-semibold transition flex items-center gap-2 ${isAnimating ? 'bg-yellow-600 text-white animate-pulse' :
                      hasBridge ? 'bg-green-600 text-white cursor-default' :
                        'bg-cyan-600 hover:bg-cyan-500 text-white'
                    }`}
                >
                  {isAnimating ? (
                    <>
                      <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                      Creating...
                    </>
                  ) : hasBridge ? (
                    <>Γ£ô Bridge Added</>
                  ) : (
                    <>≡ƒîë Add Bridge Table</>
                  )}
                </button>
                {hasBridge && (
                  <button onClick={reset} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    Reset
                  </button>
                )}
              </div>
            </div>

            {/* Main Visualization */}
            <div className="bg-slate-900 rounded-xl border border-slate-700 p-8 mb-6">
              <div className="flex items-start justify-between gap-8">

                {/* Employees Table */}
                <div className="flex-1">
                  <div className="bg-blue-900/30 border-2 border-blue-500 rounded-xl p-4">
                    <div className="text-xs font-bold text-blue-400 uppercase mb-3 flex items-center gap-2">
                      <span>≡ƒæÑ</span> EMPLOYEES
                    </div>
                    <div className="space-y-2">
                      {employees.map(emp => {
                        const isSelected = selectedEmployee === emp.id;
                        const hasConnection = hasBridge && getEmployeeProjects(emp.id).length > 0;
                        return (
                          <div
                            key={emp.id}
                            onClick={() => hasBridge && setSelectedEmployee(isSelected ? null : emp.id)}
                            className={`p-3 rounded-lg transition cursor-pointer ${isSelected ? 'bg-blue-500/30 border border-blue-400' :
                                hasConnection ? 'bg-slate-800 hover:bg-slate-700' :
                                  'bg-slate-800/50'
                              }`}
                          >
                            <div className="flex justify-between items-center">
                              <div>
                                <div className="font-semibold text-white text-sm">{emp.name}</div>
                                <div className="text-xs text-slate-400">{emp.role}</div>
                              </div>
                              <div className="text-xs mono text-slate-500">ID: {emp.id}</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>

                {/* Bridge Table (appears in center) */}
                <div className="flex-1 flex items-center justify-center min-h-[280px]">
                  {!hasBridge ? (
                    <div className={`text-center ${isAnimating ? 'animate-pulse' : ''}`}>
                      <div className="text-4xl mb-3 text-slate-600">?</div>
                      <div className="text-sm text-slate-500">
                        {isAnimating ? 'Creating bridge...' : 'No direct relationship possible'}
                      </div>
                      <div className="text-xs text-slate-600 mt-2">Many-to-Many requires a bridge table</div>
                    </div>
                  ) : (
                    <div className="bg-emerald-900/30 border-2 border-emerald-500 rounded-xl p-4 w-full animate-slide">
                      <div className="text-xs font-bold text-emerald-400 uppercase mb-3 flex items-center gap-2">
                        <span>≡ƒîë</span> EMPLOYEE_PROJECT_MAPPING
                      </div>
                      <div className="space-y-1 max-h-[200px] overflow-y-auto">
                        {mappings.map((m, idx) => {
                          const isHighlighted = selectedEmployee === m.empId;
                          return (
                            <div
                              key={idx}
                              className={`p-2 rounded text-xs flex justify-between items-center transition ${isHighlighted ? 'bg-emerald-500/30 border border-emerald-400' : 'bg-slate-800/50'
                                }`}
                            >
                              <div className="flex gap-3">
                                <span className="text-blue-400 mono">E:{m.empId}</span>
                                <span className="text-slate-500">ΓåÆ</span>
                                <span className="text-orange-400 mono">P:{m.projId}</span>
                              </div>
                              <div className="flex gap-2">
                                <span className="text-slate-400">{m.role}</span>
                                <span className="text-slate-500">{m.hours}h</span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      <div className="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-400">
                        Γ£ô Stores additional attributes: <span className="text-emerald-400">role, hours</span>
                      </div>
                    </div>
                  )}
                </div>

                {/* Projects Table */}
                <div className="flex-1">
                  <div className="bg-orange-900/30 border-2 border-orange-500 rounded-xl p-4">
                    <div className="text-xs font-bold text-orange-400 uppercase mb-3 flex items-center gap-2">
                      <span>≡ƒôü</span> PROJECTS
                    </div>
                    <div className="space-y-2">
                      {projects.map(proj => {
                        const isConnected = hasBridge && selectedEmployee &&
                          mappings.some(m => m.empId === selectedEmployee && m.projId === proj.id);
                        return (
                          <div
                            key={proj.id}
                            className={`p-3 rounded-lg transition ${isConnected ? 'bg-orange-500/30 border border-orange-400' : 'bg-slate-800/50'
                              }`}
                          >
                            <div className="flex justify-between items-center">
                              <div>
                                <div className="font-semibold text-white text-sm">{proj.name}</div>
                                <div className="text-xs text-slate-400">{proj.status}</div>
                              </div>
                              <div className="text-xs mono text-slate-500">ID: {proj.id}</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              {/* Hint */}
              {hasBridge && !selectedEmployee && (
                <div className="mt-6 text-center text-sm text-slate-500">
                  ≡ƒæå Click on an employee to see their project connections
                </div>
              )}
            </div>

            {/* Cartesian Problem Modal */}
            {showProblem && !hasBridge && (
              <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-5 mb-6 animate-slide">
                <h4 className="text-red-400 font-bold mb-3">ΓÜá∩╕Å The Cartesian Product Problem</h4>
                <div className="grid grid-cols-2 gap-6">
                  <div>
                    <div className="text-sm text-slate-300 mb-3">
                      <strong>Without bridge table:</strong> Direct JOIN creates explosion
                    </div>
                    <div className="bg-slate-900 rounded-lg p-3 mono text-xs">
                      <div className="text-red-400">-- BAD: Creates duplicates!</div>
                      <div className="text-slate-400">SELECT * FROM Employees e</div>
                      <div className="text-slate-400">JOIN Projects p</div>
                      <div className="text-slate-400">  ON <span className="text-red-400">???</span> -- No FK relationship!</div>
                      <div className="mt-2 text-red-400">-- Result: 3 ├ù 3 = 9 rows (Cartesian)</div>
                    </div>
                  </div>
                  <div>
                    <div className="text-sm text-slate-300 mb-3">
                      <strong>With bridge table:</strong> Proper relationship
                    </div>
                    <div className="bg-slate-900 rounded-lg p-3 mono text-xs">
                      <div className="text-green-400">-- GOOD: Only matching rows</div>
                      <div className="text-slate-400">SELECT * FROM Employees e</div>
                      <div className="text-slate-400">JOIN Emp_Proj_Map m ON e.id = m.emp_id</div>
                      <div className="text-slate-400">JOIN Projects p ON m.proj_id = p.id</div>
                      <div className="mt-2 text-green-400">-- Result: Only 6 valid mappings</div>
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => setShowProblem(false)}
                  className="mt-4 text-xs text-slate-500 hover:text-slate-300"
                >
                  Close
                </button>
              </div>
            )}

            {/* SQL Reference */}
            <div className="grid grid-cols-2 gap-6">
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                <h4 className="font-bold text-white mb-3">≡ƒô¥ Bridge Table DDL</h4>
                <div className="bg-slate-950 rounded-lg p-4 mono text-xs text-slate-400">
                  <div><span className="text-purple-400">CREATE TABLE</span> employee_project_mapping (</div>
                  <div className="pl-4">emp_id <span className="text-cyan-400">INT</span> <span className="text-orange-400">REFERENCES</span> employees(id),</div>
                  <div className="pl-4">proj_id <span className="text-cyan-400">INT</span> <span className="text-orange-400">REFERENCES</span> projects(id),</div>
                  <div className="pl-4">role <span className="text-cyan-400">VARCHAR</span>(50),</div>
                  <div className="pl-4">hours_allocated <span className="text-cyan-400">INT</span>,</div>
                  <div className="pl-4"><span className="text-yellow-400">PRIMARY KEY</span> (emp_id, proj_id)</div>
                  <div>);</div>
                </div>
              </div>

              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                <h4 className="font-bold text-white mb-3">≡ƒöù Query Pattern</h4>
                <div className="bg-slate-950 rounded-lg p-4 mono text-xs text-slate-400">
                  <div><span className="text-green-400">-- Find all projects for Alice</span></div>
                  <div><span className="text-purple-400">SELECT</span> e.name, p.name, m.role</div>
                  <div><span className="text-purple-400">FROM</span> employees e</div>
                  <div><span className="text-cyan-400">JOIN</span> employee_project_mapping m</div>
                  <div className="pl-4"><span className="text-purple-400">ON</span> e.id = m.emp_id</div>
                  <div><span className="text-cyan-400">JOIN</span> projects p</div>
                  <div className="pl-4"><span className="text-purple-400">ON</span> m.proj_id = p.id</div>
                  <div><span className="text-purple-400">WHERE</span> e.name = <span className="text-yellow-400">'Alice Chen'</span>;</div>
                </div>
              </div>
            </div>

            {/* Interview Tips */}
            {hasBridge && (
              <div className="mt-6 bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-5 animate-slide">
                <h4 className="text-emerald-400 font-bold mb-3">≡ƒÄ» Interview Talking Points</h4>
                <ul className="text-sm text-slate-300 space-y-2">
                  <li>ΓÇó <strong>Bridge tables</strong> (also called junction/associative tables) resolve M:M relationships</li>
                  <li>ΓÇó <strong>Composite primary key:</strong> (emp_id, proj_id) ensures unique combinations</li>
                  <li>ΓÇó <strong>Extra attributes:</strong> Bridge tables can store relationship-specific data (role, hours, start_date)</li>
                  <li>ΓÇó <strong>VPI Example:</strong> BOM_COMPONENT_SUBSTITUTES could be a bridge between components that are interchangeable</li>
                  <li>ΓÇó <strong>Avoid fan trap:</strong> Always join through the bridge, never directly between the two main tables</li>
                </ul>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================================================
    // DBT Layers Visualization (Simplified)
    // ============================================================================

    const DBTLayersViz = () => {
      const [activeLayer, setActiveLayer] = useState < 'staging' | 'intermediate' | 'marts' > ('staging');

      const layers = {
        staging: {
          title: 'Staging Layer (stg_)',
          color: 'cyan',
          purpose: 'Raw data with light transformations. 1:1 with source tables.',
          naming: 'stg_<source>__<table>',
          example: 'stg_oracle__po_headers',
          code: `-- models/staging/stg_oracle__po_headers.sql
WITH source AS (
    SELECT * FROM {{ source('oracle', 'PO_HEADERS_ALL') }}
),
cleaned AS (
    SELECT
        po_header_id,
        segment1 AS po_number,
        vendor_id,
        CAST(creation_date AS DATE) AS created_date,
        authorization_status AS status
    FROM source
    WHERE NVL(cancel_flag, 'N') != 'Y'
)
SELECT * FROM cleaned`
        },
        intermediate: {
          title: 'Intermediate Layer (int_)',
          color: 'yellow',
          purpose: 'Business logic, joins, aggregations. Not exposed to end users.',
          naming: 'int_<entity>__<transformation>',
          example: 'int_po__with_lines',
          code: `-- models/intermediate/int_po__with_lines.sql
WITH po_headers AS (
    SELECT * FROM {{ ref('stg_oracle__po_headers') }}
),
po_lines AS (
    SELECT * FROM {{ ref('stg_oracle__po_lines') }}
),
joined AS (
    SELECT
        h.po_number,
        h.vendor_id,
        l.line_num,
        l.item_id,
        l.quantity,
        l.unit_price
    FROM po_headers h
    JOIN po_lines l ON h.po_header_id = l.po_header_id
)
SELECT * FROM joined`
        },
        marts: {
          title: 'Marts Layer (dim_, fct_)',
          color: 'green',
          purpose: 'Business-ready tables for BI tools. Dimensional modeling.',
          naming: 'dim_<entity> or fct_<process>',
          example: 'fct_purchase_orders',
          code: `-- models/marts/fct_purchase_orders.sql
WITH po_data AS (
    SELECT * FROM {{ ref('int_po__with_lines') }}
),
final AS (
    SELECT
        {{ dbt_utils.generate_surrogate_key(['po_number', 'line_num']) }} AS po_line_key,
        po_number,
        line_num,
        item_id,
        quantity,
        unit_price,
        quantity * unit_price AS line_amount
    FROM po_data
)
SELECT * FROM final`
        }
      };

      const current = layers[activeLayer];

      return (
        <div className="h-full p-6 overflow-y-auto">
          <div className="max-w-5xl mx-auto">
            <h3 className="text-xl font-bold text-white mb-6">≡ƒö╢ DBT Project Structure</h3>

            <div className="flex gap-6">
              {/* Layer Selector */}
              <div className="w-64 space-y-2">
                {Object.entries(layers).map(([key, layer]) => (
                  <button
                    key={key}
                    onClick={() => setActiveLayer(key as any)}
                    className={`w-full p-4 rounded-xl text-left transition ${activeLayer === key
                        ? `bg-${layer.color}-500/20 border-2 border-${layer.color}-500`
                        : 'bg-slate-800 border-2 border-slate-700 hover:border-slate-600'
                      }`}
                  >
                    <div className={`font-bold ${activeLayer === key ? `text-${layer.color}-400` : 'text-white'}`}>
                      {layer.title}
                    </div>
                    <div className="text-xs text-slate-400 mt-1">{layer.purpose.slice(0, 50)}...</div>
                  </button>
                ))}

                {/* DAG */}
                <div className="mt-6 p-4 bg-slate-800 rounded-xl">
                  <div className="text-xs font-bold text-slate-500 uppercase mb-3">DAG Flow</div>
                  <div className="flex flex-col items-center gap-2 text-xs">
                    <div className={`px-3 py-1 rounded mono ${activeLayer === 'staging' ? 'bg-cyan-500/30 text-cyan-400' : 'bg-slate-700 text-slate-500'}`}>
                      stg_*
                    </div>
                    <div className="text-slate-600">Γåô</div>
                    <div className={`px-3 py-1 rounded mono ${activeLayer === 'intermediate' ? 'bg-yellow-500/30 text-yellow-400' : 'bg-slate-700 text-slate-500'}`}>
                      int_*
                    </div>
                    <div className="text-slate-600">Γåô</div>
                    <div className={`px-3 py-1 rounded mono ${activeLayer === 'marts' ? 'bg-green-500/30 text-green-400' : 'bg-slate-700 text-slate-500'}`}>
                      dim_* / fct_*
                    </div>
                  </div>
                </div>
              </div>

              {/* Code Display */}
              <div className="flex-1">
                <div className={`bg-${current.color}-900/20 border border-${current.color}-500/30 rounded-t-xl p-4`}>
                  <h4 className="font-bold text-white">{current.title}</h4>
                  <p className="text-sm text-slate-300 mt-1">{current.purpose}</p>
                  <div className="mt-2 flex gap-4 text-xs">
                    <div><span className="text-slate-500">Naming:</span> <span className="text-cyan-400 mono">{current.naming}</span></div>
                    <div><span className="text-slate-500">Example:</span> <span className="text-orange-400 mono">{current.example}</span></div>
                  </div>
                </div>
                <div className="bg-slate-950 rounded-b-xl p-4 overflow-x-auto">
                  <pre className="text-xs mono text-slate-400 whitespace-pre">{current.code}</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================================
    // Snowflake Patterns Visualization (Simplified)
    // ============================================================================

    const SnowflakePatternsViz = () => {
      const patterns = [
        {
          title: 'Dynamic Tables',
          icon: 'ΓÜí',
          description: 'Auto-refreshing materialized views. Solved your VPI data availability issue!',
          code: `CREATE DYNAMIC TABLE marts.fct_inventory
  TARGET_LAG = '10 minutes'
  WAREHOUSE = ETL_WH
AS SELECT * FROM int_inventory;`,
          pros: ['No scheduling', 'Auto dependency', 'Incremental'],
          useCase: 'Near real-time reporting'
        },
        {
          title: 'Streams + Tasks',
          icon: '≡ƒîè',
          description: 'CDC pattern. Track changes and process incrementally.',
          code: `CREATE STREAM stg_stream ON TABLE stg_data;
CREATE TASK process_changes
  SCHEDULE = '5 MINUTE'
  WHEN SYSTEM$STREAM_HAS_DATA('stg_stream')
AS MERGE INTO target ...;`,
          pros: ['Fine control', 'CDC built-in', 'Custom logic'],
          useCase: 'SCD Type 2, complex transforms'
        },
        {
          title: 'Zero-Copy Clone',
          icon: '≡ƒôï',
          description: 'Instant copies without storage cost. Perfect for dev/test.',
          code: `CREATE DATABASE dev_db CLONE prod_db;
CREATE TABLE backup CLONE source 
  AT(TIMESTAMP => '2024-01-15'::TIMESTAMP);`,
          pros: ['Instant', 'No storage cost', 'Time Travel'],
          useCase: 'Testing, backups, CI/CD'
        },
        {
          title: 'Transient Tables',
          icon: 'ΓÅ│',
          description: 'No Fail-safe period. Lower storage cost for staging data.',
          code: `CREATE TRANSIENT TABLE stg_temp (
  id INT,
  data VARIANT
);
-- 1-day Time Travel only, no Fail-safe`,
          pros: ['Lower cost', 'Good for ETL', 'Fast cleanup'],
          useCase: 'Staging, temp tables'
        }
      ];

      return (
        <div className="h-full p-6 overflow-y-auto">
          <div className="max-w-5xl mx-auto">
            <h3 className="text-xl font-bold text-white mb-6">Γ¥ä∩╕Å Snowflake-Specific Patterns</h3>

            <div className="grid grid-cols-2 gap-6">
              {patterns.map((p, idx) => (
                <div key={idx} className="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden">
                  <div className="bg-cyan-900/30 p-4 border-b border-slate-700 flex items-center gap-3">
                    <span className="text-2xl">{p.icon}</span>
                    <div>
                      <h4 className="font-bold text-white">{p.title}</h4>
                      <p className="text-xs text-slate-400">{p.description}</p>
                    </div>
                  </div>
                  <div className="p-4">
                    <div className="bg-slate-950 rounded-lg p-3 mb-3 overflow-x-auto">
                      <pre className="text-[11px] mono text-slate-400 whitespace-pre">{p.code}</pre>
                    </div>
                    <div className="flex gap-2 flex-wrap mb-2">
                      {p.pros.map((pro, i) => (
                        <span key={i} className="text-[10px] px-2 py-0.5 bg-green-900/30 text-green-400 rounded">
                          Γ£ô {pro}
                        </span>
                      ))}
                    </div>
                    <div className="text-xs text-slate-500">
                      <span className="text-cyan-400">Best for:</span> {p.useCase}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };
    // ============================================================================
    // SNOWFLAKE CLUSTERING VISUALIZATION COMPONENT
    // ============================================================================

    const SnowflakeClusteringViz = () => {
      const [isClustered, setIsClustered] = useState(false);
      const [isAnimating, setIsAnimating] = useState(false);
      const [creditsUsed, setCreditsUsed] = useState(0);
      const [searchDate, setSearchDate] = useState < number | null > (null);
      const [showMetrics, setShowMetrics] = useState(false);

      // Micro-partition data - poor clustering (overlapping date ranges)
      const poorClusteringData = [
        { id: 1, minDate: 1, maxDate: 15, rows: 1200, color: 'bg-red-500' },
        { id: 2, minDate: 5, maxDate: 20, rows: 980, color: 'bg-orange-500' },
        { id: 3, minDate: 10, maxDate: 25, rows: 1100, color: 'bg-yellow-500' },
        { id: 4, minDate: 3, maxDate: 18, rows: 850, color: 'bg-green-500' },
        { id: 5, minDate: 12, maxDate: 28, rows: 1050, color: 'bg-blue-500' },
        { id: 6, minDate: 8, maxDate: 22, rows: 920, color: 'bg-purple-500' },
      ];

      // Good clustering (sorted, minimal overlap)
      const goodClusteringData = [
        { id: 1, minDate: 1, maxDate: 5, rows: 1000, color: 'bg-cyan-500' },
        { id: 2, minDate: 6, maxDate: 10, rows: 1000, color: 'bg-cyan-500' },
        { id: 3, minDate: 11, maxDate: 15, rows: 1000, color: 'bg-cyan-500' },
        { id: 4, minDate: 16, maxDate: 20, rows: 1000, color: 'bg-cyan-500' },
        { id: 5, minDate: 21, maxDate: 25, rows: 1000, color: 'bg-cyan-500' },
        { id: 6, minDate: 26, maxDate: 30, rows: 1000, color: 'bg-cyan-500' },
      ];

      const currentData = isClustered ? goodClusteringData : poorClusteringData;

      // Calculate which partitions would be scanned for a given date
      const getScannedPartitions = (date: number, data: typeof poorClusteringData) => {
        return data.filter(p => date >= p.minDate && date <= p.maxDate);
      };

      const scannedPartitions = searchDate ? getScannedPartitions(searchDate, currentData) : [];
      const pruningEfficiency = searchDate
        ? Math.round(((currentData.length - scannedPartitions.length) / currentData.length) * 100)
        : 0;

      // Calculate clustering depth (average overlap)
      const calculateDepth = (data: typeof poorClusteringData) => {
        let totalOverlap = 0;
        for (let day = 1; day <= 30; day++) {
          const overlapping = data.filter(p => day >= p.minDate && day <= p.maxDate).length;
          totalOverlap += overlapping;
        }
        return (totalOverlap / 30).toFixed(2);
      };

      const runReclustering = () => {
        if (isAnimating || isClustered) return;

        setIsAnimating(true);
        setCreditsUsed(0);

        // Animate credits counter
        const creditInterval = setInterval(() => {
          setCreditsUsed(prev => {
            if (prev >= 12) {
              clearInterval(creditInterval);
              return 12;
            }
            return prev + 1;
          });
        }, 150);

        // Complete animation after 2 seconds
        setTimeout(() => {
          setIsClustered(true);
          setIsAnimating(false);
          setShowMetrics(true);
        }, 2000);
      };

      const resetDemo = () => {
        setIsClustered(false);
        setCreditsUsed(0);
        setSearchDate(null);
        setShowMetrics(false);
      };

      return (
        <div className="h-full p-6 overflow-y-auto">
          <div className="max-w-6xl mx-auto">

            {/* Header Section */}
            <div className="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 border border-cyan-500/30 rounded-xl p-5 mb-6">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-xl font-bold text-white mb-2">Γ¥ä∩╕Å Interactive Clustering Depth Visualizer</h3>
                  <p className="text-sm text-slate-300">
                    See how <strong>micro-partition overlap</strong> affects query performance and how
                    <strong> auto-reclustering</strong> optimizes data layout.
                  </p>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={runReclustering}
                    disabled={isAnimating || isClustered}
                    className={`px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 ${isAnimating ? 'bg-yellow-600 text-white animate-pulse' :
                        isClustered ? 'bg-green-600 text-white cursor-default' :
                          'bg-cyan-600 hover:bg-cyan-500 text-white'
                      }`}
                  >
                    {isAnimating ? (
                      <>
                        <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        Reclustering...
                      </>
                    ) : isClustered ? (
                      <>Γ£ô Clustered</>
                    ) : (
                      <>ΓÜí Run Auto-Clustering</>
                    )}
                  </button>
                  <button
                    onClick={resetDemo}
                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition"
                  >
                    Reset
                  </button>
                </div>
              </div>

              {/* Credits Counter */}
              {(isAnimating || creditsUsed > 0) && (
                <div className="mt-4 flex items-center gap-4">
                  <div className="bg-slate-900/50 rounded-lg px-4 py-2 flex items-center gap-2">
                    <span className="text-yellow-400">≡ƒÆ░</span>
                    <span className="text-sm text-slate-300">Credits Used:</span>
                    <span className="text-lg font-bold text-yellow-400 mono">{creditsUsed}</span>
                  </div>
                  {isAnimating && (
                    <span className="text-xs text-slate-400 animate-pulse">
                      Reorganizing micro-partitions...
                    </span>
                  )}
                </div>
              )}
            </div>

            {/* Main Visualization */}
            <div className="grid grid-cols-2 gap-6 mb-6">

              {/* Timeline Visualization */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                <div className="flex items-center justify-between mb-4">
                  <h4 className="font-bold text-white">
                    {isClustered ? 'Γ£ô Good Clustering' : 'ΓÜá∩╕Å Poor Clustering'}
                  </h4>
                  <span className={`text-xs px-2 py-1 rounded ${isClustered ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'
                    }`}>
                    Depth: {calculateDepth(currentData)}
                  </span>
                </div>

                {/* Timeline Header */}
                <div className="flex justify-between text-[10px] text-slate-500 mb-2 px-1">
                  {[1, 5, 10, 15, 20, 25, 30].map(d => (
                    <span key={d}>Day {d}</span>
                  ))}
                </div>

                {/* Partition Bars */}
                <div className="relative h-64 bg-slate-950 rounded-lg p-3">
                  {currentData.map((partition, idx) => {
                    const leftPercent = ((partition.minDate - 1) / 29) * 100;
                    const widthPercent = ((partition.maxDate - partition.minDate) / 29) * 100;
                    const isScanned = searchDate && scannedPartitions.some(p => p.id === partition.id);

                    return (
                      <div
                        key={partition.id}
                        className={`absolute h-8 rounded-md transition-all duration-1000 flex items-center justify-center text-[10px] font-bold text-white ${isScanned ? 'ring-2 ring-yellow-400 ring-offset-2 ring-offset-slate-950 z-10' : ''
                          } ${isAnimating ? 'opacity-50' : ''}`}
                        style={{
                          left: `${leftPercent}%`,
                          width: `${Math.max(widthPercent, 8)}%`,
                          top: `${idx * 38 + 8}px`,
                          backgroundColor: isScanned ? '#facc15' :
                            isClustered ? '#06b6d4' :
                              ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7'][idx],
                          boxShadow: isScanned ? '0 0 20px rgba(250, 204, 21, 0.5)' : 'none'
                        }}
                      >
                        P{partition.id}
                        {isScanned && <span className="ml-1">≡ƒôû</span>}
                      </div>
                    );
                  })}

                  {/* Search Date Indicator */}
                  {searchDate && (
                    <div
                      className="absolute top-0 bottom-0 w-0.5 bg-yellow-400 z-20"
                      style={{ left: `${((searchDate - 1) / 29) * 100}%` }}
                    >
                      <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-yellow-500 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded whitespace-nowrap">
                        Query: Day {searchDate}
                      </div>
                    </div>
                  )}
                </div>

                {/* Legend */}
                <div className="mt-4 flex items-center gap-4 text-xs text-slate-400">
                  <span>ΓåÉ Earlier dates</span>
                  <span className="flex-1 border-t border-slate-700" />
                  <span>Later dates ΓåÆ</span>
                </div>
              </div>

              {/* Metrics & Controls */}
              <div className="space-y-4">

                {/* Search Simulation */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                  <h4 className="font-bold text-white mb-3">≡ƒöì Search Simulation</h4>
                  <p className="text-xs text-slate-400 mb-3">
                    Click a date to see which partitions would be scanned
                  </p>
                  <div className="grid grid-cols-6 gap-2">
                    {[5, 10, 12, 15, 20, 25].map(date => (
                      <button
                        key={date}
                        onClick={() => setSearchDate(date)}
                        className={`px-3 py-2 rounded-lg text-sm font-mono transition ${searchDate === date
                            ? 'bg-yellow-500 text-slate-900 font-bold'
                            : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                          }`}
                      >
                        Day {date}
                      </button>
                    ))}
                  </div>

                  {searchDate && (
                    <div className="mt-4 p-3 rounded-lg bg-slate-800 border border-slate-700">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-sm text-slate-400">Partitions Scanned:</span>
                        <span className={`text-lg font-bold ${scannedPartitions.length <= 1 ? 'text-green-400' :
                            scannedPartitions.length <= 3 ? 'text-yellow-400' :
                              'text-red-400'
                          }`}>
                          {scannedPartitions.length} / {currentData.length}
                        </span>
                      </div>
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-sm text-slate-400">Pruning Efficiency:</span>
                        <span className={`text-lg font-bold ${pruningEfficiency >= 80 ? 'text-green-400' :
                            pruningEfficiency >= 50 ? 'text-yellow-400' :
                              'text-red-400'
                          }`}>
                          {pruningEfficiency}%
                        </span>
                      </div>
                      {/* Efficiency Bar */}
                      <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div
                          className={`h-full transition-all duration-500 ${pruningEfficiency >= 80 ? 'bg-green-500' :
                              pruningEfficiency >= 50 ? 'bg-yellow-500' :
                                'bg-red-500'
                            }`}
                          style={{ width: `${pruningEfficiency}%` }}
                        />
                      </div>
                    </div>
                  )}
                </div>

                {/* Clustering Depth Metrics */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                  <h4 className="font-bold text-white mb-3">≡ƒôè Clustering Metrics</h4>
                  <div className="space-y-3">
                    <div className="flex justify-between items-center p-3 bg-slate-800 rounded-lg">
                      <span className="text-sm text-slate-400">Average Depth</span>
                      <div className="flex items-center gap-2">
                        <span className={`text-xl font-bold mono ${isClustered ? 'text-green-400' : 'text-red-400'
                          }`}>
                          {calculateDepth(currentData)}
                        </span>
                        <span className="text-xs text-slate-500">(lower = better)</span>
                      </div>
                    </div>
                    <div className="flex justify-between items-center p-3 bg-slate-800 rounded-lg">
                      <span className="text-sm text-slate-400">Overlap Factor</span>
                      <span className={`text-xl font-bold mono ${isClustered ? 'text-green-400' : 'text-red-400'
                        }`}>
                        {isClustered ? '0%' : '67%'}
                      </span>
                    </div>
                    <div className="flex justify-between items-center p-3 bg-slate-800 rounded-lg">
                      <span className="text-sm text-slate-400">Status</span>
                      <span className={`text-sm font-bold px-2 py-1 rounded ${isClustered ? 'bg-green-900/50 text-green-400' : 'bg-yellow-900/50 text-yellow-400'
                        }`}>
                        {isClustered ? 'OPTIMIZED' : 'NEEDS RECLUSTERING'}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* SQL Reference */}
            <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
              <h4 className="font-bold text-white mb-3">≡ƒô¥ SQL Commands for Clustering</h4>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-950 rounded-lg p-4">
                  <div className="text-xs text-cyan-400 font-bold mb-2">Add Clustering Key</div>
                  <pre className="text-[11px] mono text-slate-400">{`ALTER TABLE fct_sales
CLUSTER BY (order_date, region);`}</pre>
                </div>
                <div className="bg-slate-950 rounded-lg p-4">
                  <div className="text-xs text-cyan-400 font-bold mb-2">Check Clustering Info</div>
                  <pre className="text-[11px] mono text-slate-400">{`SELECT SYSTEM$CLUSTERING_INFORMATION(
  'fct_sales', '(order_date)'
);`}</pre>
                </div>
                <div className="bg-slate-950 rounded-lg p-4">
                  <div className="text-xs text-cyan-400 font-bold mb-2">Manual Recluster</div>
                  <pre className="text-[11px] mono text-slate-400">{`ALTER TABLE fct_sales RECLUSTER;
-- Uses credits from warehouse`}</pre>
                </div>
                <div className="bg-slate-950 rounded-lg p-4">
                  <div className="text-xs text-cyan-400 font-bold mb-2">Suspend Auto-Clustering</div>
                  <pre className="text-[11px] mono text-slate-400">{`ALTER TABLE fct_sales 
SUSPEND RECLUSTER;`}</pre>
                </div>
              </div>
            </div>

            {/* Interview Tips */}
            {showMetrics && (
              <div className="mt-6 bg-green-900/20 border border-green-500/30 rounded-xl p-5 animate-slide">
                <h4 className="text-green-400 font-bold mb-3">≡ƒÄ» Key Interview Talking Points</h4>
                <ul className="text-sm text-slate-300 space-y-2">
                  <li>ΓÇó <strong>Clustering depth</strong> = average # of partitions containing overlapping values. Lower is better.</li>
                  <li>ΓÇó <strong>Auto-reclustering</strong> runs in background when data changes. Consumes credits from Snowflake account.</li>
                  <li>ΓÇó Choose clustering keys based on <strong>most common WHERE/JOIN columns</strong>.</li>
                  <li>ΓÇó <strong>Don't cluster</strong> on high-cardinality columns (like UUID) or frequently updated columns.</li>
                  <li>ΓÇó In your VPI project: Clustering on <strong>(order_date, plant_code)</strong> would optimize your Power BI report queries!</li>
                </ul>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================================================
    // 3. INDEXING STRATEGY SIMULATOR (T-SQL + Snowflake)
    // ============================================================================

    const IndexingSimulator = ({ onBack }: { onBack: () => void }) => {
      const [activeTab, setActiveTab] = useState < 'tsql' | 'snowflake' | 'comparison' | 'finops' > ('tsql');
      const [indexType, setIndexType] = useState < 'heap' | 'clustered' | 'nonclustered' | 'covering' > ('heap');
      const [searchId, setSearchId] = useState < number | null > (null);
      const [searchSteps, setSearchSteps] = useState < string[] > ([]);
      const [isSearching, setIsSearching] = useState(false);

      // Sample data for visualization
      const sampleData = [
        { id: 1, name: 'BLOCK-ASM', category: 'Assembly', price: 450 },
        { id: 2, name: 'PISTON-SET', category: 'Engine', price: 280 },
        { id: 3, name: 'CRANKSHAFT', category: 'Engine', price: 890 },
        { id: 5, name: 'CAM-BEARING', category: 'Bearing', price: 45 },
        { id: 8, name: 'CYLINDER-LINER', category: 'Engine', price: 320 },
        { id: 9, name: 'WRIST-PIN', category: 'Engine', price: 65 },
        { id: 13, name: 'PISTON-RING', category: 'Engine', price: 35 },
        { id: 21, name: 'STEEL-COAT', category: 'Coating', price: 120 },
      ];

      // B-Tree structure for visualization
      const btreeStructure = {
        root: { keys: [5, 13], children: ['left', 'middle', 'right'] },
        left: { keys: [1, 2, 3], isLeaf: true, pointers: [1, 2, 3] },
        middle: { keys: [5, 8, 9], isLeaf: true, pointers: [5, 8, 9] },
        right: { keys: [13, 21], isLeaf: true, pointers: [13, 21] },
      };

      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      const simulateSearch = (id: number) => {
        setSearchId(id);
        setSearchSteps([]);
        setIsSearching(true);

        const steps: string[] = [];

        if (indexType === 'heap') {
          // Table scan
          steps.push('Starting TABLE SCAN (no index)...');
          sampleData.forEach((row, idx) => {
            steps.push(`Checking row ${idx + 1}: ID = ${row.id} ${row.id === id ? 'Γ£ô FOUND!' : 'Γ£ù'}`);
          });
          steps.push(`Rows scanned: ${sampleData.length} | Complexity: O(n)`);
        } else if (indexType === 'clustered' || indexType === 'nonclustered') {
          // B-Tree search
          steps.push('Starting B-TREE INDEX SEEK...');
          steps.push(`ROOT NODE: Checking keys [5, 13]`);

          if (id < 5) {
            steps.push(`${id} < 5 ΓåÆ Navigate to LEFT child`);
            steps.push(`LEAF NODE: Keys [1, 2, 3]`);
          } else if (id < 13) {
            steps.push(`5 Γëñ ${id} < 13 ΓåÆ Navigate to MIDDLE child`);
            steps.push(`LEAF NODE: Keys [5, 8, 9]`);
          } else {
            steps.push(`${id} ΓëÑ 13 ΓåÆ Navigate to RIGHT child`);
            steps.push(`LEAF NODE: Keys [13, 21]`);
          }

          const found = sampleData.find(r => r.id === id);
          if (found) {
            if (indexType === 'clustered') {
              steps.push(`Γ£ô FOUND! Data stored with index leaf.`);
            } else {
              steps.push(`Γ£ô FOUND key! Following RID pointer to data page...`);
              steps.push(`KEY LOOKUP: Retrieved row from heap.`);
            }
          } else {
            steps.push(`Γ£ù Key ${id} not found in leaf node.`);
          }
          steps.push(`Rows scanned: ~3 | Complexity: O(log n)`);
        } else if (indexType === 'covering') {
          steps.push('Starting COVERING INDEX SEEK...');
          steps.push(`ROOT NODE: Checking keys [5, 13]`);
          if (id < 5) {
            steps.push(`${id} < 5 ΓåÆ Navigate to LEFT child`);
          } else if (id < 13) {
            steps.push(`5 Γëñ ${id} < 13 ΓåÆ Navigate to MIDDLE child`);
          } else {
            steps.push(`${id} ΓëÑ 13 ΓåÆ Navigate to RIGHT child`);
          }
          steps.push(`Γ£ô All columns INCLUDED in index!`);
          steps.push(`NO KEY LOOKUP needed - data in index leaf.`);
          steps.push(`Rows scanned: ~3 | Complexity: O(log n) | FASTEST!`);
        }

        // Animate steps
        steps.forEach((step, idx) => {
          setTimeout(() => {
            setSearchSteps(prev => [...prev, step]);
            if (idx === steps.length - 1) setIsSearching(false);
          }, idx * 400);
        });
      };

      // T-SQL Index Types
      const tsqlIndexTypes = [
        {
          id: 'clustered',
          title: 'Clustered Index',
          icon: '≡ƒÄ»',
          description: 'Physically sorts and stores data rows. ONE per table. The table IS the index.',
          syntax: `-- Create clustered index (usually on PK)
CREATE CLUSTERED INDEX IX_Parts_PartID
ON dbo.Parts (Part_ID);

-- Or via Primary Key
ALTER TABLE dbo.Parts
ADD CONSTRAINT PK_Parts PRIMARY KEY CLUSTERED (Part_ID);`,
          pros: ['Fast range queries', 'No extra storage', 'Data physically sorted'],
          cons: ['Only ONE per table', 'Insert/Update can cause page splits', 'Wide keys = slower'],
          useCase: 'Primary key, frequently used in ORDER BY, range scans (dates)'
        },
        {
          id: 'nonclustered',
          title: 'Non-Clustered Index',
          icon: '≡ƒôæ',
          description: 'Separate structure pointing to data rows. Multiple allowed. Like an index in a book.',
          syntax: `-- Basic non-clustered index
CREATE NONCLUSTERED INDEX IX_Parts_Category
ON dbo.Parts (Category);

-- Composite index (multiple columns)
CREATE NONCLUSTERED INDEX IX_Parts_Cat_Date
ON dbo.Parts (Category, Created_Date DESC);`,
          pros: ['Multiple per table (up to 999)', 'Flexible - any column(s)', 'Can include columns'],
          cons: ['Extra storage', 'Key lookup overhead', 'Maintenance cost on writes'],
          useCase: 'WHERE clause columns, JOIN columns, frequently filtered columns'
        },
        {
          id: 'covering',
          title: 'Covering Index (INCLUDE)',
          icon: '≡ƒôª',
          description: 'Non-clustered index that INCLUDES all columns needed. Eliminates key lookups!',
          syntax: `-- Covering index with INCLUDE
CREATE NONCLUSTERED INDEX IX_Parts_Covering
ON dbo.Parts (Category, Plant_Code)
INCLUDE (Part_Name, Unit_Price, Quantity);

-- Query that benefits:
SELECT Part_Name, Unit_Price, Quantity
WHERE Category = 'Engine' AND Plant_Code = 'VPI';
-- All columns in index = NO KEY LOOKUP!`,
          pros: ['Eliminates key lookups', 'Fastest read performance', 'Index-only scan'],
          cons: ['Larger index size', 'More maintenance', 'Include cols not in sort'],
          useCase: 'High-frequency queries with specific column patterns'
        },
        {
          id: 'filtered',
          title: 'Filtered Index',
          icon: '≡ƒöì',
          description: 'Index with WHERE clause. Smaller, faster, cheaper for subset of data.',
          syntax: `-- Filtered index on active parts only
CREATE NONCLUSTERED INDEX IX_Parts_Active
ON dbo.Parts (Part_ID, Category)
WHERE Is_Active = 1;

-- Filtered index on recent data
CREATE NONCLUSTERED INDEX IX_Orders_Recent
ON dbo.Orders (Order_Date, Customer_ID)
WHERE Order_Date >= '2024-01-01';`,
          pros: ['Smaller index', 'Faster maintenance', 'Less storage'],
          cons: ['Only for queries matching filter', 'Can cause plan issues'],
          useCase: 'Queries that always filter on same condition (active records, recent dates)'
        },
        {
          id: 'columnstore',
          title: 'Columnstore Index',
          icon: '≡ƒôè',
          description: 'Column-oriented storage. MASSIVE compression. Best for analytics/reporting.',
          syntax: `-- Clustered columnstore (entire table)
CREATE CLUSTERED COLUMNSTORE INDEX CCI_Sales
ON dbo.Fact_Sales;

-- Non-clustered columnstore (hybrid)
CREATE NONCLUSTERED COLUMNSTORE INDEX NCCI_Sales
ON dbo.Fact_Sales (Order_Date, Product_ID, Amount);`,
          pros: ['10x compression', 'Batch mode processing', 'Perfect for aggregations'],
          cons: ['Slower single-row lookups', 'Update performance impact', 'Memory intensive'],
          useCase: 'Data warehouse fact tables, analytics, reporting queries with SUM/AVG/COUNT'
        }
      ];

      // Snowflake "Indexing" (actually optimization strategies)
      const snowflakeStrategies = [
        {
          id: 'clustering',
          title: 'Clustering Keys',
          icon: '≡ƒÄ»',
          description: 'Snowflake\'s alternative to indexes. Co-locates related data in micro-partitions.',
          syntax: `-- Add clustering key
ALTER TABLE marts.fct_sales
CLUSTER BY (order_date, region);

-- Check clustering depth (lower = better)
SELECT SYSTEM$CLUSTERING_INFORMATION(
  'marts.fct_sales', '(order_date, region)'
);

-- Monitor automatic reclustering
SELECT * FROM TABLE(INFORMATION_SCHEMA.AUTOMATIC_CLUSTERING_HISTORY(
  DATE_RANGE_START => DATEADD('day', -7, CURRENT_DATE())
));`,
          impact: 'Can reduce scan by 90%+',
          bestFor: 'Large tables (1TB+) with consistent filter patterns'
        },
        {
          id: 'search_optimization',
          title: 'Search Optimization Service',
          icon: '≡ƒöÄ',
          description: 'Serverless feature for point lookups. Like a hash index. Great for selective queries.',
          syntax: `-- Enable search optimization
ALTER TABLE dim_customer
ADD SEARCH OPTIMIZATION;

-- Enable for specific columns
ALTER TABLE dim_customer ADD SEARCH OPTIMIZATION
ON EQUALITY(customer_id, email);

-- Check status
SHOW TABLES LIKE 'dim_customer';
-- Look for SEARCH_OPTIMIZATION = ON`,
          impact: 'Dramatically faster point lookups',
          bestFor: 'Equality predicates (=), high-cardinality columns, VARIANT/OBJECT types'
        },
        {
          id: 'materialized_views',
          title: 'Materialized Views',
          icon: '≡ƒôï',
          description: 'Pre-computed results. Like a covering index for complex aggregations.',
          syntax: `-- Create materialized view
CREATE MATERIALIZED VIEW mv_daily_sales AS
SELECT 
  order_date,
  region,
  SUM(amount) AS total_amount,
  COUNT(*) AS order_count
GROUP BY order_date, region;

-- Query automatically uses MV
SELECT * FROM fct_sales  -- Snowflake may use MV!
WHERE order_date = '2024-01-15';`,
          impact: 'Pre-aggregated = instant results',
          bestFor: 'Repeated aggregation patterns, dashboard queries'
        },
        {
          id: 'query_acceleration',
          title: 'Query Acceleration Service',
          icon: 'ΓÜí',
          description: 'Serverless compute for ad-hoc analytical queries. Offloads scanning work.',
          syntax: `-- Enable at warehouse level
ALTER WAREHOUSE analytics_wh SET
  ENABLE_QUERY_ACCELERATION = TRUE
  QUERY_ACCELERATION_MAX_SCALE_FACTOR = 8;

-- Check if query was accelerated
SELECT query_id, 
       query_acceleration_bytes_scanned,
       query_acceleration_partitions_scanned
WHERE query_acceleration_bytes_scanned > 0;`,
          impact: 'Faster ad-hoc queries',
          bestFor: 'Large scans, unpredictable workloads, BI tool queries'
        }
      ];

      const getColorClasses = (color: string) => {
        const colors: Record<string, { bg: string; border: string; text: string }> = {
          green: { bg: 'bg-green-500/20', border: 'border-green-500', text: 'text-green-400' },
          blue: { bg: 'bg-blue-500/20', border: 'border-blue-500', text: 'text-blue-400' },
          orange: { bg: 'bg-orange-500/20', border: 'border-orange-500', text: 'text-orange-400' },
          cyan: { bg: 'bg-cyan-500/20', border: 'border-cyan-500', text: 'text-cyan-400' },
          purple: { bg: 'bg-purple-500/20', border: 'border-purple-500', text: 'text-purple-400' },
        };
        return colors[color] || colors.green;
      };

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-2xl">
                ≡ƒôè
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">
                  Indexing Strategy Simulator
                </h1>
                <p className="text-xs text-slate-500">T-SQL Indexes ΓÇó Snowflake Optimization</p>
              </div>
            </div>
          </header>

          {/* Tab Navigation */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-3">
            <div className="flex gap-2 justify-center">
              {[
                { id: 'tsql', label: 'T-SQL Indexes', icon: '≡ƒùä∩╕Å' },
                { id: 'snowflake', label: 'Snowflake Optimization', icon: 'Γ¥ä∩╕Å' },
                { id: 'comparison', label: 'Side-by-Side', icon: 'ΓÜû∩╕Å' },
                { id: 'finops', label: 'FinOps Control Center', icon: '≡ƒÆ░' },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2 ${activeTab === tab.id
                      ? 'bg-green-600 text-white shadow-lg shadow-green-500/30'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                >
                  <span>{tab.icon}</span>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 overflow-hidden">

            {/* T-SQL TAB */}
            {activeTab === 'tsql' && (
              <div className="h-full flex">
                {/* Left: Interactive Demo */}
                <div className="w-1/2 border-r border-slate-800 p-6 overflow-y-auto">
                  <h3 className="text-lg font-bold text-white mb-4">≡ƒÄ« Interactive B-Tree Search</h3>

                  {/* Index Type Selector */}
                  <div className="flex gap-2 mb-4 flex-wrap">
                    {[
                      { id: 'heap', label: 'Heap (No Index)', color: 'red' },
                      { id: 'clustered', label: 'Clustered', color: 'green' },
                      { id: 'nonclustered', label: 'Non-Clustered', color: 'blue' },
                      { id: 'covering', label: 'Covering', color: 'purple' },
                    ].map(type => (
                      <button
                        key={type.id}
                        onClick={() => { setIndexType(type.id as any); setSearchSteps([]); setSearchId(null); }}
                        className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition ${indexType === type.id
                            ? type.color === 'red' ? 'bg-red-600 text-white' :
                              type.color === 'green' ? 'bg-green-600 text-white' :
                                type.color === 'blue' ? 'bg-blue-600 text-white' :
                                  'bg-purple-600 text-white'
                            : 'bg-slate-800 text-slate-400'
                          }`}
                      >
                        {type.label}
                      </button>
                    ))}
                  </div>

                  {/* B-Tree Visualization */}
                  {indexType !== 'heap' && (
                    <div className="bg-slate-900 rounded-xl p-4 mb-4 border border-slate-700">
                      <div className="text-xs text-slate-500 uppercase mb-3">B-Tree Structure</div>
                      <div className="flex flex-col items-center gap-4">
                        {/* Root */}
                        <div className={`px-4 py-2 rounded-lg border-2 ${searchSteps.some(s => s.includes('ROOT')) ? 'border-green-500 bg-green-900/30' : 'border-slate-600 bg-slate-800'
                          }`}>
                          <span className="mono text-sm">[5 | 13]</span>
                        </div>
                        {/* Branches */}
                        <div className="flex items-center gap-2 text-slate-600">
                          <span>ΓåÖ</span><span>Γåô</span><span>Γåÿ</span>
                        </div>
                        {/* Leaves */}
                        <div className="flex gap-4">
                          {[
                            { keys: '[1,2,3]', highlight: searchId !== null && searchId < 5 },
                            { keys: '[5,8,9]', highlight: searchId !== null && searchId >= 5 && searchId < 13 },
                            { keys: '[13,21]', highlight: searchId !== null && searchId >= 13 },
                          ].map((leaf, idx) => (
                            <div key={idx} className={`px-3 py-2 rounded-lg border-2 ${leaf.highlight && searchSteps.length > 2 ? 'border-green-500 bg-green-900/30' : 'border-slate-600 bg-slate-800'
                              }`}>
                              <span className="mono text-xs">{leaf.keys}</span>
                              {indexType === 'clustered' && (
                                <div className="text-[10px] text-slate-500 mt-1">+ Data</div>
                              )}
                              {indexType === 'nonclustered' && (
                                <div className="text-[10px] text-slate-500 mt-1">ΓåÆ RID</div>
                              )}
                              {indexType === 'covering' && (
                                <div className="text-[10px] text-purple-400 mt-1">+ INCLUDE</div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Heap Visualization */}
                  {indexType === 'heap' && (
                    <div className="bg-slate-900 rounded-xl p-4 mb-4 border border-slate-700">
                      <div className="text-xs text-slate-500 uppercase mb-3">Heap (Unsorted Data Pages)</div>
                      <div className="grid grid-cols-4 gap-2">
                        {sampleData.map((row, idx) => (
                          <div key={row.id} className={`p-2 rounded border text-xs ${searchSteps.some(s => s.includes(`ID = ${row.id}`) && s.includes('FOUND'))
                              ? 'border-green-500 bg-green-900/30'
                              : searchSteps.some(s => s.includes(`ID = ${row.id}`))
                                ? 'border-yellow-500 bg-yellow-900/20'
                                : 'border-slate-700 bg-slate-800'
                            }`}>
                            <div className="text-slate-400">ID: {row.id}</div>
                            <div className="text-white truncate">{row.name}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Search Demo */}
                  <div className="bg-slate-800 rounded-xl p-4 mb-4">
                    <div className="text-xs text-slate-500 uppercase mb-3">Search for Part ID</div>
                    <div className="flex gap-2 flex-wrap">
                      {[1, 3, 5, 8, 13, 21, 99].map(id => (
                        <button
                          key={id}
                          onClick={() => simulateSearch(id)}
                          disabled={isSearching}
                          className={`px-3 py-1.5 rounded-lg text-sm font-mono transition ${searchId === id ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                            }`}
                        >
                          {id}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Search Steps */}
                  {searchSteps.length > 0 && (
                    <div className="bg-slate-900 rounded-xl p-4 border border-slate-700">
                      <div className="text-xs text-slate-500 uppercase mb-3">Execution Steps</div>
                      <div className="space-y-1 mono text-xs">
                        {searchSteps.map((step, idx) => (
                          <div key={idx} className={`py-1 animate-slide ${step.includes('Γ£ô') ? 'text-green-400' :
                              step.includes('Γ£ù') ? 'text-red-400' :
                                step.includes('Complexity') ? 'text-cyan-400 font-bold' :
                                  'text-slate-400'
                            }`}>
                            {step}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Right: Index Types Reference */}
                <div className="w-1/2 p-6 overflow-y-auto">
                  <h3 className="text-lg font-bold text-white mb-4">≡ƒôÜ T-SQL Index Types</h3>
                  <div className="space-y-4">
                    {tsqlIndexTypes.map(idx => (
                      <div key={idx.id} className="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden">
                        <div className="bg-slate-800 p-3 border-b border-slate-700 flex items-center gap-3">
                          <span className="text-xl">{idx.icon}</span>
                          <div>
                            <h4 className="font-bold text-white">{idx.title}</h4>
                            <p className="text-xs text-slate-400">{idx.description}</p>
                          </div>
                        </div>
                        <div className="p-3">
                          <div className="bg-slate-950 rounded-lg p-3 mb-3 overflow-x-auto">
                            <pre className="text-[11px] mono text-slate-400 whitespace-pre-wrap">{idx.syntax}</pre>
                          </div>
                          <div className="grid grid-cols-2 gap-3 mb-2">
                            <div>
                              <div className="text-[10px] font-bold text-green-400 mb-1">Γ£ô Pros</div>
                              <ul className="text-[10px] text-slate-400 space-y-0.5">
                                {idx.pros.map((p, i) => <li key={i}>ΓÇó {p}</li>)}
                              </ul>
                            </div>
                            <div>
                              <div className="text-[10px] font-bold text-red-400 mb-1">Γ£ù Cons</div>
                              <ul className="text-[10px] text-slate-400 space-y-0.5">
                                {idx.cons.map((c, i) => <li key={i}>ΓÇó {c}</li>)}
                              </ul>
                            </div>
                          </div>
                          <div className="text-[10px] text-cyan-400">
                            <span className="font-bold text-slate-500">USE CASE: </span>{idx.useCase}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* SNOWFLAKE TAB - Enhanced with Interactive Clustering Visualization */}
            {activeTab === 'snowflake' && (
              <SnowflakeClusteringViz />
            )}

            {/* COMPARISON TAB */}
            {activeTab === 'comparison' && (
              <div className="h-full p-6 overflow-y-auto">
                <div className="max-w-5xl mx-auto">
                  <h3 className="text-lg font-bold text-white mb-6 text-center">ΓÜû∩╕Å T-SQL vs Snowflake: Index Strategy Comparison</h3>

                  <table className="w-full text-sm">
                    <thead>
                      <tr className="bg-slate-800">
                        <th className="p-3 text-left text-slate-400">Concept</th>
                        <th className="p-3 text-left text-blue-400">≡ƒùä∩╕Å T-SQL (SQL Server)</th>
                        <th className="p-3 text-left text-cyan-400">Γ¥ä∩╕Å Snowflake</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-800">
                      <tr>
                        <td className="p-3 font-semibold text-white">Primary Index</td>
                        <td className="p-3 text-slate-300">Clustered Index (B-Tree)</td>
                        <td className="p-3 text-slate-300">Clustering Key (not an index!)</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Secondary Index</td>
                        <td className="p-3 text-slate-300">Non-Clustered Index</td>
                        <td className="p-3 text-slate-300">Search Optimization Service</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Point Lookup</td>
                        <td className="p-3 text-slate-300">Index Seek O(log n)</td>
                        <td className="p-3 text-slate-300">Search Optimization or Pruning</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Range Scan</td>
                        <td className="p-3 text-slate-300">Index Range Scan</td>
                        <td className="p-3 text-slate-300">Partition Pruning via Zone Maps</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Analytics/Agg</td>
                        <td className="p-3 text-slate-300">Columnstore Index</td>
                        <td className="p-3 text-slate-300">Native columnar (always!)</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Pre-computed</td>
                        <td className="p-3 text-slate-300">Indexed View</td>
                        <td className="p-3 text-slate-300">Materialized View</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Maintenance</td>
                        <td className="p-3 text-slate-300">REBUILD / REORGANIZE</td>
                        <td className="p-3 text-slate-300">Automatic Reclustering</td>
                      </tr>
                      <tr>
                        <td className="p-3 font-semibold text-white">Statistics</td>
                        <td className="p-3 text-slate-300">UPDATE STATISTICS</td>
                        <td className="p-3 text-slate-300">Automatic (Cloud Services)</td>
                      </tr>
                    </tbody>
                  </table>

                  {/* Interview Tips */}
                  <div className="mt-6 bg-green-900/20 border border-green-500/30 rounded-xl p-4">
                    <h4 className="text-green-400 font-bold mb-3">≡ƒÄ» Interview Tips</h4>
                    <ul className="text-sm text-slate-300 space-y-2">
                      <li>ΓÇó <strong>T-SQL:</strong> Know when to use Clustered vs Non-Clustered. Covering indexes eliminate Key Lookups.</li>
                      <li>ΓÇó <strong>Snowflake:</strong> Emphasize "no traditional indexes" - it's columnar storage with micro-partitions.</li>
                      <li>ΓÇó <strong>Key difference:</strong> T-SQL = you create indexes. Snowflake = you guide the optimizer with clustering keys.</li>
                      <li>ΓÇó <strong>Migration tip:</strong> T-SQL columnstore ΓåÆ Snowflake is natural fit. Regular indexes don't migrate.</li>
                      <li>ΓÇó <strong>Your VPI context:</strong> Mention Dynamic Tables + Clustering for your near real-time reporting solution!</li>
                    </ul>
                  </div>
                </div>
              </div>
            )}

            {/* FINOPS CONTROL CENTER TAB */}
            {activeTab === 'finops' && (
              <FinOpsControlCenter />
            )}
          </div>
        </div>
      );
    };

    // ============================================================================
    // FINOPS CONTROL CENTER - Comprehensive Cost Simulation
    // ============================================================================
    const FinOpsControlCenter = () => {
      // Cost Engine State
      const [warehouseSize, setWarehouseSize] = useState(1); // $/hr
      const [isProcessing, setIsProcessing] = useState(false);
      const [isIdleBilling, setIsIdleBilling] = useState(false);
      const [cost, setCost] = useState(0);
      const [elapsedTime, setElapsedTime] = useState(0);
      const [processedRows, setProcessedRows] = useState(0);

      // Power BI State
      const [biMode, setBiMode] = useState < 'import' | 'directquery' > ('import');
      const [biRefreshCost, setBiRefreshCost] = useState(0);
      const [showLaserBeam, setShowLaserBeam] = useState(false);
      const [warehouseWoken, setWarehouseWoken] = useState(false);

      // Budget & Serverless
      const [maxBudget, setMaxBudget] = useState(10);
      const [budgetExceeded, setBudgetExceeded] = useState(false);
      const [serverlessMode, setServerlessMode] = useState(false);

      // Algorithm comparison
      const [selectedAlgorithm, setSelectedAlgorithm] = useState < 'hash' | 'bruteforce' > ('hash');

      const warehouseSizes = [
        { name: 'X-Small', rate: 1, icon: '≡ƒö╣' },
        { name: 'Small', rate: 2, icon: '≡ƒö╕' },
        { name: 'Medium', rate: 4, icon: '≡ƒƒí' },
        { name: 'Large', rate: 8, icon: '≡ƒƒá' },
        { name: 'X-Large', rate: 16, icon: '≡ƒö┤' },
        { name: '2X-Large', rate: 32, icon: '≡ƒƒú' },
        { name: '3X-Large', rate: 64, icon: 'ΓÜ½' },
        { name: '4X-Large', rate: 128, icon: '≡ƒÆÄ' },
      ];

      const currentWH = warehouseSizes.find(w => w.rate === warehouseSize) || warehouseSizes[0];

      // Real-time cost ticker
      useEffect(() => {
        let interval: NodeJS.Timeout;
        if (isProcessing || isIdleBilling) {
          interval = setInterval(() => {
            const rate = serverlessMode ? warehouseSize * 1.25 : warehouseSize;
            const increment = rate / 3600; // Per-second cost
            setCost(prev => {
              const newCost = prev + increment;
              if (newCost > maxBudget && !budgetExceeded) {
                setBudgetExceeded(true);
              }
              return newCost;
            });
            setElapsedTime(prev => prev + 1);
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [isProcessing, isIdleBilling, warehouseSize, maxBudget, budgetExceeded, serverlessMode]);

      // Run processing simulation
      const runProcessing = () => {
        setIsProcessing(true);
        setCost(0);
        setElapsedTime(0);
        setProcessedRows(0);
        setBudgetExceeded(false);
        setIsIdleBilling(false);

        const duration = selectedAlgorithm === 'hash' ? 5 : 15; // seconds
        const totalRows = 1000000;
        let currentRow = 0;

        const rowInterval = setInterval(() => {
          currentRow += totalRows / (duration * 10);
          setProcessedRows(Math.min(currentRow, totalRows));
        }, 100);

        setTimeout(() => {
          clearInterval(rowInterval);
          setProcessedRows(totalRows);
          setIsProcessing(false);

          // Start idle billing (unless serverless)
          if (!serverlessMode) {
            setIsIdleBilling(true);
            setTimeout(() => {
              setIsIdleBilling(false);
            }, 5000); // 5 seconds of idle billing
          }
        }, duration * 1000);
      };

      // Power BI DirectQuery simulation
      const simulateDashboardClicks = () => {
        setShowLaserBeam(true);
        setWarehouseWoken(true);

        // Spike the cost
        const clickCost = (warehouseSize / 3600) * 50; // 50 seconds worth of compute
        setCost(prev => prev + clickCost);
        setBiRefreshCost(prev => prev + clickCost);

        setTimeout(() => setShowLaserBeam(false), 2000);
        setTimeout(() => setWarehouseWoken(false), 5000);
      };

      // Import mode refresh
      const runImportRefresh = () => {
        const refreshCost = 0.25; // One-time small cost
        setBiRefreshCost(prev => prev + refreshCost);
        setCost(prev => prev + refreshCost);
      };

      // Calculate algorithm costs for 1TB data
      const hashCost = (2.50).toFixed(2);
      const bruteForceCost = (450.00).toFixed(2);

      const reset = () => {
        setCost(0);
        setElapsedTime(0);
        setProcessedRows(0);
        setIsProcessing(false);
        setIsIdleBilling(false);
        setBudgetExceeded(false);
        setBiRefreshCost(0);
        setWarehouseWoken(false);
      };

      return (
        <div className={`h-full p-6 overflow-y-auto transition-all ${budgetExceeded ? 'ring-4 ring-red-500 animate-pulse' : ''
          }`}>
          <div className="max-w-6xl mx-auto">

            {/* Budget Alert */}
            {budgetExceeded && (
              <div className="mb-6 p-4 bg-red-900/50 border-2 border-red-500 rounded-xl animate-pulse">
                <div className="flex items-center gap-3">
                  <span className="text-4xl">ΓÜá∩╕Å</span>
                  <div>
                    <div className="text-red-400 font-bold text-xl">BUDGET EXCEEDED: FinOps Alert!</div>
                    <div className="text-slate-300">Current spend ${cost.toFixed(4)} exceeds budget ${maxBudget.toFixed(2)}</div>
                  </div>
                </div>
              </div>
            )}

            <div className="grid grid-cols-2 gap-6">

              {/* LEFT COLUMN: Cost Engine */}
              <div>
                {/* Taxi Meter Cost Engine */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
                  <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    ≡ƒÜò Real-Time Taxi Meter
                  </h3>

                  {/* Warehouse Size Selector */}
                  <div className="mb-4">
                    <label className="text-xs text-slate-500 uppercase block mb-2">Warehouse Size</label>
                    <select
                      value={warehouseSize}
                      onChange={(e) => setWarehouseSize(parseInt(e.target.value))}
                      className="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white"
                      disabled={isProcessing}
                    >
                      {warehouseSizes.map(wh => (
                        <option key={wh.rate} value={wh.rate}>
                          {wh.icon} {wh.name} - ${wh.rate}/hr
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Algorithm Selector */}
                  <div className="mb-4">
                    <label className="text-xs text-slate-500 uppercase block mb-2">Query Algorithm</label>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setSelectedAlgorithm('hash')}
                        className={`flex-1 p-3 rounded-lg font-semibold transition ${selectedAlgorithm === 'hash'
                            ? 'bg-green-600 text-white'
                            : 'bg-slate-800 text-slate-400'
                          }`}
                      >
                        O(N) Hash Join
                      </button>
                      <button
                        onClick={() => setSelectedAlgorithm('bruteforce')}
                        className={`flex-1 p-3 rounded-lg font-semibold transition ${selectedAlgorithm === 'bruteforce'
                            ? 'bg-red-600 text-white'
                            : 'bg-slate-800 text-slate-400'
                          }`}
                      >
                        O(N┬▓) Brute Force
                      </button>
                    </div>
                  </div>

                  {/* Serverless Toggle */}
                  <div className="flex items-center justify-between mb-4 p-3 bg-slate-800 rounded-lg">
                    <div>
                      <div className="text-sm text-white font-semibold">Snowpipe Mode (Serverless)</div>
                      <div className="text-xs text-slate-500">No idle billing, 1.25x rate</div>
                    </div>
                    <button
                      onClick={() => setServerlessMode(!serverlessMode)}
                      className={`w-12 h-6 rounded-full transition-all ${serverlessMode ? 'bg-cyan-600' : 'bg-slate-700'}`}
                    >
                      <div className={`w-5 h-5 rounded-full bg-white shadow transition-all ${serverlessMode ? 'translate-x-6' : 'translate-x-0.5'}`} />
                    </button>
                  </div>

                  {/* Big Cost Display */}
                  <div className={`text-center p-6 rounded-xl mb-4 transition-all ${isIdleBilling ? 'bg-red-900/30 border-2 border-red-500' :
                      isProcessing ? 'bg-green-900/30 border-2 border-green-500' :
                        'bg-slate-800 border-2 border-slate-700'
                    }`}>
                    <div className="text-xs text-slate-500 uppercase mb-1">
                      {isIdleBilling ? '≡ƒö┤ IDLE TIME BILLING (WASTE)' :
                        isProcessing ? '≡ƒƒó PROCESSING' : 'WAITING'}
                    </div>
                    <div className={`text-5xl font-bold font-mono ${budgetExceeded ? 'text-red-400' :
                        isIdleBilling ? 'text-red-400' :
                          'text-emerald-400'
                      }`}>
                      ${cost.toFixed(4)}
                    </div>
                    <div className="text-sm text-slate-400 mt-2">
                      {elapsedTime}s elapsed ΓÇó {currentWH.name} @ ${warehouseSize}/hr
                      {serverlessMode && <span className="text-cyan-400 ml-2">ΓÜí Serverless 1.25x</span>}
                    </div>
                  </div>

                  {/* Progress */}
                  {(isProcessing || processedRows > 0) && (
                    <div className="mb-4">
                      <div className="flex justify-between text-xs text-slate-500 mb-1">
                        <span>Rows Processed</span>
                        <span>{(processedRows / 1000000 * 100).toFixed(0)}%</span>
                      </div>
                      <div className="h-3 bg-slate-800 rounded-full overflow-hidden">
                        <div
                          className={`h-full transition-all ${selectedAlgorithm === 'hash' ? 'bg-green-500' : 'bg-red-500'
                            }`}
                          style={{ width: `${(processedRows / 1000000) * 100}%` }}
                        />
                      </div>
                    </div>
                  )}

                  {/* Run Button */}
                  <div className="flex gap-2">
                    <button
                      onClick={runProcessing}
                      disabled={isProcessing || isIdleBilling}
                      className={`flex-1 py-3 rounded-lg font-bold transition ${isProcessing || isIdleBilling ? 'bg-yellow-600 animate-pulse' : 'bg-emerald-600 hover:bg-emerald-500'
                        } text-white`}
                    >
                      {isProcessing ? 'ΓÜÖ∩╕Å Processing...' : isIdleBilling ? '≡ƒÆñ Idle Billing...' : 'Γû╢ Run Query'}
                    </button>
                    <button
                      onClick={reset}
                      className="px-4 py-3 rounded-lg font-bold bg-slate-700 hover:bg-slate-600 text-white"
                    >
                      Reset
                    </button>
                  </div>
                </div>

                {/* Budget Control */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-4">
                  <h4 className="text-sm font-bold text-white mb-3">≡ƒÆ╡ Budget Cap</h4>
                  <div className="flex items-center gap-4">
                    <input
                      type="number"
                      value={maxBudget}
                      onChange={(e) => setMaxBudget(parseFloat(e.target.value) || 0)}
                      className="w-24 p-2 bg-slate-800 border border-slate-600 rounded-lg text-white text-center"
                      step="0.5"
                      min="0"
                    />
                    <span className="text-slate-400">Max Budget ($)</span>
                    <div className={`ml-auto px-3 py-1 rounded-lg text-sm font-bold ${cost > maxBudget ? 'bg-red-600 text-white' :
                        cost > maxBudget * 0.8 ? 'bg-yellow-600 text-white' :
                          'bg-green-600 text-white'
                      }`}>
                      {((cost / maxBudget) * 100).toFixed(0)}% used
                    </div>
                  </div>
                </div>
              </div>

              {/* RIGHT COLUMN: Power BI & Algorithm Costs */}
              <div>
                {/* Power BI Simulator */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
                  <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    ≡ƒôè Power BI Connection Mode
                  </h3>

                  {/* Mode Toggle */}
                  <div className="flex gap-2 mb-4">
                    <button
                      onClick={() => setBiMode('import')}
                      className={`flex-1 p-3 rounded-lg font-semibold transition ${biMode === 'import'
                          ? 'bg-green-600 text-white'
                          : 'bg-slate-800 text-slate-400'
                        }`}
                    >
                      ≡ƒôÑ Import Mode
                    </button>
                    <button
                      onClick={() => setBiMode('directquery')}
                      className={`flex-1 p-3 rounded-lg font-semibold transition ${biMode === 'directquery'
                          ? 'bg-orange-600 text-white'
                          : 'bg-slate-800 text-slate-400'
                        }`}
                    >
                      ΓÜí DirectQuery
                    </button>
                  </div>

                  {/* Visual */}
                  <div className="relative bg-slate-800 rounded-xl p-6 mb-4">
                    <div className="flex items-center justify-around">
                      {/* Power BI Icon */}
                      <div className={`w-20 h-20 rounded-xl flex items-center justify-center transition-all ${biMode === 'import' ? 'bg-green-900/50 border-2 border-green-500' : 'bg-orange-900/50 border-2 border-orange-500'
                        }`}>
                        <span className="text-3xl">≡ƒôè</span>
                        {biMode === 'import' && (
                          <div className="absolute -bottom-2 text-xs bg-green-600 px-2 rounded text-white">VertiPaq</div>
                        )}
                      </div>

                      {/* Laser Beam */}
                      {showLaserBeam && (
                        <div className="absolute left-1/4 right-1/4 h-1 bg-gradient-to-r from-orange-500 via-yellow-500 to-cyan-500 animate-pulse rounded" />
                      )}

                      {/* Arrow */}
                      <div className="text-2xl text-slate-600">
                        {biMode === 'directquery' ? 'ΓÜíΓåÆ' : '≡ƒôª'}
                      </div>

                      {/* Snowflake Icon */}
                      <div className={`w-20 h-20 rounded-xl flex items-center justify-center transition-all ${warehouseWoken
                          ? 'bg-red-900/50 border-2 border-red-500 animate-pulse shadow-lg shadow-red-500/30'
                          : 'bg-cyan-900/50 border-2 border-cyan-500'
                        }`}>
                        <span className="text-3xl">Γ¥ä∩╕Å</span>
                      </div>
                    </div>

                    {/* Warehouse Woken Alert */}
                    {warehouseWoken && (
                      <div className="mt-4 p-2 bg-red-900/30 border border-red-500/50 rounded-lg text-center text-red-400 text-sm animate-pulse">
                        ΓÜá∩╕Å Warehouse Woken Up by BI User!
                      </div>
                    )}
                  </div>

                  {/* Actions based on mode */}
                  {biMode === 'import' ? (
                    <div>
                      <button
                        onClick={runImportRefresh}
                        className="w-full py-3 rounded-lg font-bold bg-green-600 hover:bg-green-500 text-white mb-2"
                      >
                        ≡ƒöä Run Data Refresh (One-time cost)
                      </button>
                      <div className="text-xs text-slate-500 text-center">
                        Cost: $0.25 per refresh ΓÇó User clicks = FREE (local VertiPaq)
                      </div>
                    </div>
                  ) : (
                    <div>
                      <button
                        onClick={simulateDashboardClicks}
                        className="w-full py-3 rounded-lg font-bold bg-orange-600 hover:bg-orange-500 text-white mb-2"
                      >
                        ≡ƒû▒∩╕Å Simulate 50 User Dashboard Clicks
                      </button>
                      <div className="text-xs text-slate-500 text-center">
                        Each click = Query to Snowflake = Warehouse wake-up!
                      </div>
                    </div>
                  )}

                  {/* BI Cost Display */}
                  <div className="mt-4 p-3 bg-slate-800 rounded-lg flex justify-between">
                    <span className="text-slate-400">BI-Related Costs:</span>
                    <span className={`font-bold ${biRefreshCost > 1 ? 'text-red-400' : 'text-green-400'}`}>
                      ${biRefreshCost.toFixed(4)}
                    </span>
                  </div>
                </div>

                {/* O(N) vs O(N┬▓) Financial Impact */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-6">
                  <h3 className="text-lg font-bold text-white mb-4">≡ƒôê Algorithm Cost Impact (1TB Data)</h3>

                  <div className="grid grid-cols-2 gap-4">
                    {/* Good Code */}
                    <div className="p-4 rounded-xl bg-green-900/20 border-2 border-green-500">
                      <div className="text-xs text-green-400 uppercase mb-1">Good Code (Hashing)</div>
                      <div className="text-xs text-slate-500 mb-2">O(N) ΓÇó Linear Time</div>
                      <div className="text-4xl font-bold text-green-400">${hashCost}</div>
                      <div className="mt-2 text-xs text-slate-400">
                        ~5 min on X-Large
                      </div>
                    </div>

                    {/* Bad Code */}
                    <div className="p-4 rounded-xl bg-red-900/20 border-2 border-red-500">
                      <div className="text-xs text-red-400 uppercase mb-1">Bad Code (Brute Force)</div>
                      <div className="text-xs text-slate-500 mb-2">O(N┬▓) ΓÇó Quadratic Time</div>
                      <div className="text-4xl font-bold text-red-400">${bruteForceCost}</div>
                      <div className="mt-2 text-xs text-slate-400">
                        ~6 hrs on X-Large
                      </div>
                    </div>
                  </div>

                  {/* Comparison */}
                  <div className="mt-4 p-4 bg-yellow-900/20 border border-yellow-500/30 rounded-xl">
                    <div className="text-center">
                      <span className="text-yellow-400 font-bold">≡ƒÆ╕ Bad code costs </span>
                      <span className="text-3xl font-bold text-yellow-400">180x</span>
                      <span className="text-yellow-400 font-bold"> more!</span>
                    </div>
                    <div className="text-xs text-slate-400 text-center mt-2">
                      At scale, algorithm choice is a FinOps decision!
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Interview Tips */}
            <div className="mt-6 bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-5">
              <h4 className="text-emerald-400 font-bold mb-3">≡ƒÄ» FinOps Interview Talking Points</h4>
              <ul className="text-sm text-slate-300 space-y-2 grid grid-cols-2 gap-4">
                <li>ΓÇó <strong>Auto-Suspend:</strong> Always set 60s or less. Idle billing is pure waste.</li>
                <li>ΓÇó <strong>Serverless:</strong> 1.25x rate but $0 idle. Good for sporadic workloads.</li>
                <li>ΓÇó <strong>Power BI Import:</strong> One-time refresh cost, unlimited user queries.</li>
                <li>ΓÇó <strong>DirectQuery:</strong> Real-time but each click = warehouse wake-up cost.</li>
                <li>ΓÇó <strong>O(N) vs O(N┬▓):</strong> Code review isn't just about quality - it's FinOps!</li>
                <li>ΓÇó <strong>VPI Context:</strong> Use Import for dashboards, DirectQuery only for real-time KPIs.</li>
              </ul>
            </div>
          </div>
        </div>
      );
    };

    const PruningSimulator = ({ onBack }: { onBack: () => void }) => {
      const [queryDate, setQueryDate] = useState('2024-01-15');
      const [isScanning, setIsScanning] = useState(false);
      const [scanComplete, setScanComplete] = useState(false);
      const [currentScanIndex, setCurrentScanIndex] = useState(-1);
      const [queryType, setQueryType] = useState < 'equals' | 'range' | 'between' > ('equals');
      const [rangeStart, setRangeStart] = useState('2024-01-15');
      const [rangeEnd, setRangeEnd] = useState('2024-02-05');

      // Micro-partition data with zone maps
      const partitions = [
        { id: 1, minDate: '2024-01-01', maxDate: '2024-01-10', rows: 1000000, label: 'Jan 1-10' },
        { id: 2, minDate: '2024-01-11', maxDate: '2024-01-20', rows: 1000000, label: 'Jan 11-20' },
        { id: 3, minDate: '2024-01-21', maxDate: '2024-01-31', rows: 1200000, label: 'Jan 21-31' },
        { id: 4, minDate: '2024-02-01', maxDate: '2024-02-10', rows: 900000, label: 'Feb 1-10' },
        { id: 5, minDate: '2024-02-11', maxDate: '2024-02-20', rows: 1100000, label: 'Feb 11-20' },
      ];

      // Check if date falls within partition range
      const isDateInRange = (partitionMin: string, partitionMax: string) => {
        if (queryType === 'equals') {
          return queryDate >= partitionMin && queryDate <= partitionMax;
        } else if (queryType === 'range') {
          // WHERE date >= rangeStart
          return partitionMax >= rangeStart;
        } else {
          // BETWEEN rangeStart AND rangeEnd
          return partitionMax >= rangeStart && partitionMin <= rangeEnd;
        }
      };

      // Calculate statistics
      const getStats = () => {
        const scanned = partitions.filter(p => isDateInRange(p.minDate, p.maxDate));
        const pruned = partitions.filter(p => !isDateInRange(p.minDate, p.maxDate));
        const totalRows = partitions.reduce((sum, p) => sum + p.rows, 0);
        const scannedRows = scanned.reduce((sum, p) => sum + p.rows, 0);
        const prunedRows = pruned.reduce((sum, p) => sum + p.rows, 0);

        return {
          scannedCount: scanned.length,
          prunedCount: pruned.length,
          totalRows,
          scannedRows,
          prunedRows,
          efficiency: totalRows > 0 ? Math.round((prunedRows / totalRows) * 100) : 0
        };
      };

      const stats = getStats();

      // Run the scanning animation
      const runQuery = () => {
        setIsScanning(true);
        setScanComplete(false);
        setCurrentScanIndex(-1);

        // Animate through each partition
        partitions.forEach((_, idx) => {
          setTimeout(() => {
            setCurrentScanIndex(idx);
            if (idx === partitions.length - 1) {
              setTimeout(() => {
                setIsScanning(false);
                setScanComplete(true);
              }, 400);
            }
          }, idx * 400);
        });
      };

      const resetQuery = () => {
        setScanComplete(false);
        setCurrentScanIndex(-1);
      };

      // Format row count
      const formatRows = (rows: number) => {
        if (rows >= 1000000) return `${(rows / 1000000).toFixed(1)}M`;
        if (rows >= 1000) return `${(rows / 1000).toFixed(0)}K`;
        return rows.toString();
      };

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
          if (e.key === 'Enter' && !isScanning) runQuery();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [isScanning]);

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-2xl">
                Γ¥ä∩╕Å
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                  Partition Pruning Simulator
                </h1>
                <p className="text-xs text-slate-500">Zone Maps ΓÇó Micro-Partitions ΓÇó Query Optimization</p>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <div className="flex-1 overflow-y-auto p-6">
            <div className="max-w-6xl mx-auto">

              {/* Concept Explanation */}
              <div className="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 border border-blue-500/30 rounded-xl p-5 mb-6">
                <h3 className="text-lg font-bold text-white mb-2">≡ƒºá How Partition Pruning Works</h3>
                <p className="text-sm text-slate-300">
                  Snowflake stores data in <strong>micro-partitions</strong> (50-500MB each). Each partition has a <strong>zone map</strong> containing
                  MIN/MAX values for each column. When you query with a filter, Snowflake checks zone maps <em>first</em> and
                  <strong> skips (prunes)</strong> partitions that can't possibly contain matching data ΓÇö without ever reading the actual data!
                </p>
              </div>

              {/* Query Builder */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5 mb-6">
                <div className="flex items-center gap-2 mb-4">
                  <span className="text-lg">≡ƒöì</span>
                  <h3 className="font-bold text-white">Build Your Query</h3>
                </div>

                {/* Query Type Selector */}
                <div className="flex gap-2 mb-4">
                  {[
                    { id: 'equals', label: 'WHERE date = ?', icon: '=' },
                    { id: 'range', label: 'WHERE date >= ?', icon: 'ΓëÑ' },
                    { id: 'between', label: 'WHERE date BETWEEN ? AND ?', icon: 'Γåö' },
                  ].map(qt => (
                    <button
                      key={qt.id}
                      onClick={() => { setQueryType(qt.id as any); resetQuery(); }}
                      className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${queryType === qt.id
                          ? 'bg-blue-600 text-white'
                          : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                        }`}
                    >
                      <span className="mr-2">{qt.icon}</span>
                      {qt.label}
                    </button>
                  ))}
                </div>

                {/* Date Input(s) */}
                <div className="flex items-center gap-4 flex-wrap">
                  <div className="bg-slate-800 rounded-lg p-4 font-mono text-sm flex items-center gap-2">
                    <span className="text-purple-400">SELECT</span>
                    <span className="text-slate-300">*</span>
                    <span className="text-purple-400">FROM</span>
                    <span className="text-cyan-400">sales_data</span>
                    <span className="text-purple-400">WHERE</span>
                    <span className="text-yellow-400">order_date</span>

                    {queryType === 'equals' && (
                      <>
                        <span className="text-slate-300">=</span>
                        <input
                          type="date"
                          value={queryDate}
                          onChange={(e) => { setQueryDate(e.target.value); resetQuery(); }}
                          className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-green-400 font-mono"
                        />
                      </>
                    )}

                    {queryType === 'range' && (
                      <>
                        <span className="text-slate-300">ΓëÑ</span>
                        <input
                          type="date"
                          value={rangeStart}
                          onChange={(e) => { setRangeStart(e.target.value); resetQuery(); }}
                          className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-green-400 font-mono"
                        />
                      </>
                    )}

                    {queryType === 'between' && (
                      <>
                        <span className="text-purple-400">BETWEEN</span>
                        <input
                          type="date"
                          value={rangeStart}
                          onChange={(e) => { setRangeStart(e.target.value); resetQuery(); }}
                          className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-green-400 font-mono"
                        />
                        <span className="text-purple-400">AND</span>
                        <input
                          type="date"
                          value={rangeEnd}
                          onChange={(e) => { setRangeEnd(e.target.value); resetQuery(); }}
                          className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-green-400 font-mono"
                        />
                      </>
                    )}
                  </div>

                  <button
                    onClick={runQuery}
                    disabled={isScanning}
                    className={`px-6 py-3 rounded-lg font-bold transition flex items-center gap-2 ${isScanning
                        ? 'bg-yellow-600 text-white animate-pulse'
                        : 'bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-500/30'
                      }`}
                  >
                    {isScanning ? (
                      <>
                        <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        Scanning Zone Maps...
                      </>
                    ) : (
                      <>Γû╢ Run Query</>
                    )}
                  </button>
                </div>
              </div>

              {/* Partition Visualization */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <span className="text-lg">≡ƒôª</span>
                    <h3 className="font-bold text-white">Micro-Partitions (Zone Maps)</h3>
                  </div>
                  <div className="text-xs text-slate-500">
                    Total: {formatRows(stats.totalRows)} rows across {partitions.length} partitions
                  </div>
                </div>

                {/* Partitions Grid */}
                <div className="grid grid-cols-5 gap-4 mb-6">
                  {partitions.map((partition, idx) => {
                    const isInRange = isDateInRange(partition.minDate, partition.maxDate);
                    const isCurrentlyScanng = currentScanIndex === idx;
                    const hasBeenScanned = scanComplete || currentScanIndex > idx;

                    return (
                      <div
                        key={partition.id}
                        className={`relative rounded-xl border-2 p-4 transition-all duration-300 ${isCurrentlyScanng
                            ? 'border-yellow-400 bg-yellow-900/30 scale-105 shadow-lg shadow-yellow-500/30'
                            : hasBeenScanned
                              ? isInRange
                                ? 'border-green-500 bg-green-900/30 shadow-lg shadow-green-500/20'
                                : 'border-red-500/50 bg-red-900/20 opacity-50'
                              : 'border-slate-700 bg-slate-800/50'
                          }`}
                      >
                        {/* Scanning indicator */}
                        {isCurrentlyScanng && (
                          <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-500 text-slate-900 text-xs font-bold px-2 py-0.5 rounded animate-bounce">
                            ≡ƒöì CHECKING
                          </div>
                        )}

                        {/* Status badge */}
                        {hasBeenScanned && !isCurrentlyScanng && (
                          <div className={`absolute -top-3 left-1/2 -translate-x-1/2 text-xs font-bold px-2 py-0.5 rounded ${isInRange
                              ? 'bg-green-500 text-white'
                              : 'bg-red-500 text-white'
                            }`}>
                            {isInRange ? 'Γ£ô SCAN' : 'Γ£ù PRUNED'}
                          </div>
                        )}

                        {/* Partition Header */}
                        <div className="text-center mb-3">
                          <div className="text-xs text-slate-500 uppercase font-bold">Partition {partition.id}</div>
                          <div className="text-sm font-bold text-slate-300">{partition.label}</div>
                        </div>

                        {/* Zone Map */}
                        <div className="bg-slate-900/50 rounded-lg p-3 mb-3">
                          <div className="text-[10px] text-slate-500 uppercase font-bold mb-2 text-center">Zone Map</div>
                          <div className="space-y-1 text-xs">
                            <div className="flex justify-between">
                              <span className="text-slate-500">MIN:</span>
                              <span className={`font-mono ${hasBeenScanned && isInRange ? 'text-green-400' : 'text-slate-300'}`}>
                                {partition.minDate}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-500">MAX:</span>
                              <span className={`font-mono ${hasBeenScanned && isInRange ? 'text-green-400' : 'text-slate-300'}`}>
                                {partition.maxDate}
                              </span>
                            </div>
                          </div>
                        </div>

                        {/* Row Count */}
                        <div className="text-center">
                          <div className={`text-lg font-bold ${hasBeenScanned && !isInRange ? 'text-slate-600 line-through' : 'text-cyan-400'
                            }`}>
                            {formatRows(partition.rows)}
                          </div>
                          <div className="text-[10px] text-slate-500">rows</div>
                        </div>

                        {/* Visual block representation */}
                        <div className="mt-3 h-8 rounded overflow-hidden bg-slate-700/50">
                          <div
                            className={`h-full transition-all duration-500 ${hasBeenScanned
                                ? isInRange
                                  ? 'bg-gradient-to-r from-green-500 to-emerald-500'
                                  : 'bg-slate-600/50'
                                : 'bg-slate-600'
                              }`}
                            style={{
                              width: hasBeenScanned && isInRange ? '100%' : hasBeenScanned ? '0%' : '100%',
                              transition: 'width 0.5s ease-out'
                            }}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Legend */}
                <div className="flex justify-center gap-6 text-xs">
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded bg-green-500"></div>
                    <span className="text-slate-400">Scanned (data may be here)</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded bg-red-500/50"></div>
                    <span className="text-slate-400">Pruned (skipped via zone map)</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded bg-yellow-500"></div>
                    <span className="text-slate-400">Currently checking</span>
                  </div>
                </div>
              </div>

              {/* Statistics Panel */}
              {scanComplete && (
                <div className="grid grid-cols-4 gap-4 mb-6 animate-slide">
                  <div className="bg-green-900/30 border border-green-500/30 rounded-xl p-5 text-center">
                    <div className="text-3xl font-bold text-green-400">{stats.scannedCount}</div>
                    <div className="text-sm text-slate-400">Partitions Scanned</div>
                    <div className="text-xs text-slate-500 mt-1">out of {partitions.length}</div>
                  </div>

                  <div className="bg-red-900/30 border border-red-500/30 rounded-xl p-5 text-center">
                    <div className="text-3xl font-bold text-red-400">{stats.prunedCount}</div>
                    <div className="text-sm text-slate-400">Partitions Pruned</div>
                    <div className="text-xs text-slate-500 mt-1">skipped entirely!</div>
                  </div>

                  <div className="bg-cyan-900/30 border border-cyan-500/30 rounded-xl p-5 text-center">
                    <div className="text-3xl font-bold text-cyan-400">{formatRows(stats.scannedRows)}</div>
                    <div className="text-sm text-slate-400">Rows Scanned</div>
                    <div className="text-xs text-slate-500 mt-1">of {formatRows(stats.totalRows)} total</div>
                  </div>

                  <div className="bg-purple-900/30 border border-purple-500/30 rounded-xl p-5 text-center">
                    <div className="text-3xl font-bold text-purple-400">{stats.efficiency}%</div>
                    <div className="text-sm text-slate-400">Data Skipped</div>
                    <div className="text-xs text-green-400 mt-1">≡ƒÜÇ {formatRows(stats.prunedRows)} rows saved!</div>
                  </div>
                </div>
              )}

              {/* Efficiency Visualization */}
              {scanComplete && (
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-5 mb-6 animate-slide">
                  <h4 className="font-bold text-white mb-3">≡ƒôè Scan Efficiency</h4>
                  <div className="h-8 bg-slate-800 rounded-full overflow-hidden flex">
                    <div
                      className="h-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-xs font-bold text-white transition-all duration-1000"
                      style={{ width: `${100 - stats.efficiency}%` }}
                    >
                      {stats.scannedRows > 0 && `${formatRows(stats.scannedRows)} scanned`}
                    </div>
                    <div
                      className="h-full bg-gradient-to-r from-red-600 to-red-500 flex items-center justify-center text-xs font-bold text-white transition-all duration-1000"
                      style={{ width: `${stats.efficiency}%` }}
                    >
                      {stats.prunedRows > 0 && `${formatRows(stats.prunedRows)} PRUNED`}
                    </div>
                  </div>
                  <div className="flex justify-between mt-2 text-xs text-slate-500">
                    <span>Necessary I/O</span>
                    <span>Avoided I/O (Zone Map Magic! Γ£¿)</span>
                  </div>
                </div>
              )}

              {/* Interview Tips */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-5">
                <h4 className="text-blue-400 font-bold mb-3">≡ƒÄ» Interview Talking Points</h4>
                <div className="grid grid-cols-2 gap-4 text-sm text-slate-300">
                  <div>
                    <strong className="text-white">Zone Maps:</strong> Metadata containing MIN/MAX for each column in each micro-partition.
                    Checked before any data is read.
                  </div>
                  <div>
                    <strong className="text-white">Clustering Keys:</strong> Define how data is organized. Good clustering = better pruning.
                    Use columns from your WHERE clauses!
                  </div>
                  <div>
                    <strong className="text-white">When It Works Best:</strong> Equality (=) and range (&gt;, &lt;, BETWEEN) predicates on
                    clustered columns. Less effective for LIKE or functions.
                  </div>
                  <div>
                    <strong className="text-white">Your VPI Context:</strong> Clustering on (order_date, plant_code) would optimize
                    Power BI reports filtering by date ranges!
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const JoinsSimulator = ({ onBack }: { onBack: () => void }) => {
      const [joinType, setJoinType] = useState < 'inner' | 'left' | 'right' | 'full' | 'cross' > ('inner');
      const [highlightValue, setHighlightValue] = useState < string | null > (null);
      const containerRef = useRef < HTMLDivElement > (null);
      const [linePositions, setLinePositions] = useState < Array < { x1: number; y1: number; x2: number; y2: number; color: string; isNull: boolean } >> ([]);

      // NULL vs Value animation state
      const [nullValueAnim, setNullValueAnim] = useState < {
        active: boolean;
        progress: number;
        nullIdx: number;
        valueIdx: number;
        targetValue: string;
      } | null > (null);

      // The trick question data - with duplicates and NULLs
      const tableA = [
        { id: 0, value: '1', display: '1' },
        { id: 1, value: '2', display: '2' },
        { id: 2, value: '0', display: '0' },
        { id: 3, value: '0', display: '0' },
        { id: 4, value: null, display: 'NULL' },
        { id: 5, value: null, display: 'NULL' },
        { id: 6, value: '2', display: '2' },
      ];

      const tableB = [
        { id: 0, value: '2', display: '2' },
        { id: 1, value: '0', display: '0' },
        { id: 2, value: '0', display: '0' },
        { id: 3, value: null, display: 'NULL' },
        { id: 4, value: '4', display: '4' },
      ];

      // NULL vs Value scanning animation - triggers periodically on INNER JOIN
      useEffect(() => {
        if (joinType !== 'inner') {
          setNullValueAnim(null);
          return;
        }

        const runNullValueAnimation = () => {
          // Pick a random NULL from Table A (indices 4 or 5)
          const nullIndices = [4, 5];
          const nullIdx = nullIndices[Math.floor(Math.random() * nullIndices.length)];

          // Pick a random non-NULL value from Table B (indices 0, 1, 2, 4 - values 2, 0, 0, 4)
          const valueIndices = [0, 1, 2, 4];
          const valueIdx = valueIndices[Math.floor(Math.random() * valueIndices.length)];
          const targetValue = tableB[valueIdx].display;

          // Start animation
          setNullValueAnim({ active: true, progress: 0, nullIdx, valueIdx, targetValue });

          // Animate progress from 0 to 50 (middle), then show rejection
          let progress = 0;
          const animInterval = setInterval(() => {
            progress += 2;
            if (progress <= 50) {
              setNullValueAnim(prev => prev ? { ...prev, progress } : null);
            } else if (progress <= 100) {
              // Hold at middle with rejection visible
              setNullValueAnim(prev => prev ? { ...prev, progress: 50, active: true } : null);
            } else {
              // Fade out
              clearInterval(animInterval);
              setTimeout(() => setNullValueAnim(null), 500);
            }
          }, 30);

          return () => clearInterval(animInterval);
        };

        // Run animation every 4 seconds
        const timeout = setTimeout(runNullValueAnimation, 1500);
        const interval = setInterval(runNullValueAnimation, 5000);

        return () => {
          clearTimeout(timeout);
          clearInterval(interval);
        };
      }, [joinType]);

      // Calculate join results
      const calculateJoinResults = () => {
        const results: Array<{ aId: number | null; aVal: string; bId: number | null; bVal: string; isGhost: boolean; matchType: string }> = [];

        if (joinType === 'cross') {
          tableA.forEach(a => {
            tableB.forEach(b => {
              results.push({ aId: a.id, aVal: a.display, bId: b.id, bVal: b.display, isGhost: false, matchType: 'cross' });
            });
          });
          return results;
        }

        const matchedA = new Set < number > ();
        const matchedB = new Set < number > ();

        tableA.forEach(a => {
          tableB.forEach(b => {
            if (a.value !== null && b.value !== null && a.value === b.value) {
              results.push({ aId: a.id, aVal: a.display, bId: b.id, bVal: b.display, isGhost: false, matchType: a.value });
              matchedA.add(a.id);
              matchedB.add(b.id);
            }
          });
        });

        if (joinType === 'left' || joinType === 'full') {
          tableA.forEach(a => {
            if (!matchedA.has(a.id)) {
              results.push({ aId: a.id, aVal: a.display, bId: null, bVal: 'NULL', isGhost: true, matchType: 'unmatched' });
            }
          });
        }

        if (joinType === 'right' || joinType === 'full') {
          tableB.forEach(b => {
            if (!matchedB.has(b.id)) {
              results.push({ aId: null, aVal: 'NULL', bId: b.id, bVal: b.display, isGhost: true, matchType: 'unmatched' });
            }
          });
        }

        return results;
      };

      const results = calculateJoinResults();

      // Get matches for drawing lines
      const getMatches = () => {
        const matches: Array<{ aIdx: number; bIdx: number; value: string; isNull: boolean }> = [];

        tableA.forEach((a, aIdx) => {
          tableB.forEach((b, bIdx) => {
            if (a.value !== null && b.value !== null && a.value === b.value) {
              matches.push({ aIdx, bIdx, value: a.value, isNull: false });
            }
          });
        });

        // Add NULL broken connections for INNER join visualization
        if (joinType === 'inner') {
          tableA.forEach((a, aIdx) => {
            if (a.value === null) {
              tableB.forEach((b, bIdx) => {
                if (b.value === null) {
                  matches.push({ aIdx, bIdx, value: 'null', isNull: true });
                }
              });
            }
          });
        }

        return matches;
      };

      const matches = getMatches();

      // Stats
      const stats = {
        zeros: { a: tableA.filter(a => a.value === '0').length, b: tableB.filter(b => b.value === '0').length },
        twos: { a: tableA.filter(a => a.value === '2').length, b: tableB.filter(b => b.value === '2').length },
        nulls: { a: tableA.filter(a => a.value === null).length, b: tableB.filter(b => b.value === null).length },
      };

      const joinTypes = [
        { id: 'inner', label: 'INNER JOIN', icon: 'Γê⌐' },
        { id: 'left', label: 'LEFT JOIN', icon: 'Γèé' },
        { id: 'right', label: 'RIGHT JOIN', icon: 'Γèâ' },
        { id: 'full', label: 'FULL JOIN', icon: 'Γê¬' },
        { id: 'cross', label: 'CROSS JOIN', icon: '├ù' },
      ];

      const getValueColor = (val: string | null, type: 'bg' | 'border' | 'line') => {
        const colors: Record<string, { bg: string; border: string; line: string }> = {
          'NULL': { bg: 'bg-red-900/50', border: 'border-red-500', line: '#ef4444' },
          '0': { bg: 'bg-yellow-900/50', border: 'border-yellow-500', line: '#eab308' },
          '2': { bg: 'bg-green-900/50', border: 'border-green-500', line: '#22c55e' },
          '1': { bg: 'bg-blue-900/50', border: 'border-blue-500', line: '#3b82f6' },
          '4': { bg: 'bg-purple-900/50', border: 'border-purple-500', line: '#a855f7' },
        };
        return colors[val || 'NULL']?.[type] || colors['NULL'][type];
      };

      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      // Row height for calculating line positions
      const ROW_HEIGHT = 44;
      const ROW_GAP = 8;

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-2xl">
                ≡ƒöù
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
                  SQL Joins: Trick Questions
                </h1>
                <p className="text-xs text-slate-500">Duplicates ΓÇó NULLs ΓÇó Cartesian Products</p>
              </div>
            </div>
            <div className="text-sm">
              Result: <span className="text-cyan-400 font-bold text-xl">{results.length}</span> rows
            </div>
          </header>

          {/* Join Type Selector */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-3">
            <div className="flex gap-2 justify-center">
              {joinTypes.map(jt => (
                <button
                  key={jt.id}
                  onClick={() => setJoinType(jt.id as any)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2 ${joinType === jt.id
                      ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-500/30'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                >
                  <span className="text-lg">{jt.icon}</span>
                  {jt.label}
                </button>
              ))}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 overflow-hidden flex">

            {/* Left Panel: Visual Join */}
            <div className="flex-1 p-6 overflow-y-auto">
              <div className="max-w-4xl mx-auto">

                {/* Visual Join Area */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
                  <div className="flex items-start gap-4" ref={containerRef}>

                    {/* Table A */}
                    <div className="w-28 shrink-0">
                      <div className="text-center mb-3">
                        <span className="text-sm font-bold text-blue-400">TABLE A</span>
                        <div className="text-xs text-slate-500">{tableA.length} rows</div>
                      </div>
                      <div className="space-y-2">
                        {tableA.map((row, idx) => (
                          <div
                            key={idx}
                            data-row-a={idx}
                            className={`relative h-10 flex items-center justify-center rounded-lg border-2 font-mono text-sm transition-all cursor-pointer ${getValueColor(row.display, 'bg')} ${getValueColor(row.display, 'border')} ${highlightValue === row.display ? 'ring-2 ring-white scale-105 z-10' : ''
                              }`}
                            onMouseEnter={() => setHighlightValue(row.display)}
                            onMouseLeave={() => setHighlightValue(null)}
                          >
                            {row.display}
                            {row.value === null && (
                              <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full text-[8px] flex items-center justify-center">Γ£ù</span>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Connection Lines Area */}
                    <div className="flex-1 relative" style={{ minHeight: `${tableA.length * (ROW_HEIGHT + ROW_GAP)}px` }}>
                      <svg className="absolute inset-0 w-full h-full overflow-visible">
                        {matches.map((match, idx) => {
                          const y1 = match.aIdx * (ROW_HEIGHT + ROW_GAP) + ROW_HEIGHT / 2 + 28; // +28 for header
                          const y2 = match.bIdx * (ROW_HEIGHT + ROW_GAP) + ROW_HEIGHT / 2 + 28;
                          const color = getValueColor(match.value === 'null' ? 'NULL' : match.value, 'line');
                          const isHighlighted = highlightValue === match.value || highlightValue === (match.value === 'null' ? 'NULL' : match.value);

                          if (match.isNull) {
                            // Broken NULL line
                            return (
                              <g key={idx} className="transition-opacity" style={{ opacity: isHighlighted ? 1 : 0.7 }}>
                                {/* Left segment */}
                                <line
                                  x1="0"
                                  y1={y1}
                                  x2="35%"
                                  y2={(y1 + y2) / 2}
                                  stroke={color}
                                  strokeWidth={isHighlighted ? 3 : 2}
                                  strokeDasharray="6,4"
                                />
                                {/* Right segment */}
                                <line
                                  x1="65%"
                                  y1={(y1 + y2) / 2}
                                  x2="100%"
                                  y2={y2}
                                  stroke={color}
                                  strokeWidth={isHighlighted ? 3 : 2}
                                  strokeDasharray="6,4"
                                />
                                {/* X mark */}
                                <circle cx="50%" cy={(y1 + y2) / 2} r="12" fill="#7f1d1d" stroke={color} strokeWidth="2" />
                                <text x="50%" y={(y1 + y2) / 2 + 4} fill="white" fontSize="12" textAnchor="middle" fontWeight="bold">Γ£ù</text>
                                {/* Label */}
                                <text x="50%" y={(y1 + y2) / 2 + 28} fill={color} fontSize="10" textAnchor="middle" className="font-mono">
                                  NULL Γëá NULL
                                </text>
                              </g>
                            );
                          }

                          return (
                            <line
                              key={idx}
                              x1="0"
                              y1={y1}
                              x2="100%"
                              y2={y2}
                              stroke={color}
                              strokeWidth={isHighlighted ? 4 : 2}
                              opacity={isHighlighted ? 1 : 0.6}
                              className="transition-all"
                            />
                          );
                        })}

                        {/* NULL vs Value Animation */}
                        {nullValueAnim && joinType === 'inner' && (
                          (() => {
                            const y1 = nullValueAnim.nullIdx * (ROW_HEIGHT + ROW_GAP) + ROW_HEIGHT / 2 + 28;
                            const y2 = nullValueAnim.valueIdx * (ROW_HEIGHT + ROW_GAP) + ROW_HEIGHT / 2 + 28;
                            const midY = (y1 + y2) / 2;
                            const progress = nullValueAnim.progress;

                            // Calculate current line end position based on progress
                            const currentX = `${progress}%`;
                            const currentY = y1 + (midY - y1) * (progress / 50);

                            return (
                              <g className="null-value-animation">
                                {/* Animated scanning line from NULL */}
                                <line
                                  x1="0"
                                  y1={y1}
                                  x2={currentX}
                                  y2={currentY}
                                  stroke="#f97316"
                                  strokeWidth="3"
                                  strokeDasharray="8,4"
                                  opacity="0.9"
                                  style={{
                                    filter: 'drop-shadow(0 0 6px rgba(249, 115, 22, 0.6))'
                                  }}
                                />

                                {/* Scanning head glow */}
                                {progress < 50 && (
                                  <circle
                                    cx={currentX}
                                    cy={currentY}
                                    r="6"
                                    fill="#f97316"
                                    opacity="0.8"
                                    style={{
                                      filter: 'drop-shadow(0 0 8px rgba(249, 115, 22, 0.8))'
                                    }}
                                  >
                                    <animate attributeName="r" values="4;8;4" dur="0.3s" repeatCount="indefinite" />
                                  </circle>
                                )}

                                {/* Rejection X mark and label - appears at 50% progress */}
                                {progress >= 50 && (
                                  <g style={{ animation: 'fadeIn 0.3s ease-out' }}>
                                    {/* Red blocking circle */}
                                    <circle
                                      cx="50%"
                                      cy={midY}
                                      r="16"
                                      fill="#dc2626"
                                      stroke="#fca5a5"
                                      strokeWidth="2"
                                      style={{
                                        filter: 'drop-shadow(0 0 10px rgba(220, 38, 38, 0.7))',
                                        animation: 'pulse 0.5s ease-out'
                                      }}
                                    />

                                    {/* X mark */}
                                    <text
                                      x="50%"
                                      y={midY + 5}
                                      fill="white"
                                      fontSize="16"
                                      fontWeight="bold"
                                      textAnchor="middle"
                                    >
                                      Γ£ù
                                    </text>

                                    {/* Floating label - NULL Γëá Value */}
                                    <g>
                                      <rect
                                        x="calc(50% - 45px)"
                                        y={midY - 42}
                                        width="90"
                                        height="22"
                                        rx="4"
                                        fill="#7f1d1d"
                                        stroke="#fca5a5"
                                        strokeWidth="1"
                                      />
                                      <text
                                        x="50%"
                                        y={midY - 27}
                                        fill="#fca5a5"
                                        fontSize="11"
                                        fontWeight="bold"
                                        textAnchor="middle"
                                        fontFamily="monospace"
                                      >
                                        NULL Γëá {nullValueAnim.targetValue}
                                      </text>
                                    </g>

                                    {/* Shockwave effect rings */}
                                    <circle
                                      cx="50%"
                                      cy={midY}
                                      r="16"
                                      fill="none"
                                      stroke="#ef4444"
                                      strokeWidth="2"
                                      opacity="0.6"
                                      style={{
                                        animation: 'ripple 0.8s ease-out forwards'
                                      }}
                                    />
                                    <circle
                                      cx="50%"
                                      cy={midY}
                                      r="16"
                                      fill="none"
                                      stroke="#ef4444"
                                      strokeWidth="1"
                                      opacity="0.4"
                                      style={{
                                        animation: 'ripple 0.8s ease-out 0.2s forwards'
                                      }}
                                    />
                                  </g>
                                )}

                                {/* Target indicator on Table B value */}
                                {progress < 50 && (
                                  <circle
                                    cx="100%"
                                    cy={y2}
                                    r="8"
                                    fill="none"
                                    stroke="#f97316"
                                    strokeWidth="2"
                                    strokeDasharray="4,2"
                                    opacity="0.6"
                                  >
                                    <animate attributeName="r" values="6;12;6" dur="0.8s" repeatCount="indefinite" />
                                    <animate attributeName="opacity" values="0.6;0.3;0.6" dur="0.8s" repeatCount="indefinite" />
                                  </circle>
                                )}
                              </g>
                            );
                          })()
                        )}
                      </svg>

                      {/* CSS for animations */}
                      <style>{`
                    @keyframes ripple {
                      0% { r: 16; opacity: 0.6; }
                      100% { r: 40; opacity: 0; }
                    }
                    @keyframes pulse {
                      0% { transform: scale(0.8); }
                      50% { transform: scale(1.1); }
                      100% { transform: scale(1); }
                    }
                    @keyframes fadeIn {
                      0% { opacity: 0; transform: scale(0.5); }
                      100% { opacity: 1; transform: scale(1); }
                    }
                  `}</style>

                      {/* Center Join Label */}
                      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-3 z-10 shadow-xl">
                        <div className="text-3xl text-center">{joinTypes.find(j => j.id === joinType)?.icon}</div>
                        <div className="text-xs text-slate-400 text-center mt-1 font-bold">{joinType.toUpperCase()}</div>
                      </div>
                    </div>

                    {/* Table B */}
                    <div className="w-28 shrink-0">
                      <div className="text-center mb-3">
                        <span className="text-sm font-bold text-orange-400">TABLE B</span>
                        <div className="text-xs text-slate-500">{tableB.length} rows</div>
                      </div>
                      <div className="space-y-2">
                        {tableB.map((row, idx) => (
                          <div
                            key={idx}
                            data-row-b={idx}
                            className={`relative h-10 flex items-center justify-center rounded-lg border-2 font-mono text-sm transition-all cursor-pointer ${getValueColor(row.display, 'bg')} ${getValueColor(row.display, 'border')} ${highlightValue === row.display ? 'ring-2 ring-white scale-105 z-10' : ''
                              }`}
                            onMouseEnter={() => setHighlightValue(row.display)}
                            onMouseLeave={() => setHighlightValue(null)}
                          >
                            {row.display}
                            {row.value === null && (
                              <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full text-[8px] flex items-center justify-center">Γ£ù</span>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Insights Panel */}
                <div className="grid grid-cols-4 gap-4 mb-6">
                  {/* The 0 Explosion */}
                  <div className={`bg-yellow-900/20 border rounded-xl p-4 transition-all ${highlightValue === '0' ? 'border-yellow-400 ring-2 ring-yellow-400/30' : 'border-yellow-500/30'
                    }`}
                    onMouseEnter={() => setHighlightValue('0')}
                    onMouseLeave={() => setHighlightValue(null)}
                  >
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-xl">≡ƒÆÑ</span>
                      <span className="font-bold text-yellow-400 text-sm">The "0" Explosion</span>
                    </div>
                    <div className="text-xs text-slate-300 mb-2">Duplicates multiply:</div>
                    <div className="bg-slate-900 rounded-lg p-2 font-mono text-center">
                      <span className="text-yellow-400">{stats.zeros.a}</span>
                      <span className="text-slate-500"> ├ù </span>
                      <span className="text-yellow-400">{stats.zeros.b}</span>
                      <span className="text-slate-500"> = </span>
                      <span className="text-yellow-300 text-lg font-bold">{stats.zeros.a * stats.zeros.b}</span>
                    </div>
                  </div>

                  {/* The NULL = NULL Trap */}
                  <div className={`bg-red-900/20 border rounded-xl p-4 transition-all ${highlightValue === 'NULL' ? 'border-red-400 ring-2 ring-red-400/30' : 'border-red-500/30'
                    }`}
                    onMouseEnter={() => setHighlightValue('NULL')}
                    onMouseLeave={() => setHighlightValue(null)}
                  >
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-xl">≡ƒ¬ñ</span>
                      <span className="font-bold text-red-400 text-sm">NULL = NULL</span>
                    </div>
                    <div className="text-xs text-slate-300 mb-2">Never matches itself:</div>
                    <div className="bg-slate-900 rounded-lg p-2 font-mono text-center">
                      <span className="text-red-400 text-xs">NULL = NULL</span>
                      <span className="text-slate-500 text-xs"> ΓåÆ </span>
                      <span className="bg-red-600 text-white px-1.5 py-0.5 rounded text-xs">FALSE</span>
                    </div>
                  </div>

                  {/* NEW: NULL vs Value Trap */}
                  <div className={`bg-orange-900/20 border rounded-xl p-4 transition-all ${nullValueAnim?.active ? 'border-orange-400 ring-2 ring-orange-400/30 animate-pulse' : 'border-orange-500/30'
                    }`}>
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-xl">≡ƒÜ½</span>
                      <span className="font-bold text-orange-400 text-sm">NULL Γëá Value</span>
                    </div>
                    <div className="text-xs text-slate-300 mb-2">Never matches numbers:</div>
                    <div className="bg-slate-900 rounded-lg p-2 font-mono text-center">
                      <span className="text-red-400 text-xs">NULL</span>
                      <span className="text-slate-500 text-xs"> = </span>
                      <span className="text-purple-400 text-xs">'4'</span>
                      <span className="text-slate-500 text-xs"> ΓåÆ </span>
                      <span className="bg-orange-600 text-white px-1.5 py-0.5 rounded text-xs">FALSE</span>
                    </div>
                    {joinType === 'inner' && (
                      <div className="text-[10px] text-orange-400 mt-2 text-center animate-pulse">
                        ≡ƒæÇ Watch the animation!
                      </div>
                    )}
                  </div>

                  {/* The 2 Multiplier */}
                  <div className={`bg-green-900/20 border rounded-xl p-4 transition-all ${highlightValue === '2' ? 'border-green-400 ring-2 ring-green-400/30' : 'border-green-500/30'
                    }`}
                    onMouseEnter={() => setHighlightValue('2')}
                    onMouseLeave={() => setHighlightValue(null)}
                  >
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-xl">Γ£û∩╕Å</span>
                      <span className="font-bold text-green-400 text-sm">The "2" Multiplier</span>
                    </div>
                    <div className="text-xs text-slate-300 mb-2">Multiple matches:</div>
                    <div className="bg-slate-900 rounded-lg p-2 font-mono text-center">
                      <span className="text-green-400">{stats.twos.a}</span>
                      <span className="text-slate-500"> ├ù </span>
                      <span className="text-green-400">{stats.twos.b}</span>
                      <span className="text-slate-500"> = </span>
                      <span className="text-green-300 text-lg font-bold">{stats.twos.a * stats.twos.b}</span>
                    </div>
                  </div>
                </div>

                {/* SQL Example */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-4">
                  <div className="text-xs font-bold text-slate-500 uppercase mb-2">SQL Query</div>
                  <pre className="font-mono text-sm text-slate-300">
                    {joinType === 'inner' ? `SELECT A.value, B.value
INNER JOIN TableB B ON A.value = B.value;
-- NULLs excluded: NULL = NULL is FALSE!` :
                      joinType === 'left' ? `SELECT A.value, B.value
LEFT JOIN TableB B ON A.value = B.value;
-- All A rows kept, B fills with NULL if no match` :
                        joinType === 'right' ? `SELECT A.value, B.value
RIGHT JOIN TableB B ON A.value = B.value;
-- All B rows kept, A fills with NULL if no match` :
                          joinType === 'full' ? `SELECT A.value, B.value
FULL OUTER JOIN TableB B ON A.value = B.value;
-- All rows from both, NULLs fill gaps` :
                            `SELECT A.value, B.value
CROSS JOIN TableB B;
-- Every row ├ù every row = ${tableA.length} ├ù ${tableB.length} = ${tableA.length * tableB.length} rows!`}
                  </pre>
                </div>
              </div>
            </div>

            {/* Right Panel: Result Table */}
            <div className="w-80 bg-slate-900 border-l border-slate-800 p-4 overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-bold text-white">≡ƒôè Result</h3>
                <span className={`text-sm font-bold px-2 py-1 rounded ${joinType === 'cross' ? 'bg-red-900/50 text-red-400' :
                    results.length > 10 ? 'bg-yellow-900/50 text-yellow-400' :
                      'bg-green-900/50 text-green-400'
                  }`}>
                  {results.length} rows
                </span>
              </div>

              {/* Header */}
              <div className="grid grid-cols-2 gap-1 mb-2 text-xs font-bold">
                <div className="bg-blue-900/30 text-blue-400 p-2 rounded text-center">A.value</div>
                <div className="bg-orange-900/30 text-orange-400 p-2 rounded text-center">B.value</div>
              </div>

              {/* Result Rows */}
              <div className="space-y-1 max-h-[400px] overflow-y-auto">
                {results.slice(0, 40).map((row, idx) => (
                  <div key={idx} className="grid grid-cols-2 gap-1">
                    <div className={`p-2 rounded text-center font-mono text-xs ${row.isGhost && row.aId === null
                        ? 'border-2 border-dashed border-red-500/50 text-red-400'
                        : `${getValueColor(row.aVal, 'bg')} border ${getValueColor(row.aVal, 'border')}`
                      }`}>
                      {row.aVal}
                      {row.isGhost && row.aId === null && <span className="ml-1">≡ƒæ╗</span>}
                    </div>
                    <div className={`p-2 rounded text-center font-mono text-xs ${row.isGhost && row.bId === null
                        ? 'border-2 border-dashed border-red-500/50 text-red-400'
                        : `${getValueColor(row.bVal, 'bg')} border ${getValueColor(row.bVal, 'border')}`
                      }`}>
                      {row.bVal}
                      {row.isGhost && row.bId === null && <span className="ml-1">≡ƒæ╗</span>}
                    </div>
                  </div>
                ))}
                {results.length > 40 && (
                  <div className="text-center text-slate-500 text-xs py-2">+{results.length - 40} more...</div>
                )}
              </div>

              {/* Legend for outer joins */}
              {(joinType === 'left' || joinType === 'right' || joinType === 'full') && (
                <div className="mt-3 p-2 bg-slate-800 rounded-lg text-xs flex items-center gap-2">
                  <div className="w-6 h-6 border-2 border-dashed border-red-500/50 rounded flex items-center justify-center">≡ƒæ╗</div>
                  <span className="text-slate-400">Ghost = No match (NULL filled)</span>
                </div>
              )}

              {/* Row Breakdown */}
              <div className="mt-4 p-3 bg-slate-800 rounded-xl text-sm">
                <div className="text-xs font-bold text-slate-500 uppercase mb-2">Breakdown</div>
                {joinType !== 'cross' ? (
                  <div className="space-y-1">
                    <div className="flex justify-between">
                      <span className="text-green-400">"2" matches:</span>
                      <span className="font-mono">{stats.twos.a * stats.twos.b}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-yellow-400">"0" matches:</span>
                      <span className="font-mono">{stats.zeros.a * stats.zeros.b}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-red-400">NULL matches:</span>
                      <span className="font-mono">0</span>
                    </div>
                    {(joinType === 'left' || joinType === 'full') && (
                      <div className="flex justify-between">
                        <span className="text-slate-400">Unmatched A:</span>
                        <span className="font-mono">{tableA.filter(a => a.value === '1' || a.value === null).length}</span>
                      </div>
                    )}
                    {(joinType === 'right' || joinType === 'full') && (
                      <div className="flex justify-between">
                        <span className="text-slate-400">Unmatched B:</span>
                        <span className="font-mono">{tableB.filter(b => b.value === '4' || b.value === null).length}</span>
                      </div>
                    )}
                    <div className="border-t border-slate-700 pt-1 flex justify-between font-bold">
                      <span>Total:</span>
                      <span className="text-cyan-400">{results.length}</span>
                    </div>
                  </div>
                ) : (
                  <div className="text-center font-mono">
                    <span className="text-blue-400">{tableA.length}</span>
                    <span className="text-slate-500"> ├ù </span>
                    <span className="text-orange-400">{tableB.length}</span>
                    <span className="text-slate-500"> = </span>
                    <span className="text-red-400 font-bold text-lg">{results.length}</span>
                    <div className="text-xs text-red-400 mt-1">ΓÜá∩╕Å Cartesian!</div>
                  </div>
                )}
              </div>

              {/* Interview Tip */}
              <div className="mt-4 p-3 bg-cyan-900/20 border border-cyan-500/30 rounded-xl">
                <div className="text-xs font-bold text-cyan-400 mb-1">≡ƒÄ» Interview Tip</div>
                <div className="text-xs text-slate-300">
                  {joinType === 'inner' && "NULL never equals ANYTHING - not even itself! NULL = NULL ΓåÆ FALSE, NULL = '4' ΓåÆ FALSE. This is why NULLs are excluded from INNER JOINs. Watch the orange scanning animation!"}
                  {joinType === 'left' && "All rows from LEFT table appear. No match? RIGHT columns become NULL (ghost rows)."}
                  {joinType === 'right' && "All rows from RIGHT table appear. Same as LEFT with tables swapped."}
                  {joinType === 'full' && "Union of LEFT and RIGHT. Every row appears, NULLs fill the gaps."}
                  {joinType === 'cross' && "Every row pairs with every row. Dangerous without WHERE! Use for generating combinations."}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const WindowSimulator = ({ onBack }: { onBack: () => void }) => {
      const [windowFunc, setWindowFunc] = useState < 'row_number' | 'rank' | 'dense_rank' | 'lead' | 'lag' > ('row_number');
      const [usePartition, setUsePartition] = useState(false);
      const [isSorting, setIsSorting] = useState(false);
      const [showResults, setShowResults] = useState(false);
      const [sortedData, setSortedData] = useState < typeof teamsData > ([]);

      // Cricket World Cup Teams Data
      const teamsData = [
        { id: 1, team: 'India', flag: '≡ƒç«≡ƒç│', points: 10, nrr: 1.2, group: 'A', color: 'blue' },
        { id: 2, team: 'Australia', flag: '≡ƒçª≡ƒç║', points: 10, nrr: 0.8, group: 'A', color: 'yellow' },
        { id: 3, team: 'New Zealand', flag: '≡ƒç│≡ƒç┐', points: 10, nrr: 0.5, group: 'A', color: 'gray' },
        { id: 4, team: 'England', flag: '≡ƒÅ┤≤áüº≤áüó≤áüÑ≤áü«≤áüº≤áü┐', points: 8, nrr: 0.3, group: 'A', color: 'red' },
        { id: 5, team: 'Pakistan', flag: '≡ƒç╡≡ƒç░', points: 8, nrr: 0.1, group: 'B', color: 'green' },
        { id: 6, team: 'South Africa', flag: '≡ƒç┐≡ƒçª', points: 6, nrr: -0.2, group: 'B', color: 'emerald' },
      ];

      // Calculate window function results
      const calculateWindowResults = (data: typeof teamsData) => {
        const sorted = [...data].sort((a, b) => {
          if (usePartition) {
            if (a.group !== b.group) return a.group.localeCompare(b.group);
          }
          return b.points - a.points || b.nrr - a.nrr;
        });

        let currentRank = 0;
        let currentDenseRank = 0;
        let lastPoints = -1;
        let lastGroup = '';
        let skipCount = 0;

        return sorted.map((team, idx) => {
          // Reset for partition
          if (usePartition && team.group !== lastGroup) {
            currentRank = 0;
            currentDenseRank = 0;
            lastPoints = -1;
            skipCount = 0;
            lastGroup = team.group;
          }

          const row_number = usePartition
            ? sorted.filter(t => t.group === team.group).findIndex(t => t.id === team.id) + 1
            : idx + 1;

          let rank: number;
          let dense_rank: number;

          if (team.points === lastPoints) {
            rank = currentRank;
            dense_rank = currentDenseRank;
            skipCount++;
          } else {
            currentRank = currentRank + skipCount + 1;
            currentDenseRank++;
            rank = currentRank;
            dense_rank = currentDenseRank;
            skipCount = 0;
          }

          lastPoints = team.points;

          // Lead/Lag calculations
          const partitionData = usePartition
            ? sorted.filter(t => t.group === team.group)
            : sorted;
          const posInPartition = partitionData.findIndex(t => t.id === team.id);

          const lead = posInPartition < partitionData.length - 1
            ? partitionData[posInPartition + 1]?.team
            : null;
          const lag = posInPartition > 0
            ? partitionData[posInPartition - 1]?.team
            : null;

          return {
            ...team,
            row_number,
            rank,
            dense_rank,
            lead,
            lag,
            originalIndex: teamsData.findIndex(t => t.id === team.id)
          };
        });
      };

      const runAnimation = () => {
        setIsSorting(true);
        setShowResults(false);

        setTimeout(() => {
          setSortedData(calculateWindowResults(teamsData));
          setIsSorting(false);
          setTimeout(() => setShowResults(true), 300);
        }, 800);
      };

      useEffect(() => {
        setSortedData(calculateWindowResults(teamsData));
        setShowResults(true);
      }, [windowFunc, usePartition]);

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      const functions = [
        { id: 'row_number', label: 'ROW_NUMBER()', icon: '#', desc: 'Unique sequential' },
        { id: 'rank', label: 'RANK()', icon: '≡ƒÅå', desc: 'Ties skip ranks' },
        { id: 'dense_rank', label: 'DENSE_RANK()', icon: '≡ƒÄû∩╕Å', desc: 'Ties no skip' },
        { id: 'lead', label: 'LEAD()', icon: 'ΓÅ¡∩╕Å', desc: 'Next row value' },
        { id: 'lag', label: 'LAG()', icon: 'ΓÅ«∩╕Å', desc: 'Previous row value' },
      ];

      const getTeamBgColor = (color: string) => {
        const colors: Record<string, string> = {
          blue: 'bg-blue-900/40 border-blue-500',
          yellow: 'bg-yellow-900/40 border-yellow-500',
          gray: 'bg-slate-700/40 border-slate-400',
          red: 'bg-red-900/40 border-red-500',
          green: 'bg-green-900/40 border-green-500',
          emerald: 'bg-emerald-900/40 border-emerald-500',
        };
        return colors[color] || 'bg-slate-800 border-slate-600';
      };

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center text-2xl">
                ≡ƒÅÅ
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">
                  Window Functions: World Cup Edition
                </h1>
                <p className="text-xs text-slate-500">ROW_NUMBER ΓÇó RANK ΓÇó DENSE_RANK ΓÇó LEAD ΓÇó LAG</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-xs text-slate-500">PARTITION BY group:</span>
              <button
                onClick={() => setUsePartition(!usePartition)}
                className={`w-12 h-6 rounded-full transition-all ${usePartition ? 'bg-green-600' : 'bg-slate-700'}`}
              >
                <div className={`w-5 h-5 rounded-full bg-white shadow transition-all ${usePartition ? 'translate-x-6' : 'translate-x-0.5'}`} />
              </button>
            </div>
          </header>

          {/* Function Selector */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-3">
            <div className="flex gap-2 justify-center">
              {functions.map(fn => (
                <button
                  key={fn.id}
                  onClick={() => setWindowFunc(fn.id as any)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2 ${windowFunc === fn.id
                      ? 'bg-yellow-600 text-white shadow-lg shadow-yellow-500/30'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                >
                  <span>{fn.icon}</span>
                  {fn.label}
                </button>
              ))}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 overflow-y-auto p-6">
            <div className="max-w-5xl mx-auto">

              {/* Concept Explanation */}
              <div className="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border border-yellow-500/30 rounded-xl p-5 mb-6">
                <h3 className="text-lg font-bold text-white mb-2">
                  {windowFunc === 'row_number' && '# ROW_NUMBER() - Unique Sequential Numbers'}
                  {windowFunc === 'rank' && '≡ƒÅå RANK() - Ties Get Same Rank, Then Skip'}
                  {windowFunc === 'dense_rank' && '≡ƒÄû∩╕Å DENSE_RANK() - Ties Get Same Rank, No Skip'}
                  {windowFunc === 'lead' && 'ΓÅ¡∩╕Å LEAD() - Peek at Next Row'}
                  {windowFunc === 'lag' && 'ΓÅ«∩╕Å LAG() - Peek at Previous Row'}
                </h3>
                <p className="text-sm text-slate-300">
                  {windowFunc === 'row_number' && 'Assigns 1, 2, 3... to each row. Ties are broken arbitrarily. Each row gets a UNIQUE number.'}
                  {windowFunc === 'rank' && 'Same value = same rank. But the NEXT rank SKIPS! (1, 1, 1 ΓåÆ 4). Like Olympic medals with missing 2nd & 3rd.'}
                  {windowFunc === 'dense_rank' && 'Same value = same rank. The NEXT rank is sequential! (1, 1, 1 ΓåÆ 2). No gaps in ranking.'}
                  {windowFunc === 'lead' && 'Access a value from the NEXT row in the result set. Useful for comparing current vs next.'}
                  {windowFunc === 'lag' && 'Access a value from the PREVIOUS row in the result set. Useful for calculating changes.'}
                </p>
              </div>

              {/* Points Table */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h4 className="font-bold text-white flex items-center gap-2">
                    ≡ƒÅÅ Cricket World Cup Points Table
                    {usePartition && <span className="text-xs bg-purple-600 px-2 py-0.5 rounded">PARTITION BY group</span>}
                  </h4>
                  <button
                    onClick={runAnimation}
                    disabled={isSorting}
                    className={`px-4 py-2 rounded-lg font-semibold transition ${isSorting ? 'bg-yellow-600 animate-pulse' : 'bg-green-600 hover:bg-green-500'
                      } text-white`}
                  >
                    {isSorting ? '≡ƒöä Sorting...' : 'Γû╢ Run ORDER BY points DESC'}
                  </button>
                </div>

                {/* Table Header */}
                <div className="grid grid-cols-12 gap-2 mb-2 text-xs font-bold text-slate-500 uppercase px-4">
                  <div className="col-span-3">Team</div>
                  <div className="text-center">Pts</div>
                  <div className="text-center">NRR</div>
                  <div className="text-center">Grp</div>
                  <div className="col-span-2 text-center bg-yellow-900/30 rounded px-1">
                    {windowFunc === 'row_number' && 'ROW_#'}
                    {windowFunc === 'rank' && 'RANK'}
                    {windowFunc === 'dense_rank' && 'D_RANK'}
                    {windowFunc === 'lead' && 'LEAD'}
                    {windowFunc === 'lag' && 'LAG'}
                  </div>
                  <div className="col-span-4 text-center">Explanation</div>
                </div>

                {/* Team Rows */}
                <div className="space-y-2 relative">
                  {sortedData.map((team, idx) => {
                    const isPartitionStart = usePartition && (idx === 0 || sortedData[idx - 1]?.group !== team.group);
                    const isTied = windowFunc !== 'lead' && windowFunc !== 'lag' &&
                      sortedData.some((t, i) => i !== idx && t.points === team.points && (!usePartition || t.group === team.group));

                    const resultValue = windowFunc === 'row_number' ? team.row_number :
                      windowFunc === 'rank' ? team.rank :
                        windowFunc === 'dense_rank' ? team.dense_rank :
                          windowFunc === 'lead' ? team.lead :
                            team.lag;

                    // Find previous/next team for lead/lag arrows
                    const prevTeam = idx > 0 ? sortedData[idx - 1] : null;
                    const nextTeam = idx < sortedData.length - 1 ? sortedData[idx + 1] : null;

                    return (
                      <div key={team.id}>
                        {/* Partition divider */}
                        {isPartitionStart && usePartition && idx > 0 && (
                          <div className="flex items-center gap-2 py-2">
                            <div className="flex-1 border-t-2 border-dashed border-purple-500"></div>
                            <span className="text-xs text-purple-400 font-bold">GROUP {team.group}</span>
                            <div className="flex-1 border-t-2 border-dashed border-purple-500"></div>
                          </div>
                        )}

                        <div
                          className={`grid grid-cols-12 gap-2 items-center p-3 rounded-xl border-2 transition-all ${isSorting ? 'animate-pulse' : ''
                            } ${getTeamBgColor(team.color)} ${isTied && showResults ? 'ring-2 ring-yellow-400/50' : ''
                            }`}
                          style={{
                            transition: 'all 0.5s ease-out',
                          }}
                        >
                          {/* Team Info */}
                          <div className="col-span-3 flex items-center gap-3">
                            <span className="text-2xl">{team.flag}</span>
                            <span className="font-bold text-white">{team.team}</span>
                          </div>

                          {/* Points */}
                          <div className="text-center">
                            <span className="font-bold text-lg text-cyan-400">{team.points}</span>
                          </div>

                          {/* NRR */}
                          <div className="text-center text-sm text-slate-400">
                            {team.nrr > 0 ? '+' : ''}{team.nrr}
                          </div>

                          {/* Group */}
                          <div className="text-center">
                            <span className={`text-xs px-2 py-0.5 rounded ${team.group === 'A' ? 'bg-blue-900/50 text-blue-400' : 'bg-green-900/50 text-green-400'
                              }`}>
                              {team.group}
                            </span>
                          </div>

                          {/* Window Function Result */}
                          <div className="col-span-2 text-center relative">
                            {showResults && (
                              <div className={`inline-flex items-center justify-center w-12 h-10 rounded-lg font-bold text-lg animate-slide ${(windowFunc === 'lead' || windowFunc === 'lag')
                                  ? resultValue ? 'bg-purple-900/50 border border-purple-500 text-purple-400 text-xs' : 'bg-slate-700 text-slate-500'
                                  : isTied ? 'bg-yellow-900/50 border-2 border-yellow-500 text-yellow-400' : 'bg-cyan-900/50 border border-cyan-500 text-cyan-400'
                                }`}>
                                {resultValue ?? 'NULL'}
                              </div>
                            )}

                            {/* Lead Arrow */}
                            {windowFunc === 'lead' && showResults && nextTeam && (!usePartition || nextTeam.group === team.group) && (
                              <div className="absolute -right-8 top-1/2 -translate-y-1/2 text-purple-400">
                                Γåô
                              </div>
                            )}

                            {/* Lag Arrow */}
                            {windowFunc === 'lag' && showResults && prevTeam && (!usePartition || prevTeam.group === team.group) && (
                              <div className="absolute -right-8 top-1/2 -translate-y-1/2 text-purple-400">
                                Γåæ
                              </div>
                            )}
                          </div>

                          {/* Explanation */}
                          <div className="col-span-4 text-xs text-slate-400">
                            {showResults && (
                              <>
                                {windowFunc === 'row_number' && (
                                  isTied ? `Tied at ${team.points}pts but gets unique #${team.row_number}` : `Position ${team.row_number} in order`
                                )}
                                {windowFunc === 'rank' && (
                                  isTied
                                    ? team.rank === 1
                                      ? '3-way tie for 1st ΓåÆ ranks 2,3 skipped!'
                                      : `Tied ΓåÆ same rank ${team.rank}`
                                    : team.rank > team.dense_rank
                                      ? `Rank ${team.rank} (${team.rank - team.dense_rank} skipped)`
                                      : `Rank ${team.rank}`
                                )}
                                {windowFunc === 'dense_rank' && (
                                  isTied
                                    ? `Tied ΓåÆ same rank ${team.dense_rank}, NO skip!`
                                    : `Dense rank ${team.dense_rank} (sequential)`
                                )}
                                {windowFunc === 'lead' && (
                                  team.lead ? `Next team: ${team.lead}` : 'Last in partition ΓåÆ NULL'
                                )}
                                {windowFunc === 'lag' && (
                                  team.lag ? `Prev team: ${team.lag}` : 'First in partition ΓåÆ NULL'
                                )}
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Tie Highlight Legend */}
                {(windowFunc === 'rank' || windowFunc === 'dense_rank' || windowFunc === 'row_number') && showResults && (
                  <div className="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg flex items-center gap-4">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded ring-2 ring-yellow-400"></div>
                      <span className="text-xs text-slate-400">3-way tie at 10 points!</span>
                    </div>
                    {windowFunc === 'rank' && (
                      <span className="text-xs text-yellow-400">RANK skips to 4 (no 2nd or 3rd place)</span>
                    )}
                    {windowFunc === 'dense_rank' && (
                      <span className="text-xs text-green-400">DENSE_RANK continues to 2 (no gaps)</span>
                    )}
                    {windowFunc === 'row_number' && (
                      <span className="text-xs text-cyan-400">ROW_NUMBER gives unique 1, 2, 3 (arbitrary order)</span>
                    )}
                  </div>
                )}
              </div>

              {/* SQL Reference */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5 mb-6">
                <div className="text-xs font-bold text-slate-500 uppercase mb-2">SQL Query</div>
                <pre className="bg-slate-950 rounded-lg p-4 text-sm font-mono overflow-x-auto">
                  <span className="text-purple-400">SELECT</span>
                  <br />{"    "}team, points, grp,
                  <br />{"    "}<span className="text-yellow-400">{windowFunc.toUpperCase()}()</span> <span className="text-purple-400">OVER</span> (
                  <br />{"        "}{usePartition && <><span className="text-purple-400">PARTITION BY</span> grp<br />{"        "}</>}
                  <span className="text-purple-400">ORDER BY</span> points <span className="text-cyan-400">DESC</span>
                  <br />{"    "}) <span className="text-purple-400">AS</span> <span className="text-green-400">{windowFunc}</span>
                  <br /><span className="text-purple-400">FROM</span> world_cup_standings;
                </pre>
              </div>

              {/* Comparison Grid */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                <h4 className="font-bold text-white mb-4">≡ƒôè Quick Comparison: Tie Behavior</h4>
                <div className="grid grid-cols-3 gap-4">
                  <div className="bg-slate-800 rounded-xl p-4 text-center">
                    <div className="text-sm font-bold text-cyan-400 mb-2">ROW_NUMBER()</div>
                    <div className="flex justify-center gap-2 mb-2">
                      <span className="w-8 h-8 rounded bg-cyan-900/50 border border-cyan-500 flex items-center justify-center font-bold">1</span>
                      <span className="w-8 h-8 rounded bg-cyan-900/50 border border-cyan-500 flex items-center justify-center font-bold">2</span>
                      <span className="w-8 h-8 rounded bg-cyan-900/50 border border-cyan-500 flex items-center justify-center font-bold">3</span>
                    </div>
                    <div className="text-xs text-slate-400">Always unique, arbitrary for ties</div>
                  </div>

                  <div className="bg-slate-800 rounded-xl p-4 text-center">
                    <div className="text-sm font-bold text-yellow-400 mb-2">RANK()</div>
                    <div className="flex justify-center gap-2 mb-2">
                      <span className="w-8 h-8 rounded bg-yellow-900/50 border border-yellow-500 flex items-center justify-center font-bold">1</span>
                      <span className="w-8 h-8 rounded bg-yellow-900/50 border border-yellow-500 flex items-center justify-center font-bold">1</span>
                      <span className="w-8 h-8 rounded bg-yellow-900/50 border border-yellow-500 flex items-center justify-center font-bold">1</span>
                      <span className="text-slate-600">ΓåÆ</span>
                      <span className="w-8 h-8 rounded bg-slate-700 border border-slate-600 flex items-center justify-center font-bold text-slate-400">4</span>
                    </div>
                    <div className="text-xs text-slate-400">Same for ties, then SKIP</div>
                  </div>

                  <div className="bg-slate-800 rounded-xl p-4 text-center">
                    <div className="text-sm font-bold text-green-400 mb-2">DENSE_RANK()</div>
                    <div className="flex justify-center gap-2 mb-2">
                      <span className="w-8 h-8 rounded bg-green-900/50 border border-green-500 flex items-center justify-center font-bold">1</span>
                      <span className="w-8 h-8 rounded bg-green-900/50 border border-green-500 flex items-center justify-center font-bold">1</span>
                      <span className="w-8 h-8 rounded bg-green-900/50 border border-green-500 flex items-center justify-center font-bold">1</span>
                      <span className="text-slate-600">ΓåÆ</span>
                      <span className="w-8 h-8 rounded bg-green-900/50 border border-green-500 flex items-center justify-center font-bold">2</span>
                    </div>
                    <div className="text-xs text-slate-400">Same for ties, NO skip</div>
                  </div>
                </div>
              </div>

              {/* Interview Tips */}
              <div className="mt-6 bg-yellow-900/20 border border-yellow-500/30 rounded-xl p-5">
                <h4 className="text-yellow-400 font-bold mb-3">≡ƒÄ» Interview Talking Points</h4>
                <ul className="text-sm text-slate-300 space-y-2">
                  <li>ΓÇó <strong>ROW_NUMBER:</strong> Use when you need exactly one row per group (e.g., "latest order per customer")</li>
                  <li>ΓÇó <strong>RANK vs DENSE_RANK:</strong> RANK for competitions (skip places), DENSE_RANK for pagination (no gaps)</li>
                  <li>ΓÇó <strong>LEAD/LAG:</strong> Perfect for calculating period-over-period changes without self-joins!</li>
                  <li>ΓÇó <strong>PARTITION BY:</strong> Resets the window function for each group. Like GROUP BY but keeps all rows.</li>
                  <li>ΓÇó <strong>VPI Context:</strong> Use ROW_NUMBER() PARTITION BY part_id ORDER BY date DESC to get latest status per part!</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const CaseSimulator = ({ onBack }: { onBack: () => void }) => {
      const [activeTab, setActiveTab] = useState < 'nvl' | 'coalesce' | 'arithmetic' | 'aggregate' > ('nvl');

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      const tabs = [
        { id: 'nvl', label: 'NVL / IFNULL', icon: '≡ƒöº' },
        { id: 'coalesce', label: 'COALESCE', icon: '≡ƒÄ»' },
        { id: 'arithmetic', label: 'Arithmetic Trap', icon: '≡ƒªá' },
        { id: 'aggregate', label: 'Aggregate Scanner', icon: '≡ƒôè' },
      ];

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-2xl">
                ≡ƒæ╗
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">
                  NULL Handling Simulator
                </h1>
                <p className="text-xs text-slate-500">NVL ΓÇó COALESCE ΓÇó NULL Traps ΓÇó Aggregates</p>
              </div>
            </div>
          </header>

          {/* Tab Navigation */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-3">
            <div className="flex gap-2 justify-center">
              {tabs.map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2 ${activeTab === tab.id
                      ? 'bg-pink-600 text-white shadow-lg shadow-pink-500/30'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                >
                  <span>{tab.icon}</span>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 overflow-y-auto p-6">
            <div className="max-w-5xl mx-auto">
              {activeTab === 'nvl' && <NVLDemo />}
              {activeTab === 'coalesce' && <CoalesceDemo />}
              {activeTab === 'arithmetic' && <ArithmeticTrapDemo />}
              {activeTab === 'aggregate' && <AggregateTrapDemo />}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // NVL Demo - The Repair Machine (Conveyor Belt)
    // ============================================
    const NVLDemo = () => {
      const [inputValue, setInputValue] = useState < number | null > (50);
      const [defaultValue, setDefaultValue] = useState(0);
      const [isAnimating, setIsAnimating] = useState(false);
      const [boxPosition, setBoxPosition] = useState(0); // 0-100%
      const [showResult, setShowResult] = useState(false);
      const [isTransformed, setIsTransformed] = useState(false);

      const runAnimation = () => {
        setIsAnimating(true);
        setShowResult(false);
        setIsTransformed(false);
        setBoxPosition(0);

        // Animate box moving from left to right
        let pos = 0;
        const interval = setInterval(() => {
          pos += 2;
          setBoxPosition(pos);

          // At 50%, hit the NVL gate
          if (pos === 50 && inputValue === null) {
            setIsTransformed(true);
          }

          if (pos >= 100) {
            clearInterval(interval);
            setShowResult(true);
            setIsAnimating(false);
          }
        }, 30);
      };

      const result = inputValue ?? defaultValue;
      const isNull = inputValue === null;

      return (
        <div>
          {/* Concept */}
          <div className="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 border border-blue-500/30 rounded-xl p-5 mb-6">
            <h3 className="text-lg font-bold text-white mb-2">≡ƒöº NVL - The Repair Machine</h3>
            <p className="text-sm text-slate-300">
              NVL acts like a repair station on a conveyor belt. If a <strong className="text-red-400">Ghost (NULL)</strong> comes through,
              it stamps a default value on it. If a <strong className="text-blue-400">real value</strong> comes through, it does nothing.
            </p>
          </div>

          {/* Controls */}
          <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
            <div className="flex items-center justify-center gap-8 mb-6">
              {/* Input Value Control */}
              <div className="text-center">
                <div className="text-xs text-slate-500 uppercase font-bold mb-2">Incoming Value</div>
                <div className="flex gap-2">
                  <input
                    type="number"
                    value={isNull ? '' : inputValue}
                    onChange={(e) => setInputValue(e.target.value ? parseInt(e.target.value) : null)}
                    placeholder="Enter number"
                    className="w-24 px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-center font-mono text-blue-400"
                    disabled={isAnimating}
                  />
                  <button
                    onClick={() => setInputValue(null)}
                    disabled={isAnimating}
                    className={`px-4 py-2 rounded-lg font-bold transition ${isNull ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-red-900/50'
                      }`}
                  >
                    ≡ƒæ╗ NULL
                  </button>
                </div>
              </div>

              {/* Default Value Control */}
              <div className="text-center">
                <div className="text-xs text-slate-500 uppercase font-bold mb-2">Default Value</div>
                <input
                  type="number"
                  value={defaultValue}
                  onChange={(e) => setDefaultValue(parseInt(e.target.value) || 0)}
                  className="w-24 px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-center font-mono text-green-400"
                  disabled={isAnimating}
                />
              </div>

              {/* Run Button */}
              <button
                onClick={runAnimation}
                disabled={isAnimating}
                className={`px-6 py-3 rounded-lg font-bold transition ${isAnimating ? 'bg-yellow-600 animate-pulse' : 'bg-green-600 hover:bg-green-500'
                  } text-white`}
              >
                {isAnimating ? 'ΓÜÖ∩╕Å Processing...' : 'Γû╢ Send Through NVL'}
              </button>
            </div>

            {/* Conveyor Belt Visualization */}
            <div className="relative bg-slate-800 rounded-xl p-8">
              {/* Conveyor Belt Track */}
              <div className="relative h-24">
                {/* Belt */}
                <div className="absolute top-1/2 left-0 right-0 h-2 bg-slate-600 -translate-y-1/2 rounded-full">
                  {/* Belt pattern */}
                  <div className="absolute inset-0 flex items-center justify-around">
                    {[...Array(20)].map((_, i) => (
                      <div key={i} className="w-1 h-full bg-slate-700" />
                    ))}
                  </div>
                </div>

                {/* NVL Gate */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
                  <div className={`w-20 h-20 rounded-xl border-4 flex flex-col items-center justify-center transition-all ${isAnimating && boxPosition >= 45 && boxPosition <= 55 && isNull
                      ? 'bg-green-600 border-green-400 scale-110 shadow-lg shadow-green-500/50'
                      : 'bg-slate-700 border-slate-500'
                    }`}>
                    <span className="text-xl">≡ƒöº</span>
                    <span className="text-[10px] font-bold text-slate-300">NVL</span>
                    <span className="text-[8px] text-slate-500">default: {defaultValue}</span>
                  </div>
                  {/* Stamp animation */}
                  {isAnimating && boxPosition >= 48 && boxPosition <= 52 && isNull && (
                    <div className="absolute -top-8 left-1/2 -translate-x-1/2 text-2xl animate-bounce">
                      ≡ƒö¿
                    </div>
                  )}
                </div>

                {/* Moving Box */}
                {(isAnimating || showResult) && (
                  <div
                    className={`absolute top-1/2 -translate-y-1/2 w-16 h-16 rounded-xl flex items-center justify-center font-bold text-lg transition-all z-10 ${(isNull && !isTransformed)
                        ? 'border-2 border-dashed border-red-500 bg-red-900/30 text-red-400'
                        : 'border-2 border-solid border-blue-500 bg-blue-900/50 text-blue-400'
                      }`}
                    style={{
                      left: `calc(${boxPosition}% - 32px)`,
                      transition: isAnimating ? 'none' : 'left 0.3s ease-out'
                    }}
                  >
                    {isNull && !isTransformed ? '≡ƒæ╗' : (isTransformed ? defaultValue : inputValue)}
                    {isTransformed && (
                      <span className="absolute -top-2 -right-2 text-xs bg-green-600 rounded-full px-1">Γ£ô</span>
                    )}
                  </div>
                )}

                {/* Start Label */}
                <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 text-xs text-slate-500">
                  IN
                </div>

                {/* End Label */}
                <div className="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 text-xs text-slate-500">
                  OUT
                </div>
              </div>

              {/* Result */}
              {showResult && (
                <div className="mt-6 text-center animate-slide">
                  <div className="inline-flex items-center gap-4 bg-slate-900 rounded-xl px-6 py-4 border border-slate-600">
                    <span className="text-slate-400">NVL(</span>
                    <span className={isNull ? 'text-red-400' : 'text-blue-400'}>
                      {isNull ? 'NULL' : inputValue}
                    </span>
                    <span className="text-slate-400">,</span>
                    <span className="text-green-400">{defaultValue}</span>
                    <span className="text-slate-400">) =</span>
                    <span className="text-2xl font-bold text-cyan-400">{result}</span>
                  </div>
                </div>
              )}
            </div>

            {/* Key Takeaway */}
            <div className="mt-4 p-4 bg-yellow-900/20 border border-yellow-500/30 rounded-xl text-center">
              <span className="text-yellow-400 font-bold">≡ƒÆí Key Takeaway:</span>
              <span className="text-slate-300 ml-2">NVL only acts when it sees a Ghost (NULL). Otherwise, it sleeps.</span>
            </div>
          </div>

          {/* SQL Reference */}
          <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
            <div className="text-xs font-bold text-slate-500 uppercase mb-2">SQL Syntax</div>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-950 rounded-lg p-4">
                <div className="text-xs text-cyan-400 mb-2">Snowflake / Oracle</div>
                <pre className="text-sm text-slate-300 font-mono">NVL(column, 0)</pre>
              </div>
              <div className="bg-slate-950 rounded-lg p-4">
                <div className="text-xs text-cyan-400 mb-2">SQL Server / MySQL</div>
                <pre className="text-sm text-slate-300 font-mono">ISNULL(column, 0)  -- SQL Server
                  IFNULL(column, 0)  -- MySQL</pre>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // COALESCE Demo - The Layered Filter (Trapdoors)
    // ============================================
    const CoalesceDemo = () => {
      const [columns, setColumns] = useState([
        { id: 1, value: null as number | null, label: 'Col 1' },
        { id: 2, value: 200, label: 'Col 2' },
        { id: 3, value: 300, label: 'Col 3' },
      ]);
      const [isAnimating, setIsAnimating] = useState(false);
      const [ballPosition, setBallPosition] = useState(-1); // -1 = top, 0-2 = at layer, 3 = bottom
      const [stoppedAt, setStoppedAt] = useState < number | null > (null);
      const [showResult, setShowResult] = useState(false);

      const toggleColumn = (idx: number) => {
        if (isAnimating) return;
        setColumns(prev => prev.map((col, i) =>
          i === idx ? { ...col, value: col.value === null ? (idx + 1) * 100 : null } : col
        ));
        setShowResult(false);
        setStoppedAt(null);
      };

      const runAnimation = () => {
        setIsAnimating(true);
        setShowResult(false);
        setStoppedAt(null);
        setBallPosition(-1);

        let pos = -1;
        const checkNext = () => {
          pos++;
          setBallPosition(pos);

          if (pos <= 2) {
            // Check if this layer has a value
            setTimeout(() => {
              if (columns[pos].value !== null) {
                // Stop here!
                setStoppedAt(pos);
                setShowResult(true);
                setIsAnimating(false);
              } else {
                // Fall through (trapdoor opens)
                setTimeout(checkNext, 600);
              }
            }, 400);
          } else {
            // Fell through all layers - NULL bucket
            setStoppedAt(null);
            setShowResult(true);
            setIsAnimating(false);
          }
        };

        setTimeout(checkNext, 300);
      };

      const result = columns.find(c => c.value !== null)?.value ?? null;

      return (
        <div>
          {/* Concept */}
          <div className="bg-gradient-to-r from-purple-900/30 to-pink-900/30 border border-purple-500/30 rounded-xl p-5 mb-6">
            <h3 className="text-lg font-bold text-white mb-2">≡ƒÄ» COALESCE - The Layered Filter</h3>
            <p className="text-sm text-slate-300">
              Imagine a ball dropping through layers. Each layer is a column. If the column is <strong className="text-red-400">NULL</strong>,
              the trapdoor opens and the ball falls through. If it's a <strong className="text-green-400">value</strong>,
              the trapdoor is closed and the ball stops there.
            </p>
          </div>

          {/* Controls */}
          <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
            <div className="flex items-center justify-center gap-6 mb-6">
              <div className="text-sm text-slate-400">Toggle each column:</div>
              {columns.map((col, idx) => (
                <button
                  key={col.id}
                  onClick={() => toggleColumn(idx)}
                  disabled={isAnimating}
                  className={`px-6 py-3 rounded-xl font-bold text-lg transition-all ${col.value !== null
                      ? 'bg-green-600 text-white border-2 border-green-400'
                      : 'bg-red-900/50 text-red-400 border-2 border-dashed border-red-500'
                    }`}
                >
                  {col.value !== null ? col.value : '≡ƒæ╗ NULL'}
                  <div className="text-xs opacity-70">{col.label}</div>
                </button>
              ))}
              <button
                onClick={runAnimation}
                disabled={isAnimating}
                className={`px-6 py-3 rounded-lg font-bold transition ${isAnimating ? 'bg-yellow-600 animate-pulse' : 'bg-cyan-600 hover:bg-cyan-500'
                  } text-white`}
              >
                {isAnimating ? 'ΓÅ│ Dropping...' : '≡ƒÄ▒ Drop Ball'}
              </button>
            </div>

            {/* Vertical Drop Visualization */}
            <div className="flex justify-center">
              <div className="relative w-80">
                {/* Drop Zone */}
                <div className="flex flex-col items-center">
                  {/* Start Position */}
                  <div className="w-16 h-8 flex items-center justify-center text-slate-500 text-xs">
                    COALESCE(
                  </div>

                  {/* Ball */}
                  <div
                    className={`absolute w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white font-bold shadow-lg z-20 transition-all duration-500`}
                    style={{
                      top: ballPosition === -1 ? '20px' :
                        ballPosition === 0 ? '80px' :
                          ballPosition === 1 ? '180px' :
                            ballPosition === 2 ? '280px' : '380px',
                      opacity: isAnimating || showResult ? 1 : 0,
                      transform: stoppedAt !== null && ballPosition === stoppedAt ? 'scale(1.1)' : 'scale(1)'
                    }}
                  >
                    ≡ƒÄ▒
                  </div>

                  {/* Layers */}
                  {columns.map((col, idx) => {
                    const isTrapdoorOpen = ballPosition > idx || (isAnimating && ballPosition === idx && col.value === null);
                    const isCurrent = ballPosition === idx;
                    const isStopPoint = stoppedAt === idx;

                    return (
                      <div key={col.id} className="relative my-4">
                        {/* Layer Platform */}
                        <div className={`relative w-48 h-16 rounded-xl border-2 flex items-center justify-center transition-all ${isStopPoint
                            ? 'bg-green-900/50 border-green-500 shadow-lg shadow-green-500/30'
                            : col.value !== null
                              ? 'bg-slate-700 border-slate-500'
                              : 'bg-red-900/30 border-red-500/50'
                          }`}>
                          {/* Trapdoor Animation */}
                          <div className={`absolute inset-2 flex transition-all duration-300 ${isTrapdoorOpen ? 'gap-16' : 'gap-0'
                            }`}>
                            <div className={`flex-1 h-full rounded bg-slate-600 transition-all duration-300 ${isTrapdoorOpen ? 'rotate-[-30deg] origin-left' : ''
                              }`} />
                            <div className={`flex-1 h-full rounded bg-slate-600 transition-all duration-300 ${isTrapdoorOpen ? 'rotate-[30deg] origin-right' : ''
                              }`} />
                          </div>

                          {/* Value Label */}
                          <span className={`relative z-10 font-bold text-lg ${col.value !== null ? 'text-green-400' : 'text-red-400'
                            }`}>
                            {col.value !== null ? col.value : '≡ƒæ╗'}
                          </span>

                          {/* Layer Label */}
                          <span className="absolute -left-16 text-xs text-slate-500">{col.label}</span>

                          {/* Check/X Indicator */}
                          {isCurrent && !isAnimating && showResult && (
                            <span className={`absolute -right-8 text-xl ${col.value !== null ? 'text-green-400' : 'text-red-400'
                              }`}>
                              {col.value !== null ? 'Γ£ô' : 'Γåô'}
                            </span>
                          )}
                        </div>
                      </div>
                    );
                  })}

                  {/* NULL Bucket */}
                  <div className={`w-48 h-16 mt-4 rounded-xl border-2 flex items-center justify-center transition-all ${stoppedAt === null && showResult
                      ? 'bg-red-900/50 border-red-500 shadow-lg shadow-red-500/30'
                      : 'bg-slate-800 border-slate-600 border-dashed'
                    }`}>
                    <span className="text-red-400 font-bold">NULL Bucket ≡ƒ¬ú</span>
                  </div>

                  {/* End */}
                  <div className="w-16 h-8 flex items-center justify-center text-slate-500 text-xs mt-2">
                    )
                  </div>
                </div>
              </div>
            </div>

            {/* Result */}
            {showResult && (
              <div className="mt-6 text-center animate-slide">
                <div className="inline-flex items-center gap-4 bg-slate-800 rounded-xl px-6 py-4 border border-slate-600">
                  <span className="text-slate-400">COALESCE(</span>
                  {columns.map((col, idx) => (
                    <span key={col.id}>
                      <span className={col.value !== null ? 'text-green-400' : 'text-red-400'}>
                        {col.value !== null ? col.value : 'NULL'}
                      </span>
                      {idx < columns.length - 1 && <span className="text-slate-400">, </span>}
                    </span>
                  ))}
                  <span className="text-slate-400">) =</span>
                  <span className={`text-2xl font-bold ${result !== null ? 'text-cyan-400' : 'text-red-400'}`}>
                    {result !== null ? result : 'NULL'}
                  </span>
                </div>
                <div className="text-sm text-slate-500 mt-2">
                  {result !== null
                    ? `Γ£ô Stopped at ${columns.find(c => c.value !== null)?.label} (first non-NULL)`
                    : 'Γ£ù Fell through all layers - no value found!'}
                </div>
              </div>
            )}
          </div>

          {/* Real World Example */}
          <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
            <div className="text-xs font-bold text-slate-500 uppercase mb-2">Real-World Example</div>
            <pre className="bg-slate-950 rounded-lg p-4 text-sm text-slate-300 font-mono overflow-x-auto">{`-- Get best available contact info
SELECT 
    customer_name,
    COALESCE(mobile_phone, home_phone, work_phone, 'No Phone') AS contact_phone,
    COALESCE(email, 'no-email@unknown.com') AS contact_email
      </div>
    </div>
  );
};

// ============================================
// Arithmetic Trap Demo - The Virus
// ============================================
const ArithmeticTrapDemo = () => {
  const [isNull, setIsNull] = useState(false);
  const [showVirus, setShowVirus] = useState(false);

  const toggleValue = (makeNull: boolean) => {
    setIsNull(makeNull);
    if (makeNull) {
      setShowVirus(true);
      setTimeout(() => setShowVirus(false), 2000);
    }
  };

  return (
    <div>
      {/* Warning Box */}
      <div className="bg-gradient-to-r from-red-900/30 to-orange-900/30 border border-red-500/30 rounded-xl p-5 mb-6">
        <h3 className="text-lg font-bold text-white mb-2">≡ƒªá The Arithmetic Virus</h3>
        <p className="text-sm text-slate-300">
          NULL is like a virus in arithmetic. <strong className="text-red-400">Any operation with NULL infects the entire result!</strong>
          NULL + 10 = NULL, NULL ├ù 5 = NULL, NULL / 2 = NULL.
        </p>
      </div>

      {/* Interactive Calculator */}
      <div className="bg-slate-900 rounded-xl border border-slate-700 p-8 mb-6">
        <div className="text-center mb-8">
          <div className="text-xs text-slate-500 uppercase font-bold mb-4">Choose Your Input</div>
          <div className="flex justify-center gap-4">
            <button
              onClick={() => toggleValue(false)}
              className={`px-8 py-4 rounded-xl font-bold text-xl transition-all ${
                !isNull
                  ? 'bg-blue-600 text-white ring-4 ring-blue-400 scale-110'
                  : 'bg-slate-700 text-slate-400 hover:bg-slate-600'
              }`}
            >
              5
            </button>
            <button
              onClick={() => toggleValue(true)}
              className={`px-8 py-4 rounded-xl font-bold text-xl transition-all ${isNull
                  ? 'bg-red-600 text-white ring-4 ring-red-400 scale-110'
                  : 'bg-slate-700 text-slate-400 hover:bg-slate-600'
                }`}
            >
              ≡ƒæ╗ NULL
            </button>
          </div>
        </div>

        {/* Big Equation */ }
      <div className="flex items-center justify-center gap-6 py-8">
        {/* Input */}
        <div className={`w-24 h-24 rounded-2xl flex items-center justify-center font-bold text-3xl transition-all ${isNull
            ? 'bg-red-900/50 border-2 border-dashed border-red-500 text-red-400'
            : 'bg-blue-900/50 border-2 border-blue-500 text-blue-400'
          }`}>
          {isNull ? '≡ƒæ╗' : '5'}
        </div>

        {/* Plus */}
        <div className="text-4xl text-yellow-400 font-bold relative">
          +
          {/* Virus eating the plus */}
          {showVirus && (
            <span className="absolute -top-4 -right-4 text-2xl animate-bounce">
              ≡ƒªá
            </span>
          )}
        </div>

        {/* Constant */}
        <div className={`w-24 h-24 rounded-2xl flex items-center justify-center font-bold text-3xl transition-all ${isNull && showVirus
            ? 'bg-red-900/50 border-2 border-dashed border-red-500 text-red-400 animate-pulse'
            : 'bg-green-900/50 border-2 border-green-500 text-green-400'
          }`}>
          {isNull && showVirus ? '≡ƒªá' : '10'}
        </div>

        {/* Equals */}
        <div className="text-4xl text-slate-400 font-bold">=</div>

        {/* Result */}
        <div className={`w-24 h-24 rounded-2xl flex items-center justify-center font-bold text-3xl transition-all ${isNull
            ? 'bg-red-900/50 border-2 border-red-500 text-red-400 shadow-lg shadow-red-500/30'
            : 'bg-cyan-900/50 border-2 border-cyan-500 text-cyan-400 shadow-lg shadow-cyan-500/30'
          }`}>
          {isNull ? '≡ƒæ╗' : '15'}
        </div>
      </div>

      {/* Explanation */ }
      <div className={`text-center p-4 rounded-xl transition-all ${isNull ? 'bg-red-900/20 border border-red-500/30' : 'bg-green-900/20 border border-green-500/30'
        }`}>
        {isNull ? (
          <div>
            <div className="text-red-400 font-bold text-xl mb-2">≡ƒªá INFECTED!</div>
            <div className="text-slate-300">NULL + 10 = NULL (The virus spreads to everything!)</div>
          </div>
        ) : (
          <div>
            <div className="text-green-400 font-bold text-xl mb-2">Γ£ô HEALTHY</div>
            <div className="text-slate-300">5 + 10 = 15 (Normal arithmetic)</div>
          </div>
        )}
      </div>
      </div >

      {/* The Cure */ }
      < div className = "bg-slate-900 rounded-xl border border-slate-700 p-5" >
        <div className="text-xs font-bold text-green-400 uppercase mb-2">≡ƒÆè The Cure: Handle NULL First!</div>
        <pre className="bg-slate-950 rounded-lg p-4 text-sm text-slate-300 font-mono overflow-x-auto">{`-- BAD: Returns NULL if quantity is NULL
SELECT price * quantity AS total FROM orders;

-- GOOD: Treat NULL quantity as 0
SELECT price * NVL(quantity, 0) AS total FROM orders;`}</pre>
      </div >
    </div >
  );
};

    // ============================================
    // Aggregate Scanner Demo
    // ============================================
    const AggregateTrapDemo = () => {
      const [dataBlocks] = useState([
        { id: 1, value: 10 as number | null },
        { id: 2, value: null },
        { id: 3, value: 20 },
        { id: 4, value: null },
        { id: 5, value: 30 },
      ]);
      const [isScanning, setIsScanning] = useState(false);
      const [scanPosition, setScanPosition] = useState(-1);
      const [countResult, setCountResult] = useState < number | null > (null);
      const [countType, setCountType] = useState < 'star' | 'col' > ('col');
      const [flashState, setFlashState] = useState < 'none' | 'green' | 'red' > ('none');

      const runScan = (type: 'star' | 'col') => {
        setCountType(type);
        setIsScanning(true);
        setCountResult(null);
        setScanPosition(-1);
        setFlashState('none');

        let count = 0;
        let pos = -1;

        const scanNext = () => {
          pos++;
          setScanPosition(pos);

          if (pos < dataBlocks.length) {
            const block = dataBlocks[pos];
            const shouldCount = type === 'star' || block.value !== null;

            setTimeout(() => {
              if (shouldCount) {
                count++;
                setFlashState('green');
              } else {
                setFlashState('red');
              }
              setCountResult(count);

              setTimeout(() => {
                setFlashState('none');
                scanNext();
              }, 400);
            }, 200);
          } else {
            setIsScanning(false);
          }
        };

        setTimeout(scanNext, 300);
      };

      return (
        <div>
          {/* Concept */}
          <div className="bg-gradient-to-r from-orange-900/30 to-yellow-900/30 border border-orange-500/30 rounded-xl p-5 mb-6">
            <h3 className="text-lg font-bold text-white mb-2">≡ƒôè The Aggregate Scanner</h3>
            <p className="text-sm text-slate-300">
              <strong className="text-yellow-400">COUNT(*)</strong> counts ALL rows including NULLs.
              <strong className="text-cyan-400"> COUNT(column)</strong> only counts non-NULL values!
            </p>
          </div>

          {/* Scanner Visualization */}
          <div className="bg-slate-900 rounded-xl border border-slate-700 p-6 mb-6">
            {/* Controls */}
            <div className="flex justify-center gap-4 mb-8">
              <button
                onClick={() => runScan('star')}
                disabled={isScanning}
                className={`px-6 py-3 rounded-lg font-bold transition ${isScanning && countType === 'star' ? 'bg-yellow-600 animate-pulse' : 'bg-yellow-600 hover:bg-yellow-500'
                  } text-white`}
              >
                Run COUNT(*)
              </button>
              <button
                onClick={() => runScan('col')}
                disabled={isScanning}
                className={`px-6 py-3 rounded-lg font-bold transition ${isScanning && countType === 'col' ? 'bg-cyan-600 animate-pulse' : 'bg-cyan-600 hover:bg-cyan-500'
                  } text-white`}
              >
                Run COUNT(column)
              </button>
            </div>

            {/* Data Blocks */}
            <div className="flex justify-center gap-4 mb-8">
              {dataBlocks.map((block, idx) => {
                const isCurrentScan = scanPosition === idx;
                const isScanned = scanPosition > idx;

                return (
                  <div
                    key={block.id}
                    className={`relative w-20 h-20 rounded-xl flex items-center justify-center font-bold text-xl transition-all ${isCurrentScan
                        ? flashState === 'green'
                          ? 'bg-green-600 border-2 border-green-400 scale-110 shadow-lg shadow-green-500/50'
                          : flashState === 'red'
                            ? 'bg-red-600 border-2 border-red-400 scale-110 shadow-lg shadow-red-500/50 animate-shake'
                            : 'bg-yellow-600 border-2 border-yellow-400 scale-110'
                        : block.value === null
                          ? 'bg-red-900/30 border-2 border-dashed border-red-500 text-red-400'
                          : 'bg-blue-900/50 border-2 border-blue-500 text-blue-400'
                      } ${isScanned && block.value === null && countType === 'col' ? 'opacity-30' : ''}`}
                  >
                    {block.value === null ? '≡ƒæ╗' : block.value}

                    {/* Count indicator */}
                    {isCurrentScan && flashState === 'green' && (
                      <span className="absolute -top-3 -right-3 w-6 h-6 bg-green-500 rounded-full text-white text-xs flex items-center justify-center">
                        +1
                      </span>
                    )}
                    {isCurrentScan && flashState === 'red' && (
                      <span className="absolute -top-3 -right-3 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">
                        Γ£ù
                      </span>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Scanner Line */}
            {isScanning && (
              <div className="relative h-2 bg-slate-700 rounded-full mb-6 overflow-hidden">
                <div
                  className="absolute h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-300 rounded-full"
                  style={{ width: `${((scanPosition + 1) / dataBlocks.length) * 100}%` }}
                />
              </div>
            )}

            {/* Result Counter */}
            <div className="flex justify-center">
              <div className={`inline-flex items-center gap-4 px-8 py-4 rounded-xl border-2 ${countResult !== null
                  ? countType === 'star'
                    ? 'bg-yellow-900/30 border-yellow-500'
                    : 'bg-cyan-900/30 border-cyan-500'
                  : 'bg-slate-800 border-slate-600'
                }`}>
                <span className="text-slate-400 font-mono">
                  {countType === 'star' ? 'COUNT(*)' : 'COUNT(column)'} =
                </span>
                <span className={`text-4xl font-bold ${countType === 'star' ? 'text-yellow-400' : 'text-cyan-400'
                  }`}>
                  {countResult ?? '?'}
                </span>
              </div>
            </div>

            {/* Comparison */}
            {countResult !== null && !isScanning && (
              <div className="mt-6 text-center animate-slide">
                <div className="inline-flex items-center gap-8 p-4 bg-slate-800 rounded-xl">
                  <div className="text-center">
                    <div className="text-yellow-400 font-bold text-2xl">5</div>
                    <div className="text-xs text-slate-500">COUNT(*)</div>
                  </div>
                  <div className="text-slate-500">vs</div>
                  <div className="text-center">
                    <div className="text-cyan-400 font-bold text-2xl">3</div>
                    <div className="text-xs text-slate-500">COUNT(col)</div>
                  </div>
                </div>
                <div className="text-sm text-orange-400 mt-3">
                  ΓÜá∩╕Å COUNT(*) includes ghosts, COUNT(column) ignores them!
                </div>
              </div>
            )}
          </div>

          {/* Interview Tips */}
          <div className="bg-pink-900/20 border border-pink-500/30 rounded-xl p-5">
            <h4 className="text-pink-400 font-bold mb-3">≡ƒÄ» Interview Talking Points</h4>
            <ul className="text-sm text-slate-300 space-y-2">
              <li>ΓÇó <strong>COUNT(*)</strong> counts rows. <strong>COUNT(column)</strong> counts non-NULL values.</li>
              <li>ΓÇó <strong>AVG ignores NULLs</strong> in both numerator AND denominator!</li>
              <li>ΓÇó <strong>VPI Context:</strong> If quantity is NULL, SUM won't include it but COUNT(*) still counts the row!</li>
            </ul>
          </div>

          {/* CSS for shake animation */}
          <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0) scale(1.1); }
          25% { transform: translateX(-5px) scale(1.1); }
          75% { transform: translateX(5px) scale(1.1); }
        }
        .animate-shake {
          animation: shake 0.3s ease-in-out;
        }
      `}</style>
        </div>
      );
    };

    const ReconSimulator = ({ onBack }: { onBack: () => void }) => {
      // Source table state
      const [sourceRows, setSourceRows] = useState([
        { id: 1, name: 'BLOCK-ASM', quantity: 100, status: 'Active' },
        { id: 2, name: 'PISTON-SET', quantity: 250, status: 'Active' },
        { id: 3, name: 'CRANKSHAFT', quantity: 75, status: 'Active' },
      ]);

      // Target table state (initially synced)
      const [targetRows, setTargetRows] = useState([
        { id: 1, name: 'BLOCK-ASM', quantity: 100, status: 'Active' },
        { id: 2, name: 'PISTON-SET', quantity: 250, status: 'Active' },
        { id: 3, name: 'CRANKSHAFT', quantity: 75, status: 'Active' },
      ]);

      // Stream state (CDC log)
      const [streamData, setStreamData] = useState < Array < {
        rowId: number;
        action: 'INSERT' | 'DELETE';
        isUpdate: boolean;
        data: { id: number; name: string; quantity: number; status: string };
        timestamp: string;
      } >> ([]);

      const [nextId, setNextId] = useState(4);
      const [isMerging, setIsMerging] = useState(false);
      const [mergeStep, setMergeStep] = useState(-1);
      const [showSuccess, setShowSuccess] = useState(false);

      // Generate timestamp
      const getTimestamp = () => new Date().toLocaleTimeString();

      // INSERT operation
      const insertRow = () => {
        const newRow = {
          id: nextId,
          name: `PART-${String(nextId).padStart(3, '0')}`,
          quantity: Math.floor(Math.random() * 200) + 50,
          status: 'Active'
        };

        setSourceRows(prev => [...prev, newRow]);
        setStreamData(prev => [...prev, {
          rowId: nextId,
          action: 'INSERT',
          isUpdate: false,
          data: newRow,
          timestamp: getTimestamp()
        }]);
        setNextId(prev => prev + 1);
        setShowSuccess(false);
      };

      // UPDATE operation (uses DELETE + INSERT pattern in streams)
      const updateRow = () => {
        if (sourceRows.length === 0) return;

        const randomIndex = Math.floor(Math.random() * sourceRows.length);
        const oldRow = sourceRows[randomIndex];
        const newRow = {
          ...oldRow,
          quantity: oldRow.quantity + Math.floor(Math.random() * 50) + 10
        };

        setSourceRows(prev => prev.map((r, i) => i === randomIndex ? newRow : r));

        // Stream captures UPDATE as DELETE + INSERT with isUpdate flag
        setStreamData(prev => [
          ...prev,
          {
            rowId: oldRow.id,
            action: 'DELETE',
            isUpdate: true,
            data: oldRow,
            timestamp: getTimestamp()
          },
          {
            rowId: newRow.id,
            action: 'INSERT',
            isUpdate: true,
            data: newRow,
            timestamp: getTimestamp()
          }
        ]);
        setShowSuccess(false);
      };

      // DELETE operation
      const deleteRow = () => {
        if (sourceRows.length === 0) return;

        const randomIndex = Math.floor(Math.random() * sourceRows.length);
        const deletedRow = sourceRows[randomIndex];

        setSourceRows(prev => prev.filter((_, i) => i !== randomIndex));
        setStreamData(prev => [...prev, {
          rowId: deletedRow.id,
          action: 'DELETE',
          isUpdate: false,
          data: deletedRow,
          timestamp: getTimestamp()
        }]);
        setShowSuccess(false);
      };

      // MERGE Task - Process stream and update target
      const runMergeTask = () => {
        if (streamData.length === 0) return;

        setIsMerging(true);
        setMergeStep(0);
        setShowSuccess(false);

        // Animate through each stream record
        streamData.forEach((record, idx) => {
          setTimeout(() => {
            setMergeStep(idx);

            // Apply change to target
            setTimeout(() => {
              setTargetRows(prev => {
                let newTarget = [...prev];

                if (record.action === 'INSERT') {
                  // Check if exists (for update case)
                  const existingIdx = newTarget.findIndex(r => r.id === record.data.id);
                  if (existingIdx >= 0) {
                    newTarget[existingIdx] = record.data;
                  } else {
                    newTarget.push(record.data);
                  }
                } else if (record.action === 'DELETE' && !record.isUpdate) {
                  // Only delete if not part of update
                  newTarget = newTarget.filter(r => r.id !== record.data.id);
                }

                return newTarget;
              });
            }, 200);

            // Complete after last record
            if (idx === streamData.length - 1) {
              setTimeout(() => {
                setStreamData([]);
                setMergeStep(-1);
                setIsMerging(false);
                setShowSuccess(true);
              }, 600);
            }
          }, idx * 500);
        });
      };

      // Clear stream (reset offset)
      const clearStream = () => {
        setStreamData([]);
        setShowSuccess(false);
      };

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-600 flex items-center justify-center text-2xl">
                ≡ƒîè
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-teal-400 to-cyan-400 bg-clip-text text-transparent">
                  Streams & Tasks: CDC Simulator
                </h1>
                <p className="text-xs text-slate-500">Change Data Capture ΓÇó Incremental Loading ΓÇó Delta Processing</p>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <div className="flex-1 overflow-y-auto p-6">
            <div className="max-w-6xl mx-auto">

              {/* Concept */}
              <div className="bg-gradient-to-r from-teal-900/30 to-cyan-900/30 border border-teal-500/30 rounded-xl p-5 mb-6">
                <h3 className="text-lg font-bold text-white mb-2">≡ƒîè Snowflake Streams: Change Data Capture (CDC)</h3>
                <p className="text-sm text-slate-300">
                  <strong>Streams</strong> track changes (INSERT, UPDATE, DELETE) on a table without re-scanning entire table.
                  <strong> Tasks</strong> run on schedule to process only the <em>delta</em> (changed data).
                  This is how you build efficient <strong>incremental pipelines</strong> instead of full reloads!
                </p>
              </div>

              {/* Three-Column Layout */}
              <div className="grid grid-cols-3 gap-6 mb-6">

                {/* SOURCE TABLE */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                  <div className="flex items-center justify-between mb-4">
                    <h4 className="font-bold text-white flex items-center gap-2">
                      <span className="text-xl">≡ƒôÑ</span> Source Table
                    </h4>
                    <span className="text-xs text-slate-500">{sourceRows.length} rows</span>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex gap-2 mb-4">
                    <button
                      onClick={insertRow}
                      disabled={isMerging}
                      className="flex-1 px-3 py-2 bg-green-600 hover:bg-green-500 disabled:opacity-50 rounded-lg text-xs font-bold transition"
                    >
                      Γ₧ò INSERT
                    </button>
                    <button
                      onClick={updateRow}
                      disabled={isMerging || sourceRows.length === 0}
                      className="flex-1 px-3 py-2 bg-yellow-600 hover:bg-yellow-500 disabled:opacity-50 rounded-lg text-xs font-bold transition"
                    >
                      Γ£Å∩╕Å UPDATE
                    </button>
                    <button
                      onClick={deleteRow}
                      disabled={isMerging || sourceRows.length === 0}
                      className="flex-1 px-3 py-2 bg-red-600 hover:bg-red-500 disabled:opacity-50 rounded-lg text-xs font-bold transition"
                    >
                      ≡ƒùæ∩╕Å DELETE
                    </button>
                  </div>

                  {/* Table */}
                  <div className="space-y-1 max-h-[300px] overflow-y-auto">
                    <div className="grid grid-cols-4 gap-1 text-[10px] font-bold text-slate-500 uppercase px-2">
                      <div>ID</div>
                      <div>Name</div>
                      <div>Qty</div>
                      <div>Status</div>
                    </div>
                    {sourceRows.map(row => (
                      <div
                        key={row.id}
                        className="grid grid-cols-4 gap-1 text-xs bg-slate-800 rounded-lg px-2 py-2 border border-slate-700"
                      >
                        <div className="text-cyan-400 font-mono">{row.id}</div>
                        <div className="text-white truncate">{row.name}</div>
                        <div className="text-green-400">{row.quantity}</div>
                        <div className="text-slate-400">{row.status}</div>
                      </div>
                    ))}
                    {sourceRows.length === 0 && (
                      <div className="text-center text-slate-500 py-8">No rows</div>
                    )}
                  </div>
                </div>

                {/* STREAM (CDC Log) */}
                <div className="bg-slate-900 rounded-xl border-2 border-teal-500/50 p-5 relative">
                  {/* Animated flow indicator */}
                  {streamData.length > 0 && !isMerging && (
                    <div className="absolute -left-3 top-1/2 -translate-y-1/2 text-teal-400 text-2xl animate-pulse">
                      ΓåÆ
                    </div>
                  )}
                  {isMerging && (
                    <div className="absolute -right-3 top-1/2 -translate-y-1/2 text-teal-400 text-2xl animate-bounce">
                      ΓåÆ
                    </div>
                  )}

                  <div className="flex items-center justify-between mb-4">
                    <h4 className="font-bold text-teal-400 flex items-center gap-2">
                      <span className="text-xl">≡ƒîè</span> Stream
                    </h4>
                    <span className={`text-xs px-2 py-0.5 rounded ${streamData.length > 0 ? 'bg-teal-600 text-white' : 'bg-slate-700 text-slate-400'
                      }`}>
                      {streamData.length} changes
                    </span>
                  </div>

                  {/* Stream explanation */}
                  <div className="text-[10px] text-slate-500 mb-3 bg-slate-800 rounded p-2">
                    <code>CREATE STREAM src_stream ON TABLE source;</code>
                  </div>

                  {/* Change Log */}
                  <div className="space-y-1 max-h-[250px] overflow-y-auto">
                    {streamData.map((record, idx) => (
                      <div
                        key={idx}
                        className={`text-xs rounded-lg px-3 py-2 border transition-all ${mergeStep === idx
                            ? 'ring-2 ring-yellow-400 scale-105 shadow-lg'
                            : mergeStep > idx
                              ? 'opacity-30'
                              : ''
                          } ${record.action === 'INSERT'
                            ? 'bg-green-900/30 border-green-500/50'
                            : 'bg-red-900/30 border-red-500/50'
                          }`}
                      >
                        <div className="flex justify-between items-center mb-1">
                          <span className={`font-bold ${record.action === 'INSERT' ? 'text-green-400' : 'text-red-400'
                            }`}>
                            {record.action}
                          </span>
                          <span className="text-[10px] text-slate-500">{record.timestamp}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">ID: {record.rowId}</span>
                          {record.isUpdate && (
                            <span className="text-yellow-400 text-[10px] bg-yellow-900/30 px-1 rounded">
                              METADATA$ISUPDATE
                            </span>
                          )}
                        </div>
                        <div className="text-[10px] text-slate-500 truncate">
                          {record.data.name} (qty: {record.data.quantity})
                        </div>
                      </div>
                    ))}
                    {streamData.length === 0 && (
                      <div className="text-center text-slate-500 py-8">
                        <div className="text-2xl mb-2">≡ƒô¡</div>
                        <div>Stream is empty</div>
                        <div className="text-[10px]">(No pending changes)</div>
                      </div>
                    )}
                  </div>

                  {/* Offset indicator */}
                  {streamData.length > 0 && (
                    <div className="mt-3 text-[10px] text-slate-500 flex items-center justify-between">
                      <span>Offset: {streamData.length} records behind</span>
                      <button
                        onClick={clearStream}
                        disabled={isMerging}
                        className="text-red-400 hover:text-red-300"
                      >
                        Reset
                      </button>
                    </div>
                  )}
                </div>

                {/* TARGET TABLE */}
                <div className="bg-slate-900 rounded-xl border border-slate-700 p-5">
                  <div className="flex items-center justify-between mb-4">
                    <h4 className="font-bold text-white flex items-center gap-2">
                      <span className="text-xl">≡ƒôñ</span> Target Table
                    </h4>
                    <span className="text-xs text-slate-500">{targetRows.length} rows</span>
                  </div>

                  {/* Merge Task Button */}
                  <button
                    onClick={runMergeTask}
                    disabled={isMerging || streamData.length === 0}
                    className={`w-full px-4 py-3 rounded-lg font-bold text-sm transition mb-4 ${isMerging
                        ? 'bg-yellow-600 animate-pulse'
                        : streamData.length === 0
                          ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                          : 'bg-teal-600 hover:bg-teal-500 text-white'
                      }`}
                  >
                    {isMerging ? (
                      <span className="flex items-center justify-center gap-2">
                        <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        Processing MERGE...
                      </span>
                    ) : (
                      <>ΓÜí Run MERGE Task</>
                    )}
                  </button>

                  {/* Success Message */}
                  {showSuccess && (
                    <div className="mb-4 p-3 bg-green-900/30 border border-green-500/30 rounded-lg text-center animate-slide">
                      <div className="text-green-400 font-bold">Γ£ô Sync Complete!</div>
                      <div className="text-xs text-slate-400">Stream consumed, offset advanced</div>
                    </div>
                  )}

                  {/* Table */}
                  <div className="space-y-1 max-h-[250px] overflow-y-auto">
                    <div className="grid grid-cols-4 gap-1 text-[10px] font-bold text-slate-500 uppercase px-2">
                      <div>ID</div>
                      <div>Name</div>
                      <div>Qty</div>
                      <div>Status</div>
                    </div>
                    {targetRows.map(row => {
                      const isBeingUpdated = isMerging && streamData[mergeStep]?.data.id === row.id;
                      return (
                        <div
                          key={row.id}
                          className={`grid grid-cols-4 gap-1 text-xs rounded-lg px-2 py-2 border transition-all ${isBeingUpdated
                              ? 'bg-yellow-900/50 border-yellow-500 ring-2 ring-yellow-400'
                              : 'bg-slate-800 border-slate-700'
                            }`}
                        >
                          <div className="text-cyan-400 font-mono">{row.id}</div>
                          <div className="text-white truncate">{row.name}</div>
                          <div className="text-green-400">{row.quantity}</div>
                          <div className="text-slate-400">{row.status}</div>
                        </div>
                      );
                    })}
                    {targetRows.length === 0 && (
                      <div className="text-center text-slate-500 py-8">No rows</div>
                    )}
                  </div>
                </div>
              </div>

              {/* SQL Reference */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5 mb-6">
                <h4 className="font-bold text-white mb-3">≡ƒô¥ SQL Implementation</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-slate-950 rounded-lg p-4">
                    <div className="text-xs text-teal-400 font-bold mb-2">1. Create Stream</div>
                    <pre className="text-xs text-slate-300 font-mono">{`CREATE STREAM inventory_stream
ON TABLE source_inventory
APPEND_ONLY = FALSE;

-- Stream captures:
-- METADATA$ACTION (INSERT/DELETE)
-- METADATA$ISUPDATE (TRUE/FALSE)
-- METADATA$ROW_ID`}</pre>
                  </div>
                  <div className="bg-slate-950 rounded-lg p-4">
                    <div className="text-xs text-teal-400 font-bold mb-2">2. Create Task with MERGE</div>
                    <pre className="text-xs text-slate-300 font-mono">{`CREATE TASK sync_inventory
  WAREHOUSE = ETL_WH
  SCHEDULE = '5 MINUTE'
  WHEN SYSTEM$STREAM_HAS_DATA('inventory_stream')
AS
MERGE INTO target t USING inventory_stream s
  ON t.id = s.id
  WHEN MATCHED AND METADATA$ACTION = 'DELETE'
    THEN DELETE
  WHEN MATCHED THEN UPDATE SET ...
  WHEN NOT MATCHED THEN INSERT ...;`}</pre>
                  </div>
                </div>
              </div>

              {/* Flow Diagram */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-5 mb-6">
                <h4 className="font-bold text-white mb-4">≡ƒöä CDC Flow Diagram</h4>
                <div className="flex items-center justify-center gap-4">
                  <div className="text-center">
                    <div className="w-20 h-20 rounded-xl bg-blue-900/50 border-2 border-blue-500 flex items-center justify-center text-3xl mb-2">
                      ≡ƒôÑ
                    </div>
                    <div className="text-xs text-slate-400">Source</div>
                    <div className="text-xs text-blue-400">DML Operations</div>
                  </div>

                  <div className="text-2xl text-slate-600">ΓåÆ</div>

                  <div className="text-center">
                    <div className="w-20 h-20 rounded-xl bg-teal-900/50 border-2 border-teal-500 flex items-center justify-center text-3xl mb-2 relative">
                      ≡ƒîè
                      <span className="absolute -top-2 -right-2 w-6 h-6 bg-teal-600 rounded-full text-xs flex items-center justify-center">
                        ╬ö
                      </span>
                    </div>
                    <div className="text-xs text-slate-400">Stream</div>
                    <div className="text-xs text-teal-400">Captures Delta</div>
                  </div>

                  <div className="text-2xl text-slate-600">ΓåÆ</div>

                  <div className="text-center">
                    <div className="w-20 h-20 rounded-xl bg-yellow-900/50 border-2 border-yellow-500 flex items-center justify-center text-3xl mb-2">
                      ΓÜÖ∩╕Å
                    </div>
                    <div className="text-xs text-slate-400">Task</div>
                    <div className="text-xs text-yellow-400">MERGE Logic</div>
                  </div>

                  <div className="text-2xl text-slate-600">ΓåÆ</div>

                  <div className="text-center">
                    <div className="w-20 h-20 rounded-xl bg-green-900/50 border-2 border-green-500 flex items-center justify-center text-3xl mb-2">
                      ≡ƒôñ
                    </div>
                    <div className="text-xs text-slate-400">Target</div>
                    <div className="text-xs text-green-400">Synced Data</div>
                  </div>
                </div>
              </div>

              {/* Interview Tips */}
              <div className="bg-teal-900/20 border border-teal-500/30 rounded-xl p-5">
                <h4 className="text-teal-400 font-bold mb-3">≡ƒÄ» Interview Talking Points</h4>
                <div className="grid grid-cols-2 gap-4 text-sm text-slate-300">
                  <div>
                    <strong className="text-white">Streams vs Full Reload:</strong> Streams track only changes (delta),
                    avoiding expensive full table scans. Critical for large tables!
                  </div>
                  <div>
                    <strong className="text-white">UPDATE = DELETE + INSERT:</strong> Streams capture updates as two
                    records with METADATA$ISUPDATE = TRUE. Use this for SCD Type 2!
                  </div>
                  <div>
                    <strong className="text-white">SYSTEM$STREAM_HAS_DATA():</strong> Task only runs when stream has
                    pending changes - no wasted compute!
                  </div>
                  <div>
                    <strong className="text-white">Your VPI Context:</strong> Perfect for syncing Oracle EBS changes
                    to Snowflake incrementally instead of daily full loads!
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================================
    // COST SIMULATOR: Comprehensive FinOps Dashboard (ENHANCED)
    // ============================================================================
    const CostSimulator = ({ onBack }: { onBack: () => void }) => {
      const [activeTab, setActiveTab] = useState < 'snowflake' | 'matillion' | 'powerbi' > ('snowflake');

      useEffect(() => {
        const handleKey = (e: KeyboardEvent) => {
          if (e.key === 'Escape') onBack();
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, []);

      const tabs = [
        { id: 'snowflake', label: 'Snowflake Compute', icon: 'Γ¥ä∩╕Å', desc: 'WH vs Serverless' },
        { id: 'matillion', label: 'Matillion ETL', icon: '≡ƒƒá', desc: 'Self-Hosted vs SaaS' },
        { id: 'powerbi', label: 'Power BI Modes', icon: '≡ƒôè', desc: 'Import vs DirectQuery' },
      ];

      return (
        <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 overflow-hidden">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition text-slate-400 hover:text-white">
                ΓåÉ Back
              </button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center text-2xl">
                ≡ƒÆ░
              </div>
              <div>
                <h1 className="text-xl font-bold bg-gradient-to-r from-emerald-400 to-green-400 bg-clip-text text-transparent">
                  FinOps & Cloud Cost Simulator
                </h1>
                <p className="text-xs text-slate-500">Cost-Optimized Architecture ΓÇó Interview Ready</p>
              </div>
            </div>
          </header>

          {/* Tab Navigation */}
          <div className="bg-slate-900/50 border-b border-slate-800 px-6 py-3">
            <div className="flex gap-2 justify-center">
              {tabs.map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`px-5 py-3 rounded-xl text-sm font-semibold transition flex flex-col items-center gap-1 ${activeTab === tab.id
                      ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/30'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                    }`}
                >
                  <span className="text-xl">{tab.icon}</span>
                  <span>{tab.label}</span>
                  <span className="text-[10px] opacity-70">{tab.desc}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 overflow-y-auto p-6">
            <div className="max-w-6xl mx-auto">
              {activeTab === 'snowflake' && <SnowflakeComputeTab />}
              {activeTab === 'matillion' && <MatillionCostTab />}
              {activeTab === 'powerbi' && <PowerBICostTab />}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Tab 1: Snowflake Compute Scenarios
    // ============================================
    const SnowflakeComputeTab = () => {
      const [scenario, setScenario] = useState < 'adhoc' | 'sp' | 'snowpipe' | 'tasks' > ('adhoc');
      const [isRunning, setIsRunning] = useState(false);
      const [isIdle, setIsIdle] = useState(false);
      const [cost, setCost] = useState(0);
      const [elapsedTime, setElapsedTime] = useState(0);
      const [warehouseSize, setWarehouseSize] = useState(2);
      const [autoSuspend, setAutoSuspend] = useState(60);

      const scenarios = [
        { id: 'adhoc', name: 'Ad-hoc Query', icon: '≡ƒöì', compute: 'User-Managed WH', billing: 'Min 60s, then per-second', risk: 'Idle Time Cost' },
        { id: 'sp', name: 'Stored Procedure', icon: 'ΓÜÖ∩╕Å', compute: 'Caller\'s WH', billing: 'WH locked during SP', risk: 'Long-running loops' },
        { id: 'snowpipe', name: 'Snowpipe', icon: '≡ƒÜ┐', compute: 'Serverless (1.25x)', billing: 'Per file/size', risk: 'None - No idle cost!' },
        { id: 'tasks', name: 'Tasks & Streams', icon: 'ΓÅ░', compute: 'Serverless OR WH', billing: 'Per execution', risk: 'Depends on mode' },
      ];

      const currentScenario = scenarios.find(s => s.id === scenario)!;
      const isServerless = scenario === 'snowpipe' || scenario === 'tasks';
      const effectiveRate = isServerless ? warehouseSize * 1.25 : warehouseSize;

      useEffect(() => {
        let interval: NodeJS.Timeout;
        if (isRunning || isIdle) {
          interval = setInterval(() => {
            if (!isServerless || isRunning) {
              setCost(prev => prev + effectiveRate / 3600);
            }
            if (isIdle) {
              setElapsedTime(prev => {
                if (prev <= 1) {
                  setIsIdle(false);
                  return 0;
                }
                return prev - 1;
              });
            } else if (isRunning) {
              setElapsedTime(prev => prev + 1);
            }
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [isRunning, isIdle, effectiveRate, isServerless]);

      const runQuery = () => {
        setIsRunning(true);
        setCost(0);
        setElapsedTime(0);

        const duration = scenario === 'sp' ? 8 : scenario === 'snowpipe' ? 2 : 5;

        setTimeout(() => {
          setIsRunning(false);
          if (!isServerless) {
            setIsIdle(true);
            setElapsedTime(autoSuspend);
          }
        }, duration * 1000);
      };

      const reset = () => {
        setCost(0);
        setElapsedTime(0);
        setIsRunning(false);
        setIsIdle(false);
      };

      return (
        <div>
          {/* Scenario Selector */}
          <div className="grid grid-cols-4 gap-3 mb-6">
            {scenarios.map(s => (
              <button
                key={s.id}
                onClick={() => { setScenario(s.id as any); reset(); }}
                className={`p-4 rounded-xl border-2 transition-all text-left ${scenario === s.id
                    ? 'border-cyan-500 bg-cyan-900/20 shadow-lg shadow-cyan-500/20'
                    : 'border-slate-700 bg-slate-900 hover:border-slate-600'
                  }`}
              >
                <div className="text-2xl mb-2">{s.icon}</div>
                <div className="font-bold text-white text-sm">{s.name}</div>
                <div className="text-[10px] text-slate-500 mt-1">{s.compute}</div>
              </button>
            ))}
          </div>

          <div className="grid grid-cols-2 gap-6">
            {/* Left: Simulation */}
            <div className="bg-slate-900 rounded-xl border border-slate-700 p-6">
              <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                {currentScenario.icon} {currentScenario.name} Simulation
              </h3>

              {/* Warehouse Control (for non-serverless) */}
              {!isServerless && (
                <div className="mb-4 p-4 bg-slate-800 rounded-lg">
                  <div className="flex justify-between text-xs text-slate-400 mb-2">
                    <span>Warehouse Size</span>
                    <span className="text-cyan-400">${warehouseSize}/hr</span>
                  </div>
                  <input
                    type="range" min="2" max="256" step="2"
                    value={warehouseSize}
                    onChange={(e) => setWarehouseSize(Number(e.target.value))}
                    className="w-full"
                    disabled={isRunning || isIdle}
                  />
                  <div className="flex justify-between text-xs text-slate-400 mt-2">
                    <span>Auto-Suspend: {autoSuspend}s</span>
                    <input
                      type="number"
                      value={autoSuspend}
                      onChange={(e) => setAutoSuspend(Number(e.target.value))}
                      className="w-16 bg-slate-700 rounded px-2 text-right"
                      disabled={isRunning || isIdle}
                    />
                  </div>
                </div>
              )}

              {/* Serverless Badge */}
              {isServerless && (
                <div className="mb-4 p-4 bg-cyan-900/20 border border-cyan-500/30 rounded-lg">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ΓÜí</span>
                    <div>
                      <div className="text-cyan-400 font-bold">Serverless Compute</div>
                      <div className="text-xs text-slate-400">1.25x rate, but ZERO idle cost!</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Status Display */}
              <div className={`p-6 rounded-xl text-center border-2 mb-4 transition-all ${isRunning ? 'border-green-500 bg-green-900/20 shadow-lg shadow-green-500/20' :
                  isIdle ? 'border-red-500 bg-red-900/20 animate-pulse' :
                    'border-slate-700 bg-slate-800'
                }`}>
                <div className="text-5xl mb-2">
                  {isRunning ? 'ΓÜí' : isIdle ? '≡ƒÆ╕' : '≡ƒÆñ'}
                </div>
                <div className={`text-xl font-bold ${isRunning ? 'text-green-400' : isIdle ? 'text-red-400' : 'text-slate-400'
                  }`}>
                  {isRunning ? 'PROCESSING' : isIdle ? '≡ƒö┤ IDLE BILLING (WASTE!)' : 'SUSPENDED ($0)'}
                </div>
                <div className="text-sm font-mono mt-2 text-slate-400">
                  {isIdle ? `Auto-suspend in: ${elapsedTime}s` : isRunning ? `Running: ${elapsedTime}s` : 'Ready'}
                </div>
              </div>

              {/* Cost Display */}
              <div className="p-4 bg-slate-800 rounded-lg mb-4 text-center">
                <div className="text-xs text-slate-500 uppercase">Total Cost</div>
                <div className={`text-4xl font-bold font-mono ${cost > 1 ? 'text-red-400' : 'text-emerald-400'}`}>
                  ${cost.toFixed(4)}
                </div>
                <div className="text-xs text-slate-500 mt-1">
                  Rate: ${effectiveRate.toFixed(2)}/hr {isServerless && '(Serverless 1.25x)'}
                </div>
              </div>

              {/* Controls */}
              <div className="flex gap-2">
                <button
                  onClick={runQuery}
                  disabled={isRunning || isIdle}
                  className={`flex-1 py-3 rounded-lg font-bold text-white transition ${isRunning || isIdle ? 'bg-slate-700 opacity-50' : 'bg-emerald-600 hover:bg-emerald-500'
                    }`}
                >
                  {isRunning ? 'ΓÜÖ∩╕Å Running...' : isIdle ? '≡ƒÆ╕ Billing...' : `Γû╢ Run ${currentScenario.name}`}
                </button>
                <button onClick={reset} className="px-4 bg-slate-700 hover:bg-slate-600 rounded-lg text-white">Γå║</button>
              </div>
            </div>

            {/* Right: Scenario Details */}
            <div className="space-y-4">
              {/* Scenario Info Card */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-6">
                <h4 className="text-white font-bold mb-4">≡ƒôï {currentScenario.name} Details</h4>
                <div className="space-y-3 text-sm">
                  <div className="flex justify-between">
                    <span className="text-slate-400">Compute:</span>
                    <span className={`font-bold ${isServerless ? 'text-cyan-400' : 'text-orange-400'}`}>
                      {currentScenario.compute}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Billing:</span>
                    <span className="text-white">{currentScenario.billing}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Risk:</span>
                    <span className={isServerless ? 'text-green-400' : 'text-red-400'}>
                      {currentScenario.risk}
                    </span>
                  </div>
                </div>
              </div>

              {/* Scenario-specific tips */}
              {scenario === 'adhoc' && (
                <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-xl p-4">
                  <h4 className="text-yellow-400 font-bold mb-2">ΓÜá∩╕Å Ad-hoc Query Risk</h4>
                  <p className="text-xs text-slate-300">
                    Warehouse stays ON after query finishes until Auto-Suspend kicks in.
                    <strong className="text-yellow-400"> Set Auto-Suspend to 60s</strong> for ad-hoc warehouses!
                  </p>
                </div>
              )}

              {scenario === 'sp' && (
                <div className="bg-orange-900/20 border border-orange-500/30 rounded-xl p-4">
                  <h4 className="text-orange-400 font-bold mb-2">ΓÜÖ∩╕Å SP Cost Trap</h4>
                  <p className="text-xs text-slate-300">
                    SP locks the Warehouse - it can't suspend during execution!
                    <strong className="text-orange-400"> CALLER'S RIGHTS vs OWNER'S RIGHTS</strong> determines whose quota is charged.
                  </p>
                </div>
              )}

              {scenario === 'snowpipe' && (
                <div className="bg-green-900/20 border border-green-500/30 rounded-xl p-4">
                  <h4 className="text-green-400 font-bold mb-2">Γ£à Snowpipe Advantage</h4>
                  <p className="text-xs text-slate-300">
                    <strong>No Warehouse needed!</strong> Snowflake manages compute.
                    1.25x rate but <strong className="text-green-400">ZERO idle cost</strong> - file loaded = billing stops!
                  </p>
                </div>
              )}

              {scenario === 'tasks' && (
                <div className="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4">
                  <h4 className="text-purple-400 font-bold mb-2">ΓÅ░ Tasks: Choose Wisely</h4>
                  <p className="text-xs text-slate-300">
                    <strong>Serverless Tasks:</strong> Best for simple SQL, fast scale up/down.<br />
                    <strong>User-Managed WH:</strong> For heavy transformations where you need control.
                  </p>
                </div>
              )}

              {/* Interview Answer */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 className="text-blue-400 font-bold mb-2">≡ƒÄ» Interview Answer</h4>
                <p className="text-xs text-slate-300 italic">
                  {scenario === 'adhoc' && '"For ad-hoc queries, I set Auto-Suspend to 60s to prevent zombie billing. Minimum billing is 60 seconds, then per-second."'}
                  {scenario === 'sp' && '"For SPs, I consider CALLER vs OWNER rights - it determines whose credit quota is charged. Complex loops can lock the warehouse."'}
                  {scenario === 'snowpipe' && '"Snowpipe is serverless - 1.25x rate but zero idle cost. Perfect for continuous/streaming data loads."'}
                  {scenario === 'tasks' && '"For small batch jobs I use Serverless Tasks. For heavy transformations, User-Managed WH gives me control."'}
                </p>
              </div>
            </div>
          </div>

          {/* Verdict Card */}
          <div className="mt-6 p-5 bg-gradient-to-r from-emerald-900/30 to-cyan-900/30 border border-emerald-500/30 rounded-xl">
            <h4 className="text-emerald-400 font-bold mb-2">≡ƒôî One-Line Verdict (Interview Ready)</h4>
            <p className="text-sm text-slate-300">
              "For <strong className="text-cyan-400">continuous/small batch data</strong> ΓåÆ Snowpipe/Serverless Task (no idle cost).
              For <strong className="text-orange-400">heavy transformation/complex logic</strong> ΓåÆ Standard Warehouse/SP (more control)."
            </p>
          </div>
        </div>
      );
    };

    // ============================================
    // Tab 2: Matillion Self-Hosted vs SaaS (DPC)
    // ============================================
    const MatillionCostTab = () => {
      const [mode, setMode] = useState < 'self-hosted' | 'saas' > ('self-hosted');
      const [isRunning, setIsRunning] = useState(false);
      const [cost, setCost] = useState(0);
      const [hours, setHours] = useState(0);
      const [showNightWarning, setShowNightWarning] = useState(false);
      const [instanceForgotten, setInstanceForgotten] = useState(false);

      const selfHostedRate = 0.50; // EC2 cost
      const matillionLicense = 0.30; // License per hour
      const saasRate = 2.00; // DPC per pipeline minute

      // Self-hosted always ticks (EC2 always on)
      useEffect(() => {
        let interval: NodeJS.Timeout;
        if (mode === 'self-hosted') {
          interval = setInterval(() => {
            setCost(prev => prev + (selfHostedRate + matillionLicense) / 3600);
            setHours(prev => {
              const newHours = prev + 1 / 3600;
              if (newHours >= 8 && !showNightWarning) {
                setShowNightWarning(true);
                setInstanceForgotten(true);
              }
              return newHours;
            });
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [mode, showNightWarning]);

      // SaaS only when running
      useEffect(() => {
        let interval: NodeJS.Timeout;
        if (mode === 'saas' && isRunning) {
          interval = setInterval(() => {
            setCost(prev => prev + saasRate / 3600);
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [mode, isRunning]);

      const runPipeline = () => {
        setIsRunning(true);
        setTimeout(() => setIsRunning(false), 5000);
      };

      const reset = () => {
        setCost(0);
        setHours(0);
        setShowNightWarning(false);
        setInstanceForgotten(false);
        setIsRunning(false);
      };

      return (
        <div>
          {/* Mode Selector */}
          <div className="grid grid-cols-2 gap-4 mb-6">
            <button
              onClick={() => { setMode('self-hosted'); reset(); }}
              className={`p-6 rounded-xl border-2 transition-all text-left ${mode === 'self-hosted'
                  ? 'border-orange-500 bg-orange-900/20 shadow-lg shadow-orange-500/20'
                  : 'border-slate-700 bg-slate-900 hover:border-slate-600'
                }`}
            >
              <div className="flex items-center gap-3 mb-3">
                <span className="text-3xl">≡ƒûÑ∩╕Å</span>
                <div>
                  <div className="font-bold text-white">Self-Hosted (EC2)</div>
                  <div className="text-xs text-slate-500">Matillion ETL on your VM</div>
                </div>
              </div>
              <div className="text-xs text-slate-400 space-y-1">
                <div>ΓÇó EC2: ${selfHostedRate}/hr (always on)</div>
                <div>ΓÇó License: ${matillionLicense}/hr</div>
                <div className="text-red-400">ΓÇó Risk: Forgot to stop = $$$</div>
              </div>
            </button>

            <button
              onClick={() => { setMode('saas'); reset(); }}
              className={`p-6 rounded-xl border-2 transition-all text-left ${mode === 'saas'
                  ? 'border-cyan-500 bg-cyan-900/20 shadow-lg shadow-cyan-500/20'
                  : 'border-slate-700 bg-slate-900 hover:border-slate-600'
                }`}
            >
              <div className="flex items-center gap-3 mb-3">
                <span className="text-3xl">Γÿü∩╕Å</span>
                <div>
                  <div className="font-bold text-white">SaaS (DPC)</div>
                  <div className="text-xs text-slate-500">Data Productivity Cloud</div>
                </div>
              </div>
              <div className="text-xs text-slate-400 space-y-1">
                <div>ΓÇó Pay-per-use: ${saasRate}/hr (only when running)</div>
                <div className="text-green-400">ΓÇó Idle = $0 (True Cloud Native!)</div>
                <div>ΓÇó No infrastructure management</div>
              </div>
            </button>
          </div>

          <div className="grid grid-cols-2 gap-6">
            {/* Left: Visualization */}
            <div className="bg-slate-900 rounded-xl border border-slate-700 p-6">
              <h3 className="text-lg font-bold text-white mb-4">
                {mode === 'self-hosted' ? '≡ƒûÑ∩╕Å EC2 Instance' : 'Γÿü∩╕Å SaaS Platform'}
              </h3>

              {/* Server Visual */}
              <div className={`relative h-48 rounded-xl border-2 flex items-center justify-center mb-4 transition-all ${mode === 'self-hosted'
                  ? 'border-orange-500 bg-orange-900/20'
                  : isRunning
                    ? 'border-cyan-500 bg-cyan-900/20'
                    : 'border-slate-600 bg-slate-800'
                }`}>
                <div className="text-center">
                  <div className="text-6xl mb-2">{mode === 'self-hosted' ? '≡ƒûÑ∩╕Å' : 'Γÿü∩╕Å'}</div>
                  <div className={`font-bold ${mode === 'self-hosted' ? 'text-orange-400' :
                      isRunning ? 'text-cyan-400' : 'text-slate-500'
                    }`}>
                    {mode === 'self-hosted' ? 'ALWAYS ON' : isRunning ? 'PROCESSING' : 'SLEEPING'}
                  </div>
                </div>

                {/* Status Light */}
                <div className={`absolute top-4 right-4 w-4 h-4 rounded-full ${mode === 'self-hosted' ? 'bg-green-500 animate-pulse' :
                    isRunning ? 'bg-cyan-500 animate-pulse' : 'bg-slate-600'
                  }`} />

                {/* Money Drain */}
                {(mode === 'self-hosted' || isRunning) && (
                  <div className="absolute bottom-4 right-4 text-red-400 animate-pulse text-sm">
                    ≡ƒÆ╕ ${((mode === 'self-hosted' ? selfHostedRate + matillionLicense : saasRate) / 3600).toFixed(4)}/s
                  </div>
                )}
              </div>

              {/* Cost Display */}
              <div className="p-4 bg-slate-800 rounded-lg mb-4 text-center">
                <div className="text-xs text-slate-500 uppercase">Total Cost</div>
                <div className={`text-4xl font-bold font-mono ${cost > 2 ? 'text-red-400' : 'text-emerald-400'}`}>
                  ${cost.toFixed(4)}
                </div>
                <div className="text-xs text-slate-500 mt-1">
                  {mode === 'self-hosted' ? `Running: ${(hours * 60).toFixed(0)} minutes` : isRunning ? 'Pipeline active' : 'Idle = $0'}
                </div>
              </div>

              {/* SaaS Run Button */}
              {mode === 'saas' && (
                <button
                  onClick={runPipeline}
                  disabled={isRunning}
                  className={`w-full py-3 rounded-lg font-bold text-white transition ${isRunning ? 'bg-cyan-600 animate-pulse' : 'bg-cyan-600 hover:bg-cyan-500'
                    }`}
                >
                  {isRunning ? 'ΓÜÖ∩╕Å Pipeline Running...' : 'Γû╢ Run Pipeline (5s job)'}
                </button>
              )}
            </div>

            {/* Right: Details & Warnings */}
            <div className="space-y-4">
              {/* Night Warning */}
              {mode === 'self-hosted' && showNightWarning && (
                <div className="p-4 bg-red-900/30 border-2 border-red-500 rounded-xl animate-pulse">
                  <div className="flex items-center gap-3">
                    <span className="text-4xl">≡ƒÿ▒</span>
                    <div>
                      <div className="text-red-400 font-bold text-lg">Forgot to shut down!</div>
                      <div className="text-sm text-slate-300">
                        8+ hours idle = <span className="text-red-400 font-bold">${(8 * (selfHostedRate + matillionLicense)).toFixed(2)}</span> wasted!
                      </div>
                      <div className="text-xs text-slate-400 mt-1">
                        Monthly waste: ${(30 * 12 * (selfHostedRate + matillionLicense)).toFixed(0)} (12hr nights ├ù 30 days)
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Comparison Table */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-4">
                <h4 className="text-white font-bold mb-3">≡ƒôè Cost Comparison (Monthly)</h4>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between p-2 rounded bg-orange-900/20">
                    <span className="text-orange-400">Self-Hosted (24/7)</span>
                    <span className="font-bold text-orange-400">${((selfHostedRate + matillionLicense) * 24 * 30).toFixed(0)}/mo</span>
                  </div>
                  <div className="flex justify-between p-2 rounded bg-yellow-900/20">
                    <span className="text-yellow-400">Self-Hosted (12hr/day)</span>
                    <span className="font-bold text-yellow-400">${((selfHostedRate + matillionLicense) * 12 * 30).toFixed(0)}/mo</span>
                  </div>
                  <div className="flex justify-between p-2 rounded bg-green-900/20">
                    <span className="text-green-400">SaaS (4hr jobs/day)</span>
                    <span className="font-bold text-green-400">${(saasRate * 4 * 30).toFixed(0)}/mo</span>
                  </div>
                </div>
              </div>

              {/* Interview Answer */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 className="text-blue-400 font-bold mb-2">≡ƒÄ» Interview Answer</h4>
                <p className="text-xs text-slate-300 italic">
                  "Legacy systems used Self-hosted where we had to schedule Instance on/off.
                  Modern architecture prefers <strong className="text-cyan-400">SaaS (DPC)</strong> because it's
                  <strong className="text-green-400"> consumption-based billing</strong> - True Cloud Native with zero idle cost."
                </p>
              </div>

              {/* Key Insight */}
              <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4">
                <h4 className="text-emerald-400 font-bold mb-2">≡ƒÆí When to Use What?</h4>
                <div className="text-xs text-slate-300 space-y-1">
                  <div><strong className="text-orange-400">Self-Hosted:</strong> Heavy ETL, 8+ hrs/day, need full control</div>
                  <div><strong className="text-cyan-400">SaaS (DPC):</strong> Sporadic jobs, &lt;4 hrs/day, FinOps priority</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Tab 3: Power BI Import vs DirectQuery
    // ============================================
    const PowerBICostTab = () => {
      const [mode, setMode] = useState < 'import' | 'directquery' | 'composite' > ('import');
      const [userClicks, setUserClicks] = useState(0);
      const [snowflakeCost, setSnowflakeCost] = useState(0);
      const [showLaserBeam, setShowLaserBeam] = useState(false);
      const [warehouseActive, setWarehouseActive] = useState(false);
      const [refreshCount, setRefreshCount] = useState(0);

      const warehouseRate = 4; // $/hr
      const queryDuration = 2; // seconds per query

      const simulateUserClicks = (count: number) => {
        setUserClicks(prev => prev + count);

        if (mode === 'directquery' || mode === 'composite') {
          setShowLaserBeam(true);
          setWarehouseActive(true);

          // Each click = a query to Snowflake
          const queryCost = (warehouseRate / 3600) * queryDuration * count;
          setSnowflakeCost(prev => prev + queryCost);

          setTimeout(() => setShowLaserBeam(false), 1000);
          setTimeout(() => setWarehouseActive(false), 3000);
        }
        // Import mode: clicks are FREE (VertiPaq handles it)
      };

      const runRefresh = () => {
        setRefreshCount(prev => prev + 1);
        const refreshCost = (warehouseRate / 3600) * 30; // 30 seconds to refresh
        setSnowflakeCost(prev => prev + refreshCost);
        setWarehouseActive(true);
        setTimeout(() => setWarehouseActive(false), 2000);
      };

      const reset = () => {
        setUserClicks(0);
        setSnowflakeCost(0);
        setRefreshCount(0);
        setWarehouseActive(false);
      };

      const modes = [
        { id: 'import', name: 'Import Mode', icon: '≡ƒôÑ', engine: 'VertiPaq (PBI)', sfCost: 'Refresh only' },
        { id: 'directquery', name: 'DirectQuery', icon: 'ΓÜí', engine: 'Snowflake WH', sfCost: 'Every click!' },
        { id: 'composite', name: 'Composite', icon: '≡ƒöÇ', engine: 'Both', sfCost: 'DQ tables only' },
      ];

      const currentMode = modes.find(m => m.id === mode)!;

      return (
        <div>
          {/* Mode Selector */}
          <div className="grid grid-cols-3 gap-4 mb-6">
            {modes.map(m => (
              <button
                key={m.id}
                onClick={() => { setMode(m.id as any); reset(); }}
                className={`p-4 rounded-xl border-2 transition-all text-center ${mode === m.id
                    ? m.id === 'import' ? 'border-green-500 bg-green-900/20' :
                      m.id === 'directquery' ? 'border-red-500 bg-red-900/20' :
                        'border-purple-500 bg-purple-900/20'
                    : 'border-slate-700 bg-slate-900 hover:border-slate-600'
                  }`}
              >
                <div className="text-3xl mb-2">{m.icon}</div>
                <div className="font-bold text-white">{m.name}</div>
                <div className="text-xs text-slate-400 mt-1">Engine: {m.engine}</div>
                <div className={`text-xs mt-1 ${m.id === 'import' ? 'text-green-400' : 'text-red-400'}`}>
                  SF Cost: {m.sfCost}
                </div>
              </button>
            ))}
          </div>

          <div className="grid grid-cols-2 gap-6">
            {/* Left: Architecture Visual */}
            <div className="bg-slate-900 rounded-xl border border-slate-700 p-6">
              <h3 className="text-lg font-bold text-white mb-4">≡ƒÅù∩╕Å Architecture Flow</h3>

              <div className="relative h-64 bg-slate-950 rounded-xl border border-slate-800 p-4">
                {/* User */}
                <div className="absolute left-4 top-1/2 -translate-y-1/2 text-center">
                  <div className="text-4xl mb-1">≡ƒæñ</div>
                  <div className="text-xs text-slate-500">Users</div>
                  <div className="text-xs text-cyan-400 font-bold">{userClicks} clicks</div>
                </div>

                {/* Laser Beam */}
                {showLaserBeam && (
                  <div className="absolute left-24 right-24 top-1/2 h-2 bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 animate-pulse rounded shadow-lg shadow-red-500/50" />
                )}

                {/* Power BI VertiPaq */}
                <div className={`absolute left-1/3 top-1/2 -translate-y-1/2 -translate-x-1/2 p-4 rounded-xl border-2 transition-all ${mode === 'import' || mode === 'composite'
                    ? 'border-green-500 bg-green-900/30 shadow-lg shadow-green-500/20'
                    : 'border-slate-600 bg-slate-800 opacity-50'
                  }`}>
                  <div className="text-3xl text-center">≡ƒôè</div>
                  <div className="text-xs font-bold text-green-400 mt-1">VertiPaq</div>
                  <div className="text-[10px] text-slate-400">In-Memory</div>
                  {(mode === 'import' || mode === 'composite') && (
                    <div className="text-[10px] text-green-400 mt-1">Γ£ô FREE queries</div>
                  )}
                </div>

                {/* Arrow */}
                <div className="absolute left-1/2 top-1/2 -translate-y-1/2 text-2xl text-slate-600">
                  {mode === 'directquery' ? 'ΓÜíΓåÆ' : mode === 'composite' ? 'Γçä' : 'ΓåÆ'}
                </div>

                {/* Snowflake */}
                <div className={`absolute right-8 top-1/2 -translate-y-1/2 p-4 rounded-xl border-2 transition-all ${warehouseActive
                    ? 'border-red-500 bg-red-900/30 scale-110 shadow-lg shadow-red-500/30'
                    : mode === 'directquery' || mode === 'composite'
                      ? 'border-cyan-500 bg-cyan-900/30'
                      : 'border-slate-600 bg-slate-800 opacity-50'
                  }`}>
                  <div className="text-3xl text-center">Γ¥ä∩╕Å</div>
                  <div className={`text-xs font-bold mt-1 ${warehouseActive ? 'text-red-400' : 'text-cyan-400'}`}>
                    {warehouseActive ? '≡ƒöÑ ACTIVE' : 'Warehouse'}
                  </div>
                  <div className="text-[10px] text-slate-400">${warehouseRate}/hr</div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="grid grid-cols-2 gap-3 mt-4">
                <button
                  onClick={() => simulateUserClicks(50)}
                  className={`py-3 rounded-lg font-bold text-white transition ${mode === 'import' ? 'bg-green-600 hover:bg-green-500' : 'bg-orange-600 hover:bg-orange-500'
                    }`}
                >
                  ≡ƒû▒∩╕Å 50 User Clicks
                </button>
                {(mode === 'import' || mode === 'composite') && (
                  <button
                    onClick={runRefresh}
                    className="py-3 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white"
                  >
                    ≡ƒöä Refresh Data
                  </button>
                )}
              </div>
            </div>

            {/* Right: Cost Analysis */}
            <div className="space-y-4">
              {/* Cost Display */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-4">
                <h4 className="text-white font-bold mb-3">≡ƒÆ░ Snowflake Cost</h4>
                <div className={`text-4xl font-bold font-mono text-center p-4 rounded-lg ${snowflakeCost > 0.5 ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'
                  }`}>
                  ${snowflakeCost.toFixed(4)}
                </div>
                <div className="text-xs text-slate-500 text-center mt-2">
                  {userClicks} clicks ΓÇó {refreshCount} refreshes
                </div>
              </div>

              {/* Mode Explanation */}
              <div className={`rounded-xl border p-4 ${mode === 'import' ? 'bg-green-900/20 border-green-500/30' :
                  mode === 'directquery' ? 'bg-red-900/20 border-red-500/30' :
                    'bg-purple-900/20 border-purple-500/30'
                }`}>
                <h4 className={`font-bold mb-2 ${mode === 'import' ? 'text-green-400' :
                    mode === 'directquery' ? 'text-red-400' : 'text-purple-400'
                  }`}>
                  {currentMode.icon} {currentMode.name} Explained
                </h4>
                <div className="text-xs text-slate-300">
                  {mode === 'import' && (
                    <>
                      <p className="mb-2">Data is <strong>copied into Power BI's VertiPaq</strong> (in-memory compression).</p>
                      <p className="text-green-400">Γ£à User clicks = FREE (local processing)</p>
                      <p className="text-yellow-400">ΓÜá∩╕Å Snowflake cost only during scheduled refresh</p>
                    </>
                  )}
                  {mode === 'directquery' && (
                    <>
                      <p className="mb-2">Data stays in Snowflake. <strong>Every click = SQL query sent</strong>.</p>
                      <p className="text-red-400">Γ¥î 100 users ├ù 10 clicks = 1000 queries to Snowflake!</p>
                      <p className="text-red-400">Γ¥î Warehouse wakes up constantly</p>
                    </>
                  )}
                  {mode === 'composite' && (
                    <>
                      <p className="mb-2"><strong>Hybrid:</strong> Some tables Import, some DirectQuery.</p>
                      <p className="text-green-400">Γ£à Aggregates in Import = fast & free</p>
                      <p className="text-yellow-400">ΓÜá∩╕Å Detail drill-through via DirectQuery</p>
                    </>
                  )}
                </div>
              </div>

              {/* Interview Answer */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 className="text-blue-400 font-bold mb-2">≡ƒÄ» Interview Answer</h4>
                <p className="text-xs text-slate-300 italic">
                  "Power BI has its own powerful <strong className="text-green-400">VertiPaq Engine</strong>.
                  To save cost, we prefer <strong className="text-green-400">Import Mode</strong>.
                  But for <strong className="text-cyan-400">TB+ data or real-time needs</strong>,
                  we use DirectQuery which increases Snowflake cost significantly."
                </p>
              </div>

              {/* Cost Comparison */}
              <div className="bg-slate-900 rounded-xl border border-slate-700 p-4">
                <h4 className="text-white font-bold mb-2">≡ƒôè Daily Cost Estimate (100 users)</h4>
                <div className="space-y-2 text-xs">
                  <div className="flex justify-between p-2 rounded bg-green-900/20">
                    <span className="text-green-400">Import (2 refreshes/day)</span>
                    <span className="font-bold text-green-400">~$0.50</span>
                  </div>
                  <div className="flex justify-between p-2 rounded bg-red-900/20">
                    <span className="text-red-400">DirectQuery (avg usage)</span>
                    <span className="font-bold text-red-400">~$50-200</span>
                  </div>
                  <div className="flex justify-between p-2 rounded bg-purple-900/20">
                    <span className="text-purple-400">Composite (balanced)</span>
                    <span className="font-bold text-purple-400">~$5-20</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>